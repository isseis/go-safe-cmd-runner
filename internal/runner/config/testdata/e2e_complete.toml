# E2E Complete Test Configuration
# Tests all aspects of Global/Group/Command level environment variables
# with allowlist inheritance and complex variable references

[global]
env_allowed = ["HOME", "USER", "PATH"]
env_import = ["home=HOME", "user=USER", "path=PATH"]
env_vars = [
    "BASE_DIR=%{base_dir}",
    "LOG_LEVEL=info",
    "PATH=/opt/tools/bin:%{path}"
]
verify_files = ["%{base_dir}/verify.sh"]

[global.vars]
base_dir = "/opt/app"

[[groups]]
name = "database"
env_vars = [
    "DB_HOST=%{db_host}",
    "DB_PORT=%{db_port}",
    "DB_DATA=%{db_data}"
]
verify_files = ["%{db_data}/schema.sql"]

[groups.vars]
db_host = "localhost"
db_port = "5432"
db_data = "%{base_dir}/db-data"

[[groups.commands]]
name = "migrate"
cmd = "%{base_dir}/bin/migrate"
args = ["-h", "%{db_host}", "-p", "%{db_port}"]
env_vars = ["MIGRATION_DIR=%{migration_dir}"]

[groups.commands.vars]
migration_dir = "%{db_data}/migrations"

[[groups]]
name = "web"
env_allowed = ["PORT"]  # Override: only PORT allowed
# Note: When from_env is specified, global from_env is merged
# So global vars (home, user, path) are inherited and can be referenced
env_import = ["port=PORT"]
env_vars = ["WEB_DIR=%{web_dir}"]

[groups.vars]
web_dir = "/opt/app/web"

[[groups.commands]]
name = "start"
cmd = "%{web_dir}/server"
args = ["--port", "%{port}"]
