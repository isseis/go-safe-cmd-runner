# 要件定義書: ファイル改竄検出機能の実装

## 1. プロジェクト概要

### 1.1 背景
現在のgo-safe-cmd-runnerでは、ファイルの改竄検出機能が実装されていないため、以下の問題が存在する：

1. 設定ファイルの改竄を検出できない。
2. go-safe-cmd-runner が呼び出す実行ファイルや、その実行ファイルが参照するファイルの改竄を検出できない。

### 1.2 目的
- 設定ファイルの改竄を検出する
- go-safe-cmd-runner が呼び出す実行ファイルや、その実行ファイルが参照するファイルの改竄を検出する

## 2. 機能要件

### 2.1 現在の状態（Phase 1）
- [ ] config/loader.go に設定ファイル改竄検出機能の未実装状態を警告するログ出力を追加
- [ ] README.md のセキュリティセクションに改竄検出機能の制限事項を記載
- [ ] 起動時に「設定ファイル改竄検出機能は未実装です」の警告表示
- [ ] --verify-config オプション（未実装）の存在をヘルプに記載
- [ ] go-safe-cmd-runner が呼び出す実行ファイルや、その実行ファイルが参照するファイルの改竄検出機能の未実装状態をドキュメントに明記

### 2.2 設定ファイル改ざん検出機能の実装（Phase 2）
- [ ] ビルド時に指定したディレクトリ（rootユーザーのみ書き込み可能）から設定ファイルのハッシュ値を読み込む
- [ ] 起動時に設定ファイルのハッシュ値を比較する
- [ ] 起動時に設定ファイルのハッシュ値が一致しない場合は、go-safe-cmd-runnerを終了する
- [ ] 起動時に設定ファイルのハッシュ値が一致する場合は、go-safe-cmd-runnerを起動する
- [ ] ハッシュファイル自体が改竄された場合の検出と対応
- [ ] ハッシュファイルの権限チェック（root以外書き込み不可の確認）
- [ ] 適切なエラーメッセージとログ出力の実装

### 2.3 将来の拡張（Phase 3）
- [ ] go-safe-cmd-runner が呼び出す実行ファイルや、その実行ファイルが参照するファイルの改竄検出機能の実装
    - [ ] 詳細は後日策定する。

## 3. 非機能要件

### 3.1 セキュリティ
- 設定ファイルのハッシュ値が存在しない場合には、go-safe-cmd-runnerを終了する
- 設定ファイルが root ユーザー以外で書き換え可能である場合は、go-safe-cmd-runnerを終了する
    - ファイルそのものが書き換え不可であっても、途中ディレクトリやシンボリックリンクなどが書き換え可能である場合もエラーとする。

### 3.2 保守性
- 冗長性の除去によるコードの簡素化
- 一貫性のある設定体系

## 4. 制約事項

### 4.1 技術的制約
- 設定ファイルのハッシュ値を計算・保存するには build/record コマンドを利用する
- 設定ファイルのハッシュ値の検証には filevalidator パッケージを使用する
- ハッシュファイルの保存場所は /etc/go-safe-cmd-runner/hashes/ 等の root のみ書き込み可能なディレクトリとする
    - ディレクトリはバイナリのビルド時に指定できるよう Makefile に記述する
- ハッシュアルゴリズムは SHA-256 を使用する（filevalidatorパッケージの既定値）
- 設定ファイルパスの正規化には filepath.Clean() を使用する

### 4.2 運用制約
- 設定ファイル更新時は必ず事前にハッシュ値の再計算が必要
- ハッシュ値計算は root 権限で実行する必要がある
- 設定ファイルとハッシュファイルのバックアップ・復旧手順が必要

## 5. 成功基準

### 5.1 Phase 1 完了基準
- [ ] 未実装状態の明確な文書化
- [ ] 適切な警告メッセージの表示
- [ ] 既存機能の正常動作確認

### 5.2 Phase 2 完了基準
- [ ] 起動時に設定ファイルのハッシュ値が存在しない場合に、go-safe-cmd-runnerを終了する
- [ ] 起動時に設定ファイルのハッシュ値が一致しない場合に、go-safe-cmd-runnerを終了する
- [ ] 上記機能のテストケースの追加
    - [ ] 正常系: ハッシュ値が一致する場合の起動成功
    - [ ] 異常系: ハッシュファイルが存在しない場合の終了
    - [ ] 異常系: ハッシュ値が一致しない場合の終了
    - [ ] 異常系: ハッシュファイルの権限が不適切な場合の終了
    - [ ] 異常系: 設定ファイルの権限が不適切な場合の終了
    - [ ] エッジケース: 設定ファイルがシンボリックリンクの場合の処理
- [ ] 全テストケースの通過
- [ ] 利用者向けに設定ファイルのハッシュ値に関する解説・運用ドキュメントの作成

### 5.3 Phase 3 完了基準（将来）

## 6. リスク分析

### 6.1 高リスク
- **テストケースの失敗**: 事前の十分な調査により対応
- **後方互換性の損失**: 明確なコミュニケーションとエラーメッセージ、ドキュメント作成により対応

### 6.2 中リスク
- **文書化の不備**: 詳細な解説・運用ドキュメント作成により対応

### 6.3 低リスク
- **パフォーマンス影響**: filevalidator パッケージの使用により検証済み
- **第三者依存**: 外部依存の変更なし

## 7. 依存関係

### 7.1 技術的依存
- filevalidator パッケージ (internal/filevalidator)
- security パッケージ (internal/runner/security)
- build/record コマンド
- SHA-256 ハッシュアルゴリズム

### 7.2 ドキュメント依存
- 既存のアーキテクチャドキュメント

## 8. 承認

本要件定義書は以下のフェーズで段階的に実装される：

1. **Phase 1**: 現状の明確化と警告機能追加
2. **Phase 2**: 設定ファイル改ざん検出機能の実装
3. **Phase 3**: go-safe-cmd-runner が呼び出す実行ファイルや、その実行ファイルが参照するファイルの改竄検出機能の実装（将来）

承認者: [プロジェクト責任者]
承認日: [承認日]
