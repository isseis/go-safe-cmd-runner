# 要件定義書：ファイル改ざん検出（現行実装版）

## 1. 概要 (Overview)

**目的:** このドキュメントは、現在実装されているファイル改ざん検出機能の要件を定義する。

**背景:**
セキュリティリスク軽減のため、コマンドを実行する際にそのコマンド自体ならびにコマンドが参照する設定ファイルが変更されていないかを検出するための Go ライブラリが実装されている。この実装は当初の要件から発展し、より堅牢なセキュリティ機能を含んでいる。

## 2. 目的とスコープ (Goals and Scope)

### 2.1. 目的 (Goals)
現在の実装で達成されている機能：

- 指定されたファイル（コマンド本体や設定ファイル）のハッシュ値を計算し、記録する機能を提供する。
- 記録されたハッシュ値と、ファイル検証時のハッシュ値を比較し、ファイルが改ざんされていないか検証する機能を提供する。
- ハッシュ値は、指定されたディレクトリにファイルごとに保存する。
- 複数のハッシュアルゴリズムに対応できる設計とする。
- セキュリティを重視したファイル操作（TOCTOU攻撃対策、シンボリックリンク対策など）を提供する。
- ハッシュ値の衝突を検出し、適切にエラーハンドリングする。

### 2.2. スコープ (In Scope)
現在実装されている機能範囲：

- 単一のファイルパス（絶対パス）を検証対象として指定する機能。
- 指定されたファイルのハッシュ値（SHA-256）を計算する機能。
- 計算したハッシュ値を、指定されたディレクトリ内に、対象ファイルのフルパスに基づいて一意な名前で保存・管理する機能。
- 保存されたハッシュ値と現在のファイルのハッシュ値を比較し、一致するかどうかを検証する機能。
- ファイルパスからハッシュファイルパスを取得するユーティリティ機能。
- 安全なファイル読み書き機能（SafeReadFile、SafeWriteFile）。
- シンボリックリンク攻撃やTOCTOU攻撃への対策。
- ファイルサイズ制限（128MB）による DoS 攻撃対策。
- ハッシュ衝突の検出と適切なエラーハンドリング。
- ファイルシステム抽象化によるテスト容易性の向上。
- 上記の機能を提供するGoライブラリのAPI設計と実装。

### 2.3. スコープ外 (Out of Scope)
現在の実装の対象外：

- ファイル検証後のコマンド実行そのもの。
- ハッシュ値を最初に記録するタイミングの自動判断。
- 保存されたハッシュファイル自体の暗号化。
- ディレクトリ（フォルダ）を再帰的に検証する機能。
- SHA-256以外のハッシュアルゴリズムの具体的な実装（設計上は対応）。
- ハッシュファイルから元のファイルパスを取得する機能（GetTargetFilePath）。

## 3. 機能要件 (Functional Requirements)

### 3.1. 機能一覧

#### 機能ID: F-001
- **機能名:** ハッシュ値の記録
- **概要:** 利用者が指定したファイルのハッシュ値を計算し、所定の場所に保存する。
- **詳細:**
  1. 入力として、検証対象のファイルパスを受け取る。
  2. ファイルパスの検証（絶対パス変換、シンボリックリンクチェック、通常ファイルかの確認）を行う。
  3. SafeReadFileを使用してセキュアにファイル内容を読み込む。
  4. ファイルのSHA-256ハッシュ値を計算する。
  5. ハッシュファイル名を生成し、SafeWriteFileを使用してハッシュ保存ディレクトリに書き込む。
  6. 既存のハッシュファイルがある場合は、パス衝突をチェックし、同一パスの場合は上書きを許可する。

#### 機能ID: F-002
- **機能名:** ハッシュ値の検証
- **概要:** 指定されたファイルが、以前に記録された状態から変更されていないかを検証する。
- **詳細:**
  1. 入力として、検証対象のファイルパスを受け取る。
  2. SafeReadFileを使用してセキュアに現在のファイル内容を読み込む。
  3. 現在のファイルのSHA-256ハッシュ値を計算する。
  4. 対応するハッシュファイルから記録済みのハッシュ値と元のファイルパスを読み込む。
  5. 記録されたパスと現在のパスが一致することを確認する。
  6. 2つのハッシュ値を比較し、結果（一致/不一致）を返す。

#### 機能ID: F-003
- **機能名:** ハッシュファイルパスの取得
- **概要:** 検証対象のファイルパスに対応するハッシュファイルのパスを取得する。
- **詳細:**
  1. 入力として、検証対象のファイルパスを受け取る。
  2. ファイルパスを検証する（validatePath関数使用）。
  3. ファイルパスのSHA-256ハッシュ値を計算し、Base64URLエンコードする。
  4. 先頭12文字 + "." + アルゴリズム名をファイル名として生成し、フルパスを返す。

#### 機能ID: F-004
- **機能名:** 安全なファイル読み込み（SafeReadFile）
- **概要:** セキュリティを考慮した安全なファイル読み込み機能を提供する。
- **詳細:**
  1. 絶対パスに変換し、O_NOFOLLOWフラグを使用してファイルを開く。
  2. シンボリックリンクの場合はErrIsSymlinkを返す。
  3. verifyPathComponents関数でディレクトリ階層にシンボリックリンクがないことを確認。
  4. validateFile関数で通常ファイルであることを確認。
  5. ファイルサイズ制限（128MB）をチェック。
  6. LimitReaderを使用してメモリ安全性を確保しながら読み込み。

#### 機能ID: F-005
- **機能名:** 安全なファイル書き込み（SafeWriteFile）
- **概要:** セキュリティを考慮した安全なファイル書き込み機能を提供する。
- **詳細:**
  1. 絶対パスに変換し、O_WRONLY|O_CREATE|O_EXCL|O_NOFOLLOWフラグを使用してファイルを開く。
  2. 既存ファイルの場合はErrFileExists、シンボリックリンクの場合はErrIsSymlinkを返す。
  3. verifyPathComponents関数でディレクトリ階層にシンボリックリンクがないことを確認。
  4. validateFile関数で通常ファイルであることを確認。
  5. ファイルシステムアブストラクション（FileSystem/Fileインターフェース）によりテスト容易性を確保。

#### 機能ID: F-006
- **機能名:** パスコンポーネント検証（verifyPathComponents）
- **概要:** ファイルパスのディレクトリ階層にシンボリックリンクが含まれていないことを検証する。
- **詳細:**
  1. ファイルの親ディレクトリから開始して、ルートディレクトリまで遡る。
  2. 各ディレクトリに対してos.Lstatを使用してシンボリックリンクチェック。
  3. シンボリックリンクが見つかった場合はErrIsSymlinkを返す。
  4. 存在しないディレクトリの場合は安全とみなして処理を続行。

## 4. 非機能要件 (Non-Functional Requirements)

### 4.1. 性能 (Performance)
- 10MBのファイルのハッシュ値検証が、一般的な開発環境において100ミリ秒以内に完了すること。
- 最大ファイルサイズ128MBまでの処理をサポートすること。

### 4.2. セキュリティ (Security)
- **パス・トラバーサル攻撃対策:** `filepath.Abs`と`filepath.EvalSymlinks`を用いてパスを正規化・解決する。
- **TOCTOU攻撃対策:** ファイルを開いた後にファイルディスクリプタを用いて検証を行う。
- **シンボリックリンク攻撃対策:** O_NOFOLLOWフラグを使用し、パスコンポーネントもチェックする。
- **DoS攻撃対策:** ファイルサイズ制限（128MB）を設ける。
- **ハッシュ衝突対策:** 異なるファイルが同じハッシュファイル名を生成した場合を検出し、エラーを返す。

### 4.3. 信頼性・可用性 (Reliability/Availability)
- ファイルが存在しない、読み取り権限がないなど、ファイルI/Oに関するエラーが発生した場合、利用者が原因を特定できるような具体的なエラー情報を返すこと。
- 複数の定義済みエラー型を提供し、プログラムによる適切なエラーハンドリングを可能にすること。

### 4.4. 互換性 (Compatibility)
- Linux, macOS, Windowsの各OSで正常に動作すること。
- NetBSD固有のO_NOFOLLOWエラー（EFTYPE）に対応すること。
- Go 1.21以上でビルドできること。

### 4.5. 保守性 (Maintainability)
- Goの標準的なコーディング規約に準拠すること。
- 公開APIには、その機能と利用方法を説明する十分なコメントを付与すること。
- 主要な機能は単体テストで網羅すること。
- テスト可能性を考慮した設計（依存性注入、インターフェース分離）を採用すること。

## 5. 制約条件 (Constraints)

- 使用言語はGoとする。
- Goの標準ライブラリを優先的に使用し、サードパーティ製のライブラリ依存は最小限に抑えること。
- ハッシュアルゴリズムは、現在はSHA-256を実装する。
- ハッシュファイル名は、対象ファイルの絶対パスのSHA-256ハッシュの先頭12文字 + アルゴリズム名の拡張子で生成する。
- internal パッケージとして実装し、プロジェクト外部からの直接利用を制限すること。

## 6. エラー処理要件

### 6.1. 定義されたエラー型
現在の実装では以下のエラー型が定義されている：

- `ErrMismatch`: ファイル内容が記録されたハッシュと一致しない
- `ErrHashFileNotFound`: ハッシュファイルが見つからない
- `ErrInvalidFilePath`: 無効なファイルパス
- `ErrIsSymlink`: シンボリックリンクが指定された
- `ErrNilAlgorithm`: アルゴリズムがnil
- `ErrHashDirNotExist`: ハッシュディレクトリが存在しない
- `ErrHashPathNotDir`: ハッシュパスがディレクトリでない
- `ErrInvalidHashFileFormat`: ハッシュファイルフォーマットが無効
- `ErrHashCollision`: ハッシュ衝突が検出された
- `ErrInvalidFilePathFormat`: 無効なファイルパスフォーマット
- `ErrSuspiciousFilePath`: 疑わしいファイルパス
- `ErrFileTooLarge`: ファイルが大きすぎる
- `ErrFileExists`: ファイルが既に存在する

### 6.2. エラーハンドリング方針
- 各エラーは適切にラップされ、コンテキスト情報を含むこと。
- 呼び出し元がエラーの種類に応じた処理を行えるよう、型アサーションやerrors.Isを使用可能にすること。
- エラーメッセージには、問題の特定に必要な情報を含めつつ、機密情報は含めないこと。
