# 要件定義書：ファイル改ざん検出

## 1. 概要 (Overview)

**目的:** このドキュメントは、ファイル改ざん検出に関する要件を定義する。

**背景:**
セキュリティリスク軽減のため、
コマンドを実行する際にそのコマンド自体ならびにコマンドが参照する設定ファイルが変更されていないかを検出するための Go ライブラリを開発する。

## 2. 目的とスコープ (Goals and Scope)

### 2.1. 目的 (Goals)
(このイテレーションで達成したいことを具体的に記述します。)

-   指定されたファイル（コマンド本体や設定ファイル）のハッシュ値を計算し、記録する機能を提供する。
-   記録されたハッシュ値と、コマンド実行直前のファイルのハッシュ値を比較し、ファイルが改ざんされていないか検証する機能を提供する。
-   ハッシュ値は、指定されたディレクトリにファイルごとに保存する。
-   複数のハッシュアルゴリズムに対応できる設計とする。

### 2.2. スコープ (In Scope)
(開発の対象範囲を明確にします。)

-   単一または複数のファイルパス（絶対パス）を検証対象として指定する機能。
-   指定されたファイルのハッシュ値（SHA-256）を計算する機能。
-   計算したハッシュ値を、指定されたディレクトリ内に、対象ファイルのフルパスに基づいて一意な名前で保存・管理する機能。（例：ハッシュ保存先 `/var/hashes`, 対象ファイル `/usr/local/bin/app` -> ハッシュファイル `/var/hashes/L3Vzci9sb2NhbC9iaW4vYXBw.sha256` ※）
-   保存されたハッシュ値と現在のファイルのハッシュ値を比較し、一致するかどうかを検証する機能。
-   ファイルパスとハッシュファイルパスを相互に変換するユーティリティ機能。
-   上記の機能を提供するGoライブラリのAPI設計と実装。

### 2.3. スコープ外 (Out of Scope)
(開発の対象外の範囲を明確にします。これにより、作業範囲の認識齟齬を防ぎます。)

-   ファイル検証後のコマンド実行そのもの。 (このライブラリは検証機能のみを提供し、コマンド実行は利用側が行う)
-   ハッシュ値を最初に記録するタイミングの自動判断。 (ハッシュ値の初回記録は、利用者が信頼できる状態で行うことを前提とする)
-   保存されたハッシュファイル自体のパーミッション管理や暗号化などのセキュリティ対策。
-   ディレクトリ（フォルダ）を再帰的に検証する機能。
-   このイテレーションにおける、SHA-256以外のハッシュアルゴリズムの具体的な実装。 (設計上は考慮するが、実装はSHA-256のみ)

※ ハッシュファイル名は、対象ファイルの絶対パスをURL-safe Base64でエンコードし、衝突を回避します。

## 3. 機能要件 (Functional Requirements)

(システムが提供すべき具体的な機能を定義します。「誰が」「何を」「どうする」が分かるように記述するのが理想です。)

### 3.1. 機能一覧
-   **機能ID:** `F-001`
-   **機能名:** ハッシュ値の記録
-   **概要:** 利用者が指定したファイルのハッシュ値を計算し、所定の場所に保存する。この操作は、ファイルが信頼できる状態にあることを利用者が確認した上で行うことを前提とする。
-   **詳細:**
    1.  入力として、検証対象のファイルパスを受け取る。
    2.  ファイルのSHA-256ハッシュ値を計算する。
    3.  ハッシュ値を `[ハッシュ保存ディレクトリ]/[エンコードされたファイルパス].sha256` という名前のファイルに書き込む。

-   **機能ID:** `F-002`
-   **機能名:** ハッシュ値の検証
-   **概要:** 指定されたファイルが、以前に記録された状態から変更されていないかを検証する。
-   **詳細:**
    1.  入力として、検証対象のファイルパスを受け取る。
    2.  現在のファイルのSHA-256ハッシュ値を計算する。
    3.  対応するハッシュファイル（`[ハッシュ保存ディレクトリ]/[エンコードされたファイルパス].sha256`）から記録済みのハッシュ値を読み込む。
    4.  2つのハッシュ値を比較し、結果（一致/不一致）を返す。

-   **機能ID:** `F-003`
-   **機能名:** ファイルパスとハッシュファイルパスの相互変換
-   **概要:** 利用者が、検証対象のファイルパスとそれに対応するハッシュファイルのパスを相互に変換できるようにする。これにより、どのハッシュファイルがどのファイルを対象としているかの可読性が向上する。
-   **詳細:**
    1.  入力として、検証対象のファイルパスを受け取り、対応するハッシュファイルのフルパスを返す機能。
    2.  入力として、ハッシュファイルのパスを受け取り、対応する元の検証対象ファイルパスを返す機能。

## 4. 非機能要件 (Non-Functional Requirements)

(機能以外の品質や特性に関する要件を定義します。)

### 4.1. 性能 (Performance)
-   10MBのファイルのハッシュ値検証が、一般的な開発環境において100ミリ秒以内に完了すること。

### 4.2. セキュリティ (Security)
-   パス・トラバーサル攻撃を防ぐため、処理前にファイルパスを正規化し、安全性を検証すること。
-   TOCTOU (Time-of-check to time-of-use) 脆弱性を避けるため、シンボリックリンクを検証対象としない。シンボリックリンクが指定された場合はエラーを返すこと。

### 4.3. 信頼性・可用性 (Reliability/Availability)
-   ファイルが存在しない、読み取り権限がないなど、ファイルI/Oに関するエラーが発生した場合、利用者が原因を特定できるような具体的なエラー情報を返すこと。

### 4.4. 互換性 (Compatibility)
-   Linux, macOS, Windowsの各OSで正常に動作すること。
-   Go 1.21以上でビルドできること。

### 4.5. 保守性 (Maintainability)
-   Goの標準的なコーディング規約 (`gofmt`, `go vet`) に準拠すること。
-   公開APIには、その機能と利用方法を説明する十分なGo Docコメントを付与すること。
-   主要な機能は単体テストで網羅し、カバレッジは90%以上を目指すこと。

## 5. 制約条件 (Constraints)

(開発を進める上での制約や、すでに決定している事項を記述します。)

-   使用言語はGoとする。
-   Goの標準ライブラリを優先的に使用し、サードパーティ製のライブラリ依存は最小限に抑えること。
-   ハッシュアルゴリズムは、このイテレーションではSHA-256を実装する。ただし、将来的にSHA-384などの他のアルゴリズムを追加できるよう、拡張性を考慮した設計とすること。

## 6. 用語集 (Glossary)

(このドキュメントやプロジェクトで使われる専門用語、略語などを定義します。)

-   （例：**安全なコマンド:** ...）