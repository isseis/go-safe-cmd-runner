# 要件定義書：早期特権放棄による安全なSUIDバイナリ実装

## 1. 概要 (Overview)

**目的:** このドキュメントは、SUIDバイナリにおける早期特権放棄（Early Privilege Drop）の実装に関する要件を定義する。

**背景:**
現在のgo-safe-cmd-runnerでは、SUIDビットが設定されたrunnerバイナリが全体的にroot権限で動作しており、以下の問題が発生している：

1. **不適切なファイル所有権**: `/tmp/cmd-runner-comprehensive` などのディレクトリがroot権限で作成され、後から `chown` で所有権を変更している
2. **過度な特権保持**: 特権が不要な処理（設定読み込み、ファイル操作等）もroot権限で実行されている
3. **セキュリティリスク**: 攻撃対象面が大きく、SUIDバイナリのベストプラクティスに準拠していない

これらの問題を解決するため、UNIX系OSにおけるSUIDバイナリの標準的なセキュリティパターンである「早期特権放棄」を実装する。

## 2. 目的とスコープ (Goals and Scope)

### 2.1. 目的 (Goals)

- SUIDバイナリにおける最小特権原則の徹底
- 特権保持期間の最小化によるセキュリティリスク低減
- ファイル・ディレクトリの自然な所有権管理
- SUIDバイナリのベストプラクティスへの準拠

### 2.2. スコープ (In Scope)

- main関数での早期 `seteuid(getuid())` 実装
- 特権が必要な処理でのみの一時的特権昇格機能
- PrivilegeManagerインターフェースの拡張
- ResourceManagerでの不要な所有権変更処理の削除
- 特権昇格/放棄のログ記録機能

### 2.3. スコープ外 (Out of Scope)

- ファイル検証機能の変更
- 設定ファイルフォーマットの変更
- 非SUIDモードでの動作変更
- Windows環境での実装（Unix系OSのみ対象）

## 3. 機能要件 (Functional Requirements)

### 3.1. 機能一覧

- **機能ID:** `F-001`
- **機能名:** 早期特権放棄
- **概要:** main関数の初期化完了後、即座に実効UIDを実UIDに設定し、デフォルト状態を非特権とする。

- **機能ID:** `F-002`
- **機能名:** 一時的特権昇格
- **概要:** 特権が必要なコマンド実行時のみ、一時的に実効UIDを0（root）に設定する。

- **機能ID:** `F-003`
- **機能名:** 自動特権放棄
- **概要:** 特権コマンド実行完了後、即座に実効UIDを実UIDに戻す。

- **機能ID:** `F-004`
- **機能名:** 特権状態検知
- **概要:** 現在の特権状態を正確に検知し、適切な権限管理を行う。

- **機能ID:** `F-005`
- **機能名:** エラーハンドリング
- **概要:** 特権昇格/放棄の失敗時に適切なエラー処理を行い、セキュリティを保持する。

## 4. 非機能要件 (Non-Functional Requirements)

### 4.1. 性能 (Performance)

- 特権昇格/放棄のオーバーヘッドは1ms未満であること
- 非特権処理の性能に影響を与えないこと

### 4.2. セキュリティ (Security)

- **最小特権原則**: デフォルト状態は常に実UIDで動作すること
- **特権最小化**: root権限での実行時間を可能な限り短縮すること
- **fail-secure**: 特権操作に失敗した場合、セキュアな状態を維持すること
- **権限昇格追跡**: 特権昇格/放棄をログに記録すること
- **竞争状态防止**: 特権変更時のrace conditionを防止すること

### 4.3. 信頼性・可用性 (Reliability/Availability)

- 特権操作の失敗時に適切なエラーメッセージを提供すること
- 部分的な特権変更失敗時にシステムを一貫した状態に保つこと

### 4.4. 互換性 (Compatibility)

- Linux系OSでの動作（glibc, musl対応）
- Go 1.21以上での動作保証
- 既存の設定ファイル形式との完全な互換性維持

### 4.5. 保守性 (Maintainability)

- 特権管理ロジックの集約化
- テスタブルなインターフェース設計
- 明確な責任分離

## 5. 制約条件 (Constraints)

### 5.1. 技術的制約

- Unix系システムの `seteuid` システムコールに依存
- SUIDビット設定済みバイナリでの動作が前提
- Go標準ライブラリの `syscall` パッケージを使用

### 5.2. セキュリティ制約

- 特権昇格は明示的に必要な処理でのみ許可
- 特権状態での処理は最小限のコードパスに限定
- エラー発生時は非特権状態への復帰を最優先

### 5.3. 互換性制約

- 既存のPrivilegeManagerインターフェースとの後方互換性維持
- 非SUIDモードでの動作に影響を与えない

## 6. 技術的背景とベストプラクティス

### 6.1. SUIDバイナリのセキュリティパターン

**早期特権放棄（Early Drop of Privileges）:**
- SUIDバイナリの標準的なセキュリティパターン
- プログラム開始後可能な限り早く `seteuid(getuid())` を実行
- 必要時のみ `seteuid(0)` で一時的に特権を取得

**最小特権原則（Principle of Least Privilege）:**
- 常に必要最小限の権限でプロセスを実行
- 攻撃対象面の最小化

### 6.2. 実装における考慮事項

**Race Condition対策:**
- 特権変更とファイルアクセスの間での競合状態防止
- アトミックな権限変更操作

**Error Handling:**
- 特権昇格失敗時のfail-secureな動作
- 部分的失敗時の状態一貫性保持

## 7. 解決すべき具体的課題

### 7.1. 現在の問題点

1. **ディレクトリ所有権問題**: `/tmp/cmd-runner-comprehensive` がroot権限で作成される
2. **過剰な特権保持**: ファイル読み書き、設定処理等が不要にroot権限で実行
3. **不自然な権限変更**: 作成後の `chown` による所有権変更

### 7.2. 期待される改善効果

1. **自然な所有権**: ディレクトリ・ファイルが実行ユーザー権限で作成される
2. **セキュリティ向上**: 攻撃対象面の大幅な削減
3. **可読性向上**: 権限管理ロジックの明確化

## 8. 用語集 (Glossary)

- **実UID (Real UID)**: プロセスを実行した実際のユーザーのUID
- **実効UID (Effective UID)**: ファイルアクセス等の権限チェックに使用されるUID
- **SUID**: Set User ID。実行時に実効UIDをファイル所有者のUIDに設定するパーミッション
- **早期特権放棄**: SUIDバイナリで初期化後即座に実効UIDを実UIDに設定するセキュリティパターン
- **最小特権原則**: 必要最小限の権限のみでプロセスを実行するセキュリティ原則
- **特権昇格**: 一時的に実効UIDを0（root）に設定して管理者権限を取得すること
