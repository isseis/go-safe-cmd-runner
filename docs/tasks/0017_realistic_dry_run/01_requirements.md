# 要件定義書: リアリスティックなDry-Run機能の実装

## 1. 背景と課題

### 1.1 現在の状況
現在のdry-run機能（`--dry-run`フラグ）は、TOMLファイルをパースして設定されたコマンドグループと個別コマンドをテキスト形式で表示するのみです。

### 1.2 問題点
- **実行フローとの乖離**: 実際の実行パスと表示内容が大きく異なる
- **特権昇格の検出不足**: privilege escalationが必要なコマンドが識別されない
- **環境変数展開の未実施**: `${VAR}`形式の変数が展開されずに表示される
- **ファイル検証の省略**: 実際には実行前に行われるハッシュ検証が実施されない
- **作業ディレクトリの確認不足**: 各コマンドがどの作業ディレクトリで実行されるかが不明
- **依存関係の可視化不足**: グループ間の依存関係や実行順序が表示されない

## 2. 要件概要

### 2.1 目的
実際の実行処理と可能な限り同じフローを辿りながら、副作用を発生させずに実行計画を詳細に表示する機能を実装する。

### 2.2 基本方針
- 実際の実行パスを最大限再現する
- 全ての検証処理を実施する
- 副作用の発生は完全に防ぐ
- 実行前に問題を発見できるようにする

## 3. 機能要件

### 3.1 実行フロー再現
- ✅ 設定ファイルのロードと検証（Phase 2で ResourceManager パターンとして実装完了）
- ✅ 環境ファイルのロードと検証（Phase 2で ResourceManager パターンとして実装完了）
- ✅ ハッシュファイルによるファイル検証（Phase 2で ResourceManager パターンとして実装完了）
- ✅ 環境変数の展開と解決（Phase 2で ResourceManager パターンとして実装完了）
- ✅ グループ依存関係の解決と実行順序の決定（Phase 2で ResourceManager パターンとして実装完了）
- ✅ 各コマンドの特権要件の分析（Phase 2でセキュリティ分析として実装完了）

### 3.2 出力情報
#### 3.2.1 実行計画概要
- 実行予定のグループ数とコマンド数
- 推定実行時間（タイムアウト値の合計）
- 特権昇格が必要なコマンドの有無
- 検証対象ファイル数

#### 3.2.2 グループ別詳細情報
各グループについて以下を表示：
- グループ名、説明、優先度
- 作業ディレクトリ
- 環境変数一覧（展開後の値、機密情報はマスク）
- 依存するグループ
- 推定実行時間

#### 3.2.3 コマンド別詳細情報
各コマンドについて以下を表示：
- コマンド名と説明
- 完全なコマンドライン（環境変数展開後）
- 実行ユーザー（特権昇格の有無）
- 作業ディレクトリ
- タイムアウト設定
- 出力先設定

### 3.3 検証機能
- ✅ 設定ファイルの構文検証（Phase 2でDefaultResourceManagerパターンとして実装完了）
- ✅ 環境ファイルの存在確認と検証（Phase 2でDefaultResourceManagerパターンとして実装完了）
- ✅ ハッシュファイルによるファイル整合性検証（Phase 2でDefaultResourceManagerパターンとして実装完了）
- ✅ 環境変数の循環参照検出（Phase 2でDefaultResourceManagerパターンとして実装完了）
- ✅ 未定義変数の検出（Phase 2でDefaultResourceManagerパターンとして実装完了）
- ✅ 実行権限の事前確認（Phase 2でDefaultResourceManagerパターンとして実装完了）

### 3.4 エラー報告
- ✅ 設定エラーの詳細報告（Phase 2でDryRunResultシステムとして実装完了）
- ✅ ファイル検証失敗の詳細（Phase 2でDryRunResultシステムとして実装完了）
- ✅ 権限不足の警告（Phase 2でSecurityAnalysisとして実装完了）
- ✅ 潜在的なセキュリティリスクの指摘（Phase 2でSecurityAnalysisとして実装完了）

## 4. 非機能要件

### 4.1 セキュリティ
- 機密情報（パスワード、トークン等）のマスキング
- 実際のコマンド実行は一切行わない
- ファイル読み取り以外の副作用を発生させない

### 4.2 パフォーマンス
- 大規模設定でも10秒以内に完了
- メモリ使用量は実際の実行時の50%以下

### 4.3 互換性
- 既存の`--dry-run`フラグとの互換性を保持
- 現在の出力形式からの段階的移行

## 5. 制約事項

### 5.1 技術的制約
- コマンド実行は行わないため、動的な実行結果に依存する情報は取得不可
- 外部サービスへの接続確認は実施しない
- ファイルシステムの変更は行わない

### 5.2 機能的制約
- 実際の実行時間の予測は困難（タイムアウト値ベースの推定のみ）
- 条件分岐やループを含むコマンドの動的フローは追跡不可

## 6. 成功基準

### 6.1 機能面
- [ ] 実際の実行で発生する問題の80%以上を事前検出可能
- [ ] 環境変数展開の完全な実装
- [ ] 特権昇格要件の正確な識別

### 6.2 品質面
- [ ] 既存テストの100%通過
- [ ] 新機能のテストカバレッジ90%以上
- [ ] セキュリティレビューの通過

### 6.3 運用面
- [ ] ドキュメントの整備
- [ ] 既存ワークフローへの影響なし
- [ ] 後方互換性の維持

## 7. 実装上の考慮事項

### 7.1 既存コードへの影響
- 現在の`ListCommands()`メソッドの拡張
- `Runner`構造体の機能拡張
- 新しいdry-run専用インターフェースの追加

### 7.2 テスト戦略
- 既存のテスト資産の活用
- dry-run専用のテストケース追加
- エラーケースの網羅的テスト

### 7.3 段階的実装
1. 基本的な実行フロー再現
2. 環境変数展開機能
3. 詳細出力機能
4. エラー検出・報告機能
5. 最適化とドキュメント整備
