# 要件定義書：ハッシュディレクトリセキュリティ強化

## 1. プロジェクト概要

### プロジェクト名
ハッシュディレクトリセキュリティ強化 - コマンドライン引数削除とテスト環境分離

### 背景
現在のrunnerコマンドでは`--hash-directory`オプションによりハッシュディレクトリを任意に指定できるが、これは重大なセキュリティ脆弱性を引き起こす可能性がある。攻撃者がカスタムハッシュディレクトリに偽のハッシュファイルを配置することで、特権実行環境で悪意のあるコマンドを「正当」として検証・実行させることが可能になる。

### 問題の重要度
**CRITICAL** - 特権昇格攻撃に直結する可能性があるセキュリティ脆弱性

## 2. セキュリティリスク分析

### 2.1 特定された攻撃シナリオ

1. **偽ハッシュディレクトリ作成攻撃**
   - 攻撃者が制御可能なディレクトリ（例：`/tmp/fake-hashes/`）を作成
   - 悪意のあるコマンドに対応するハッシュファイルを配置
   - `runner --hash-directory /tmp/fake-hashes/`で実行
   - setuidバイナリやroot権限で悪意のあるコードが実行される

2. **特権昇格攻撃の完成**
   - 通常ユーザーがカスタムハッシュディレクトリを指定
   - 特権実行時に攻撃者が用意したハッシュで検証
   - システム管理者権限での任意コード実行

### 2.2 現在の制約
- ハッシュディレクトリのパストラバーサル対策は実装済み
- シムリンク攻撃対策は実装済み
- **しかし、任意ディレクトリ指定そのものが根本的脆弱性**

## 3. 機能要件

### 3.1 セキュリティ要件（MUST）

#### SR-01: コマンドライン引数完全削除
- `--hash-directory`フラグを完全削除
- プロダクション環境では常にデフォルトハッシュディレクトリのみ使用
- **根拠**: 攻撃経路の完全排除

#### SR-02: デフォルトハッシュディレクトリ強制
- プロダクションビルドでは`cmdcommon.DefaultHashDirectory`のみ使用
- 環境変数による上書きも禁止
- **根拠**: 一貫性のあるセキュリティポリシー

#### SR-03: テスト環境での柔軟性維持
- 単体テスト・統合テストではカスタムハッシュディレクトリ指定を許可
- テスト専用APIの提供
- **根拠**: 開発効率とテスタビリティの維持

### 3.2 API設計要件（MUST）

#### AR-01: プロダクション用API簡素化
```go
// NewManager() のみをプロダクション環境で使用
func NewManager() (*Manager, error)
```

#### AR-02: テスト専用API分離
```go
// テスト環境でのみ利用可能
func NewManagerForTest(hashDir string, options ...Option) (*Manager, error)
```

#### AR-03: テスト用API誤用防止
- ビルドタグ制約による強制
- 静的解析による検証
- CI/CDでの自動チェック

### 3.3 互換性要件（SHOULD）

#### CR-01: 破壊的変更の明示
- BREAKING CHANGEとしてリリース
- マイグレーションガイドの提供
- バージョニング戦略の明確化

#### CR-02: 既存テストコード保護
- 既存の単体テスト・統合テストは動作継続
- テスト用APIへの移行パスを提供

## 4. 非機能要件

### 4.1 セキュリティ要件

- **SEC-01**: ゼロトラストアプローチ
  - カスタムハッシュディレクトリを一切信頼しない
  - デフォルトディレクトリのみを信頼できるソースとする

- **SEC-02**: 多層防御
  - コンパイル時制約
  - ビルドタグ制約
  - 静的解析チェック
  - CI/CDパイプライン検証

### 4.2 保守性要件

- **MAIN-01**: コード複雑性削減
  - ハッシュディレクトリ解決ロジックの簡素化
  - 分岐処理の削除

- **MAIN-02**: テスタビリティ維持
  - テスト専用APIによる柔軟なテスト実行
  - モックフレンドリーな設計

### 4.3 運用要件

- **OPS-01**: 後方互換性断絶の管理
  - 明確な移行期間の設定
  - ドキュメント更新

- **OPS-02**: ビルドプロセス改善
  - 誤用防止の自動化
  - 継続的セキュリティ検証

## 5. 制約事項

### 5.1 技術制約
- Go 1.23.10以上が必要
- ビルドタグ機能に依存
- 既存のテストフレームワーク（testify）との互換性維持

### 5.2 運用制約
- **プロダクション環境**: カスタムハッシュディレクトリ完全禁止
- **開発・テスト環境**: テスト用API経由でのみカスタムハッシュディレクトリ使用可能

### 5.3 移行制約
- 破壊的変更のため、メジャーバージョンアップが必要
- 既存のデプロイメントスクリプト修正が必要

## 6. 受け入れ基準

### 6.1 セキュリティ基準
- [ ] `--hash-directory`フラグが完全に削除されている
- [ ] プロダクションビルドでカスタムハッシュディレクトリ指定が不可能
- [ ] 静的解析でテスト用API誤用が検出される
- [ ] CI/CDでプロダクションコード内のテスト用API使用が検出される

### 6.2 機能基準
- [ ] 既存の単体テストが全て通過する（API移行後）
- [ ] 既存の統合テストが全て通過する（API移行後）
- [ ] プロダクション環境での正常動作確認

### 6.3 品質基準
- [ ] テストカバレッジ90%以上維持
- [ ] ビルド時間増加5%以内
- [ ] 全lintチェック通過

## 7. 除外事項

### 7.1 スコープ外
- 環境変数`GSCR_HASH_DIRECTORY`の削除（別タスクで対応）
- ハッシュアルゴリズムの変更
- ファイル検証ロジックの変更

### 7.2 将来の拡張として残す
- 設定ファイルベースのハッシュディレクトリ設定
- 複数ハッシュディレクトリの同時使用
- 動的ハッシュディレクトリ切り替え

## 8. 関係者

### 8.1 プロジェクト関係者
- **プロダクトオーナー**: プロジェクト承認者
- **開発者**: 実装担当者
- **セキュリティ担当者**: セキュリティレビュー担当

### 8.2 影響を受けるユーザー
- **本番環境ユーザー**: コマンドライン引数の削除により影響
- **開発者**: テスト用API使用方法の変更
- **CI/CDパイプライン**: ビルドプロセスの変更

## 9. リスクと対策

### 9.1 高リスク
- **リスク**: 破壊的変更による運用停止
- **対策**: 段階的リリースとマイグレーションガイド提供

### 9.2 中リスク
- **リスク**: テスト環境でのデバッグ効率低下
- **対策**: 充実したテスト用APIとドキュメント提供

### 9.3 低リスク
- **リスク**: ビルド時間の増加
- **対策**: ビルドタグ最適化とキャッシュ戦略

## 10. 成功指標

### 10.1 セキュリティ指標
- 脆弱性報告数: 0件
- セキュリティスキャン合格率: 100%

### 10.2 品質指標
- テスト成功率: 100%
- ビルド成功率: 100%
- 静的解析合格率: 100%

### 10.3 運用指標
- プロダクション環境でのエラー率: <0.1%
- 移行完了率: 100%

## 11. 次のフェーズ

### 11.1 Phase 2での対応予定
- 環境変数`GSCR_HASH_DIRECTORY`のセキュリティ強化
- 設定ファイルベースのより柔軟なハッシュディレクトリ管理
- 監査ログ強化

### 11.2 長期的展望
- ハッシュディレクトリの暗号化
- デジタル署名による改ざん検証
- 分散ハッシュストレージサポート
