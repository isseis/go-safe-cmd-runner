# 実装計画書: コマンド・引数内環境変数展開機能

## 1. プロジェクト概要

### 1.1 実装目標
- TOML設定ファイルのコマンド名（`cmd`）および引数（`args`）内の環境変数参照（`$VAR`、`${VAR}`）を実行時に自動展開
- 既存の反復制限方式を活用したシンプルで堅牢な実装
- セキュリティ要件（allowlist連携、循環参照検出）の完全遵守
- 既存機能との完全互換性維持

### 1.2 実装スコープ
| 機能カテゴリ | 内容 | 優先度 |
|-------------|------|--------|
| 基本機能 | cmd/args での `$VAR`, `${VAR}` 展開 | 高 |
| セキュリティ | allowlist連携、循環参照検出 | 高 |
| 互換性 | 既存設定ファイルとの完全互換 | 高 |
| 性能 | 既存性能への影響最小化 | 中 |
| 運用 | 監視・デバッグ機能 | 低 |

## 2. フェーズ別実装計画

### Phase 1: 基盤実装 (Week 1-2)

#### 1.1 既存コード分析と拡張点特定
- [x] `internal/runner/environment/processor.go` の現行実装分析
- [x] 変数展開ロジックの循環参照検出アルゴリズム理解
- [x] `variableReferenceRegex` の動作確認
- [x] Command.Env処理フローの詳細調査
- [x] allowlist検証処理の仕組み理解

#### 1.2 型定義とインターフェース設計
- [x] `internal/runner/expansion/types.go` 作成
  - [x] `VariableExpander` インターフェース定義
  - [x] `VariableParser` インターフェース定義
  - [x] `VariableResolver` インターフェース定義
  - [x] `Metrics` 構造体定義
  - [x] エラー型の統一定義
- [x] 既存エラー型との統合確認
  - [x] `ErrCircularReference` の流用
  - [x] `ErrVariableNotAllowed` の流用
  - [x] `ErrVariableNotFound` の流用

#### 1.3 両形式対応パーサー実装
- [x] `internal/runner/expansion/parser.go` 作成
  - [x] 統一正規表現パターンの実装（`unifiedVariablePattern`）
  - [x] 名前付きキャプチャグループによる両形式対応
  - [x] `ReplaceVariables` メソッド実装
  - [x] `resolveVariableWithErrorHandling` メソッド実装
  - [x] 循環参照検出機能の統合
- [x] パーサー単体テスト作成
  - [x] `$VAR` 形式の基本テスト
  - [x] `${VAR}` 形式の基本テスト
  - [x] 両形式混在テスト
  - [x] 循環参照検出のテスト
  - [x] エラーケーステスト

#### 1.4 既存Environment Processor拡張
- [x] `internal/runner/environment/processor.go` 拡張
  - [x] `simpleVariableRegex` 正規表現追加
  - [x] `ResolveVariableReferencesUnified` メソッド追加
  - [x] `replaceSimpleVariables` メソッド追加
  - [x] 反復上限を 10 → 15 に拡張（実用的なネスト深度に対し十分なマージンを確保するため）
  - [x] 両形式統一処理の実装
- [x] 拡張されたプロセッサーのテスト作成
  - [x] 既存テストケースの動作確認
  - [x] `$VAR` 形式のテストケース追加
  - [x] 混在形式のテストケース追加
  - [x] 循環参照検出のテスト拡張

#### 1.5 エスケープ機能実装
- [x] `ErrInvalidEscapeSequence` エラー型の追加
- [x] `resolveVariableReferencesForCommandEnv` への1文字スキャンアルゴリズム実装
  - [x] バックスラッシュエスケープ処理の追加（`\$`, `\\`）
  - [x] 不正エスケープシーケンスの検出とエラー処理
  - [x] 既存の正規表現を活用した変数パターンマッチング
  - [x] プレースホルダー方式によるエスケープ文字の保護
- [x] `ResolveVariableReferencesUnified` への同様の実装
- [x] エスケープ機能のテスト作成
  - [x] `\$FOO` → `$FOO` のテスト
  - [x] `\\$FOO` → `\value` のテスト
  - [x] 不正エスケープ（`\U`, `\1`, 末尾`\`）のエラーテスト
  - [x] 混在パターン（エスケープ + 変数展開）のテスト
  - [x] 全テストケースの合格確認

### Phase 2: 統合展開エンジン実装 (Week 3)

#### 2.1 cmd/args用展開エンジン実装
- [ ] `internal/runner/expansion/expander.go` 作成
  - [ ] `variableExpander` 構造体実装
  - [ ] `NewVariableExpander` コンストラクタ実装
  - [ ] `Expand` メソッド実装
  - [ ] `ExpandAll` メソッド実装
  - [ ] `GetMetrics` メソッド実装
- [ ] セキュリティ検証との統合
  - [ ] 既存 `SecurityValidator` の活用
  - [ ] allowlist検証の統合
  - [ ] Command.Env優先ポリシーの実装

#### 2.2 Config Parser統合
- [ ] `internal/runner/config/command.go` 拡張
  - [ ] `ExpandVariables` メソッド追加
  - [ ] `BuildEnvironmentMap` メソッド追加
  - [ ] コマンド名展開処理の統合
  - [ ] 引数展開処理の統合
  - [ ] エラーハンドリングの実装
- [ ] 設定ファイル処理フローへの統合
  - [ ] TOML読み込み処理での展開タイミング決定
  - [ ] 既存処理フローへの影響最小化
  - [ ] バックワード互換性の確保

#### 2.3 統合テスト実装
- [ ] `internal/runner/expansion/expansion_test.go` 作成
  - [ ] `TestVariableParser_ReplaceVariables` 実装
  - [ ] `TestVariableExpander_Expand` 実装
  - [ ] `TestVariableExpander_ExpandAll` 実装
  - [ ] `TestCircularReferenceDetection_IterativeBased` 実装
  - [ ] セキュリティテストケース追加
- [ ] 統合テストシナリオ実装
  - [ ] 実際のTOML設定ファイルでのテスト
  - [ ] 既存機能との互換性テスト
  - [ ] エラーケースの網羅的テスト

### Phase 3: 性能・品質最適化 (Week 4)

#### 3.1 性能測定と最適化
- [ ] ベンチマークテスト実装
  - [ ] `BenchmarkVariableExpansion` 実装
  - [ ] `simple_expansion` ベンチマーク
  - [ ] `complex_args` ベンチマーク
  - [ ] `braced_format_recommended` ベンチマーク
  - [ ] `glob_pattern_literal` ベンチマーク
- [ ] 性能分析と最適化
  - [ ] CPU使用率測定
  - [ ] メモリ使用量測定
  - [ ] 処理時間プロファイリング
  - [ ] ボトルネック特定と改善
- [ ] 性能要件の検証
  - [ ] 1ms/要素以下の処理時間確認
  - [ ] メモリ使用量2倍以下の確認
  - [ ] CPU使用率5%以下の確認

#### 3.2 セキュリティ検証強化
- [ ] セキュリティテストケース拡充
  - [ ] allowlist違反ケースのテスト
  - [ ] 権限昇格攻撃のテスト
  - [ ] インジェクション攻撃のテスト
  - [ ] パス展開攻撃のテスト
- [ ] 脆弱性スキャン実行
  - [ ] 静的解析ツールによるスキャン
  - [ ] 依存関係の脆弱性チェック
  - [ ] コードレビューによるセキュリティ検証

#### 3.3 エラーハンドリング改善
- [ ] エラーメッセージの改善
  - [ ] 具体的で理解しやすいエラーメッセージ
  - [ ] デバッグ情報の充実
  - [ ] ユーザビリティの向上
- [ ] ログ出力の実装
  - [ ] デバッグレベルでの詳細ログ
  - [ ] エラーレベルでの重要イベントログ
  - [ ] 統計レベルでのメトリクスログ

### Phase 4: 統合・動作検証 (Week 5)

#### 4.1 統合テスト実施
- [ ] 全機能統合テストの実行
  - [ ] 基本機能テストの実行
  - [ ] セキュリティ機能テストの実行
  - [ ] 性能テストの実行
  - [ ] 互換性テストの実行
- [ ] 実際の使用ケースでの検証
  - [ ] `sample/` ディレクトリのTOMLファイルでのテスト
  - [ ] 複雑な設定ファイルでの動作確認
  - [ ] エラーケースでの適切な動作確認

#### 4.2 回帰テスト実施
- [ ] 既存機能への影響確認
  - [ ] 全既存テストケースの実行
  - [ ] Command.Env機能の動作確認
  - [ ] セキュリティ機能の動作確認
  - [ ] パフォーマンスの劣化確認
- [ ] 互換性検証
  - [ ] 既存設定ファイルの無変更動作確認
  - [ ] バージョン間互換性の確認

#### 4.3 最終調整
- [ ] コード品質の最終確認
  - [ ] コードレビューの実施
  - [ ] 命名規則の統一
  - [ ] ドキュメントコメントの追加
- [ ] テストカバレッジの確認
  - [ ] 単体テストカバレッジ95%以上の達成
  - [ ] 統合テストの網羅性確認
  - [ ] エラーパスのテストカバレッジ確認

### Phase 5: ドキュメント・運用準備 (Week 6)

#### 5.1 ドキュメント作成
- [ ] ユーザーガイドの作成
  - [ ] 機能概要の説明
  - [ ] 使用方法の詳細説明
  - [ ] 設定例の提供
  - [ ] トラブルシューティングガイド
- [ ] 開発者向けドキュメント
  - [ ] アーキテクチャ設計書の更新
  - [ ] API仕様書の作成
  - [ ] メンテナンスガイドの作成

#### 5.2 サンプル設定ファイル作成
- [ ] 基本的な使用例
  - [ ] `sample/variable_expansion_basic.toml` 作成
  - [ ] シンプルな `$VAR` 形式の例
  - [ ] シンプルな `${VAR}` 形式の例
- [ ] 高度な使用例
  - [ ] `sample/variable_expansion_advanced.toml` 作成
  - [ ] 複数変数の展開例
  - [ ] ネスト変数の展開例
  - [ ] 混在形式の例
- [ ] セキュリティ設定例
  - [ ] `sample/variable_expansion_security.toml` 作成
  - [ ] allowlist設定の例
  - [ ] Command.Env優先の例

#### 5.3 運用準備
- [ ] 監視機能の実装
  - [ ] メトリクス収集機能
  - [ ] パフォーマンス監視機能
  - [ ] エラー統計機能
- [ ] 移行ガイドの作成
  - [ ] 既存設定からの移行手順
  - [ ] 移行時の注意点
  - [ ] ロールバック手順

## 3. 品質基準・完了条件

### 3.1 機能的完了基準
- [ ] cmdでの `$VAR` と `${VAR}` 両形式の正常展開
- [ ] argsでの `$VAR` と `${VAR}` 両形式の正常展開
- [ ] cmdとargs両方での複数環境変数の同時展開
- [ ] ネスト変数参照の正常処理
- [ ] allowlist連携の完全動作
- [ ] 循環参照の確実な検出・エラー化
- [ ] 展開後のコマンドパス検証の正常動作

### 3.2 性能的完了基準
- [ ] cmdとargs展開処理時間が1ms/要素以下
- [ ] メモリ使用量増加が従来の2倍以下
- [ ] CPU使用率増加が5%以下
- [ ] 既存機能の性能劣化なし

### 3.3 品質的完了基準
- [ ] 単体テストカバレッジ95%以上
- [ ] 統合テスト全パターンPASS
- [ ] セキュリティテスト全項目クリア
- [ ] 既存機能の回帰テスト全PASS
- [ ] コードレビュー完了
- [ ] ドキュメント作成完了

### 3.4 セキュリティ完了基準
- [ ] allowlist機能の正常動作確認
- [ ] 権限昇格攻撃の防御確認
- [ ] インジェクション攻撃の防御確認
- [ ] 循環参照DoS攻撃の防御確認
- [ ] パス展開攻撃の防御確認
- [ ] 情報漏洩リスクの最小化確認

## 4. リスク管理と軽減策

### 4.1 技術リスク
| リスク | 影響度 | 発生確率 | 軽減策 | 担当者 | 期限 |
|--------|--------|----------|--------|--------|------|
| 既存コードへの想定外影響 | 高 | 中 | 段階的実装、包括的テスト | - | Phase 4 |
| 性能劣化 | 中 | 中 | ベンチマーク測定、最適化実装 | - | Phase 3 |
| セキュリティホール | 高 | 低 | 多層防御、専門家レビュー | - | Phase 3 |
| 複雑性の増大 | 中 | 中 | シンプルな設計、明確な分離 | - | Phase 1-2 |

### 4.2 スケジュールリスク
| リスク | 影響度 | 発生確率 | 軽減策 | 予備計画 |
|--------|--------|----------|--------|----------|
| 実装難易度の過小評価 | 中 | 中 | 詳細な事前調査 | Phase分割の細分化 |
| テスト工数の増大 | 中 | 高 | 早期テスト開始 | 並行テスト実施 |
| 統合時の問題発見 | 高 | 中 | 段階的統合 | フィーチャーフラグ導入 |

### 4.3 品質リスク
| リスク | 影響度 | 発生確率 | 軽減策 | 検証方法 |
|--------|--------|----------|--------|----------|
| 仕様の理解不足 | 高 | 低 | 詳細な仕様書作成 | レビューセッション |
| エッジケースの見落とし | 中 | 中 | 網羅的テストケース | 境界値分析 |
| 互換性問題 | 高 | 低 | 徹底的互換性テスト | 既存ユーザーテスト |

## 5. 進捗管理

### 5.1 マイルストーン
- [ ] **M1**: Phase 1完了 - 基盤実装完了 (Week 2)
- [ ] **M2**: Phase 2完了 - 統合実装完了 (Week 3)
- [ ] **M3**: Phase 3完了 - 最適化完了 (Week 4)
- [ ] **M4**: Phase 4完了 - 動作検証完了 (Week 5)
- [ ] **M5**: Phase 5完了 - リリース準備完了 (Week 6)

### 5.2 週次レビュー項目
- [ ] 各Phase完了状況の確認
- [ ] 品質基準達成状況の評価
- [ ] リスクの再評価と軽減策の見直し
- [ ] 次週の作業計画の調整

### 5.3 最終チェックリスト
- [ ] 全機能要件の実装完了
- [ ] 全性能要件の達成確認
- [ ] 全セキュリティ要件の満足確認
- [ ] 互換性の完全確保
- [ ] ドキュメントの完成
- [ ] テストカバレッジの要件達成
- [ ] コードレビューの完了
- [ ] 本番環境での動作確認

---

**実装開始日**: 2025年9月24日
**実装完了予定日**: 2025年11月5日
**総工期**: 6週間

この実装計画書に従って、段階的かつ確実に環境変数展開機能を実装し、品質・性能・セキュリティの全要件を満たすことを目指します。
