# 要件定義書: コマンド・引数内環境変数展開機能

## 1. プロジェクト概要

### 1.1 プロジェクト名
コマンド・引数内環境変数展開機能 (Command and Args Environment Variable Expansion)

### 1.2 プロジェクト目的
TOML設定ファイルのコマンド名（`cmd`）およびコマンド引数（`args`）内に記述された環境変数参照を実行時に自動展開し、より柔軟で動的なコマンド実行を可能にする。

### 1.3 背景と課題
現在のgo-safe-cmd-runnerでは以下の制限がある：

- **コマンド名での環境変数未サポート**: `cmd = "$DOCKER_CMD"` のような記述が環境変数として展開されない
- **引数での環境変数未サポート**: `args = ["$HOME/bin"]` のような記述が環境変数として展開されない
- **設定の静的性**: 環境ごとに異なるコマンドパスやオプションを動的に指定できない
- **保守性の問題**: 環境ごとに別々の設定ファイルを管理する必要がある

一方で、以下は既に実装済み：
- **Command.Env での展開**: `env = ["PATH=${PATH}:/usr/local/bin"]` は正常動作
- **セキュリティ検証**: 環境変数のallowlist機能により安全性を確保

## 2. 機能要件

### 2.1 基本機能

#### F001: コマンド名での環境変数展開サポート
**概要**: コマンド名（`cmd`）内の環境変数参照を実行時に展開する

**形式サポート**:
- `$VAR_NAME` - POSIX標準形式
- `${VAR_NAME}` - ブレース形式
- `$HOME/bin/cmd` - パス結合での使用
- `prefix_${VAR}_suffix` - 前後にテキストを含む形式
    - prefix_$VAR_suffix は $VAR_suffix までを変数と見なして展開されるが、この記述形式は推奨されない

**例**:
```toml
[[groups.commands]]
cmd = "$DOCKER_CMD"
args = ["run", "-it", "ubuntu"]
env = ["DOCKER_CMD=/usr/bin/docker"]
```

**展開後**:
```
cmd: "/usr/bin/docker"
args: ["run", "-it", "ubuntu"]
```

**応用例**:
```toml
[[groups.commands]]
cmd = "${TOOL_DIR}/custom-script"
args = ["--input", "$INPUT_FILE"]
env = ["TOOL_DIR=/opt/tools", "INPUT_FILE=/data/input.txt"]
```

**展開後**:
```
cmd: "/opt/tools/custom-script"
args: ["--input", "/data/input.txt"]
```

#### F002: 引数内での環境変数展開サポート
**概要**: 引数（`args`）内の環境変数参照を実行時に展開する

**形式サポート**:
F001と完全互換
- `$VAR_NAME` - POSIX標準形式
- `${VAR_NAME}` - ブレース形式
- `$HOME/path` - パス結合での使用
- `prefix_${VAR}_suffix` - 前後にテキストを含む形式
    - prefix_$VAR_suffix は $VAR_suffix までを変数と見なして展開されるが、この記述形式は推奨されない

**例**:
```toml
[[groups.commands]]
cmd = "cp"
args = ["$HOME/source.txt", "${BACKUP_DIR}/backup.txt"]
env = ["HOME=/home/user", "BACKUP_DIR=/opt/backups"]
```

**展開後**:
```
cmd: "cp"
args: ["/home/user/source.txt", "/opt/backups/backup.txt"]
```

#### F003: 複数環境変数サポート
**概要**: 単一のcmdまたはargs要素内で複数の環境変数参照をサポート

**cmd での例**:
```toml
[[groups.commands]]
cmd = "${BIN_DIR}/${APP_NAME}"
env = ["BIN_DIR=/usr/local/bin", "APP_NAME=myapp"]
```

**args での例**:
```toml
[[groups.commands]]
args = ["${USER}@${HOSTNAME}:${PORT}"]
env = ["USER=admin", "HOSTNAME=server01", "PORT=22"]
```

**展開後**:
```
cmd: "/usr/local/bin/myapp"
args: ["admin@server01:22"]
```

#### F004: ネスト変数参照サポート
**概要**: 環境変数値内で他の環境変数を参照する（既存のCommand.Env機能と同様）

**例**:
```toml
[[groups.commands]]
cmd = "$FULL_CMD_PATH"
args = ["$FULL_DATA_PATH"]
env = [
    "BASE_DIR=/opt",
    "BIN_DIR=${BASE_DIR}/bin",
    "DATA_DIR=${BASE_DIR}/data",
    "FULL_CMD_PATH=${BIN_DIR}/myapp",
    "FULL_DATA_PATH=${DATA_DIR}/input.txt"
]
```

**展開後**:
```
cmd: "/opt/bin/myapp"
args: ["/opt/data/input.txt"]
```

### 2.2 セキュリティ要件

#### S001: allowlist連携
**概要**: 既存のallowlist機能と完全統合

**要件**:
- cmdまたはargsで参照される環境変数はallowlistでチェック
- 許可されていない変数の参照は実行時エラー
- Command.Env で定義された変数は無条件で利用可能

**環境変数の優先順位**:
- Command.Env で定義された変数は、同名のOS環境変数より優先する
- これにより設定ファイル内で完結し、実行環境への依存を減らし、より安全で予測可能な動作を実現

**処理フローとallowlist検証の順序**:
1. cmdとargs内の環境変数参照を特定する
2. 参照されている変数がallowlistに含まれているか、またはCommand.Envで定義されているかを確認する
3. 許可されていない変数があれば、この時点でエラーとして処理を中断する
4. 許可された変数のみを使って、cmdとargsの文字列を展開する
5. 展開後のcmdパスに対して、既存の絶対パス検証やファイル存在チェックなどのセキュリティ検証を実行する

**特別な考慮事項**:
- **コマンドパス検証**: 展開されたcmdは絶対パスでのコマンド実行パス検証を通過する必要がある
- **セキュリティチェック**: 展開後のコマンドパスに対してもセキュリティ検証（権限チェック、allowlist確認等）を実施

#### S002: 循環参照検出
**概要**: 環境変数の循環参照を検出・防止

**例（エラーケース）**:
```toml
env = ["A=${B}", "B=${A}"]
```

#### S003: 展開制限
**概要**: セキュリティリスクを最小化する展開制限

**制限事項**:
- シェル実行は行わない（`$(...)`や`` `...` ``は未サポート）
- グロブパターンは展開しない（`*`, `?`はリテラル扱い）
- エスケープ機能は提供しない

### 2.3 互換性要件

#### C001: 既存設定との互換性
**概要**: 既存の設定ファイルが変更なしで動作継続

**要件**:
- 環境変数参照がないcmdとargsは従来通り動作
- 既存のCommand.Env処理は変更なし
- 設定ファイル構造は変更なし
- 静的なコマンドパス指定は従来通り動作

## 3. 非機能要件

### 3.1 性能要件

#### P001: 処理性能
- **展開処理時間**: cmdまたはargs要素1個あたり1ms以下
- **メモリ使用量**: 展開前の2倍以下に制限
- **CPU負荷**: 展開処理によるCPU使用率増加は5%以下

#### P002: スケーラビリティ
- **引数数制限**: 1コマンドあたり最大1000個の引数をサポート
- **変数数制限**: cmdまたは1引数あたり最大50個の環境変数参照をサポート
- **ネスト深度**: 変数参照のネスト深度は最大10レベル

### 3.2 信頼性要件

#### R001: エラーハンドリング
- **明確なエラーメッセージ**: 変数未定義、循環参照等で具体的エラー
- **部分失敗処理**: 一部変数が展開失敗た場合、そのグループの実行のみ中断してログに記録。他のグループの実行は継続。
- **ログ出力**: 展開処理の詳細をデバッグレベルでログ出力

#### R002: テスタビリティ
- **単体テスト**: 全展開パターンをカバー
- **統合テスト**: 実際のコマンド実行での動作確認
- **エラーケーステスト**: 異常系パターンを網羅

### 3.3 保守性要件

#### M001: コード品質
- **関心の分離**: 展開ロジックを独立モジュール化
- **既存コード影響最小化**: 既存実装への変更を最小限に抑制
- **設定可能性**: 展開機能の動作を設定で調整可能

#### M002: 監視・運用
- **展開統計**: 変数展開回数、失敗数の統計情報
- **パフォーマンス監視**: 展開処理時間の監視
- **セキュリティ監査**: 変数参照のアクセスログ

## 4. 制約事項

### 4.1 技術制約
- **Go 1.23.x 互換性**: 現在のGo言語バージョンとの完全互換
- **既存依存関係**: 新しい外部依存関係の追加は最小限
- **メモリ制約**: 組み込み環境での動作を考慮した省メモリ実装

### 4.2 セキュリティ制約
- **権限分離**: 変数展開は通常権限で実行
- **サンドボックス**: 展開処理はセキュアな環境で実行
- **監査証跡**: すべての変数アクセスを記録

### 4.3 運用制約
- **設定変更影響**: 本機能有効化が既存運用に与える影響は最小限
- **パフォーマンス影響**: 既存コマンド実行性能への影響は許容範囲
- **バックアップ互換**: 設定ファイルのバージョン管理で混乱を回避

## 5. 成功基準

### 5.1 機能的成功基準
- [ ] cmdでの `$VAR` と `${VAR}` 両形式の正常展開
- [ ] argsでの `$VAR` と `${VAR}` 両形式の正常展開
- [ ] cmdとargs両方での複数環境変数の同時展開
- [ ] ネスト変数参照の正常処理
- [ ] allowlist連携の完全動作
- [ ] 循環参照の確実な検出・エラー化
- [ ] 展開後のコマンドパス検証の正常動作

### 5.2 性能的成功基準
- [ ] cmdとargs展開処理時間が1ms/要素以下
- [ ] メモリ使用量増加が従来の2倍以下
- [ ] CPU使用率増加が5%以下
- [ ] 既存機能の性能劣化なし

### 5.3 品質的成功基準
- [ ] 単体テストカバレッジ95%以上
- [ ] 統合テスト全パターンPASS
- [ ] セキュリティテスト全項目クリア
- [ ] 既存機能の回帰テスト全PASS

## 6. リスク分析

### 6.1 技術リスク
**リスク**: 既存コードへの想定外の影響
**対策**: 段階的実装、包括的テスト、フィーチャーフラグによる制御

**リスク**: 性能劣化
**対策**: ベンチマーク測定、最適化実装、遅延評価の活用

### 6.2 セキュリティリスク
**リスク**: 変数展開による情報漏洩
**対策**: allowlist強制、ログマスキング、監査証跡

**リスク**: 権限昇格攻撃
**対策**: 最小権限原則、サンドボックス実行、入力値検証

### 6.3 運用リスク
**リスク**: 設定ミスによる障害
**対策**: 検証機能強化、段階的移行、ロールバック計画

**リスク**: 互換性問題
**対策**: 互換性テスト、バージョン管理、移行ガイド

## 7. 実装スコープ

### 7.1 Phase 1 - 基本実装
- cmdとargsでの基本的な環境変数展開機能
- `$VAR` と `${VAR}` 形式のサポート
- allowlist連携
- 基本的なエラーハンドリング
- 展開後のコマンドパス検証

### 7.2 Phase 2 - 高度な機能
- ネスト変数参照サポート
- 循環参照検出
- パフォーマンス最適化
- 包括的テスト

### 7.3 Phase 3 - 運用機能
- 統計・監視機能
- 設定管理機能
- ドキュメント整備
- 移行支援ツール

## 8. 関連資料

### 8.1 参考実装
- 既存の `internal/runner/environment/processor.go` (Command.Env の実装)
- Go標準ライブラリの `os.ExpandEnv()`
- シェルスクリプトの変数展開仕様 (POSIX)

### 8.2 関連仕様
- TOML v1.0.0 仕様
- go-safe-cmd-runner のセキュリティポリシー
- 環境変数allowlist機能仕様

### 8.3 テストケース
- `sample/output_capture_advanced.toml` でのテストケース
- セキュリティテストシナリオ
- パフォーマンステストシナリオ
