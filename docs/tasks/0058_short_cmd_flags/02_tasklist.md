# 短縮コマンドラインフラグと複数ファイル対応 - タスクリスト

## 進捗サマリー

**最終更新**: 2025-11-17

| Phase | タスク数 | 完了 | 進行中 | 未着手 | 進捗率 |
|-------|---------|------|--------|--------|--------|
| Phase 1: runner短縮フラグ実装 | 7 | 0 | 0 | 7 | 0% |
| Phase 2: record複数ファイル対応 | 6 | 6 | 0 | 0 | 100% |
| Phase 3: verify複数ファイル対応 | 6 | 6 | 0 | 0 | 100% |
| Phase 4: ドキュメントと最終調整 | 5 | 0 | 0 | 5 | 0% |
| **合計** | **24** | **12** | **0** | **12** | **50%** |

### 現在の状態

- ⏸️ **Phase 1未着手**: runner短縮フラグ実装
- ✅ **Phase 2完了**: record複数ファイル対応（短縮フラグ `-d` と位置引数対応、進捗/サマリー出力、エラーハンドリング、単体テスト実装）
- ✅ **Phase 3完了**: verify複数ファイル対応（位置引数対応、`-d` エイリアス、進捗/サマリー表示、失敗継続処理、単体テスト実装）
- ⏸️ **Phase 4未着手**: ドキュメントと最終調整

---

## Phase 1: runner短縮フラグ実装

### 概要

`cmd/runner/main.go`に短縮フラグを追加し、既存の長いフラグと同じ動作をするようにする。

### タスク一覧

#### 1.1 高優先度フラグの実装

- [ ] **SF-1.1**: `-config` / `-c` の実装
  - 所要時間: 30分
  - 依存: なし
  - 詳細: `flag.StringVar`を使用して同じ変数に両方のフラグを紐付け

- [ ] **SF-1.2**: `-dry-run` / `-n` の実装
  - 所要時間: 30分
  - 依存: なし
  - 詳細: `flag.BoolVar`を使用して同じ変数に両方のフラグを紐付け

- [ ] **SF-1.3**: `-groups` / `-g` の実装
  - 所要時間: 30分
  - 依存: なし
  - 詳細: `flag.StringVar`を使用して同じ変数に両方のフラグを紐付け

#### 1.2 中優先度フラグの実装

- [ ] **SF-1.4**: `-log-level` / `-l` の実装
  - 所要時間: 30分
  - 依存: なし
  - 詳細: `flag.StringVar`を使用して同じ変数に両方のフラグを紐付け

- [ ] **SF-1.5**: `-quiet` / `-q` の実装
  - 所要時間: 30分
  - 依存: なし
  - 詳細: `flag.BoolVar`を使用して同じ変数に両方のフラグを紐付け

- [ ] **SF-1.6**: `-validate` / `-V` の実装
  - 所要時間: 30分
  - 依存: なし
  - 詳細: `flag.BoolVar`を使用して同じ変数に両方のフラグを紐付け

#### 1.3 テストとドキュメント

- [ ] **SF-1.7**: 単体テストの実装
  - 所要時間: 2時間
  - 依存: SF-1.1 ~ SF-1.6
  - 詳細: 各短縮フラグが長いフラグと同じ動作をするか確認

### 成果物チェックリスト

- [ ] すべての短縮フラグが実装されている
- [ ] 既存の長いフラグと短縮フラグが同じ変数を参照している
- [ ] ヘルプメッセージに短縮形が表示される
- [ ] 単体テストがすべてパスする
- [ ] `make test` がパスする
- [ ] `make lint` がパスする

### 検証基準

```bash
# ビルド確認
make build

# 短縮フラグの動作確認
./build/runner -c testdata/config.toml -n
./build/runner --config testdata/config.toml --dry-run

# ヘルプメッセージ確認
./build/runner -h | grep -E "^\s+-(c|n|g|l|q|V)"

# テスト実行
make test

# Lint確認
make lint
```

---

## Phase 2: record複数ファイル対応

### 概要

`cmd/record/main.go`を修正し、複数ファイルを一度に処理できるようにする。

### タスク一覧

#### 2.1 コマンドラインパース変更

- [x] **SF-2.1**: `-file` フラグ削除と位置引数受け取り実装
  - 所要時間: 1時間
  - 依存: Phase 1完了
  - 詳細: `flag.Args()`で位置引数を取得、最低1つ必要
  - 実施内容: 新しい `parseArgs`/`run` フローを追加し、位置引数で任意個のファイルを受け取りつつ `-file` 指定時は警告を表示する非推奨モードとして併存させた。

- [x] **SF-2.2**: `-hash-dir` / `-d` 短縮フラグ実装
  - 所要時間: 30分
  - 依存: SF-2.1
  - 詳細: `flag.StringVar`を使用
  - 実施内容: `-hash-dir` と同じ変数に `-d` をバインドし、ヘルプにも短縮形を表示するよう更新。

#### 2.2 複数ファイル処理ロジック

- [x] **SF-2.3**: 複数ファイル処理ループ実装
  - 所要時間: 1.5時間
  - 依存: SF-2.1, SF-2.2
  - 詳細: 各ファイルを順次処理、成功数と失敗数を記録
  - 実施内容: `processFiles` を新設し、`hashRecorder.Record` の結果に応じて成功/失敗をカウントするループを導入。

- [x] **SF-2.4**: 進捗表示と結果サマリー実装
  - 所要時間: 1時間
  - 依存: SF-2.3
  - 詳細: `[1/3] file1.dat: OK` 形式で表示
  - 実施内容: `Processing N files...` から各 `[i/n]` ログ、および `Summary: X succeeded, Y failed` 出力を stdout に追加。

#### 2.3 テストとエラーハンドリング

- [x] **SF-2.5**: エラーハンドリング実装
  - 所要時間: 1時間
  - 依存: SF-2.3
  - 詳細: エラー発生時も残りを処理、最後に失敗があれば exit 1
  - 実施内容: 失敗したファイルで stderr に詳細を出しつつ処理継続し、失敗数>0なら exit code 1 を返すロジックを導入。

- [x] **SF-2.6**: 単体テストと統合テスト実装
  - 所要時間: 2時間
  - 依存: SF-2.3, SF-2.4, SF-2.5
  - 詳細: 正常系・異常系すべてのケースをカバー
  - 実施内容: `cmd/record/main_test.go` を新規作成し、複数ファイル成功、部分失敗、`-d` 短縮形、`-file` 非推奨警告、入力不足エラーを網羅。

### 成果物チェックリスト

- [x] 位置引数で複数ファイルを受け取れる（`run`/`parseArgs` で複数ファイル処理を実装）
- [x] `-hash-dir` / `-d` 短縮フラグが実装されている（同一変数への StringVar バインド）
- [x] 各ファイルの処理結果が表示される（`[i/n] path` ログを stdout に出力）
- [x] 最終サマリーが表示される（成功/失敗件数をまとめて表示）
- [x] エラーハンドリングが適切（失敗しても継続し exit code 1 を返却）
- [x] 単体テストと統合テストがすべてパスする（`cmd/record/main_test.go` 追加）
- [x] `make test` がパスする
- [x] `make lint` がパスする

### 検証基準

```bash
# ビルド確認
make build

# 単一ファイル処理
./build/record -d /tmp/hash testdata/file1.dat

# 複数ファイル処理
./build/record -d /tmp/hash testdata/file1.dat testdata/file2.txt testdata/file3.sh

# エラーケース確認（存在しないファイル）
./build/record -d /tmp/hash testdata/file1.dat nonexistent.dat testdata/file2.txt

# ヘルプメッセージ確認
./build/record -h

# テスト実行
make test

# Lint確認
make lint
```

---

## Phase 3: verify複数ファイル対応

### 概要

`cmd/verify/main.go`を修正し、複数ファイルを一度に検証できるようにする。

### タスク一覧

#### 3.1 コマンドラインパース変更

- [x] **SF-3.1**: `-file` フラグ削除と位置引数受け取り実装
  - 所要時間: 1時間
  - 依存: Phase 2完了
  - 詳細: `flag.Args()`で位置引数を取得、最低1つ必要
  - 実施内容: 新しい `run`/`parseArgs` フローを導入し、位置引数で任意個のファイルを受け取りつつ `-file` 指定時は警告を表示する非推奨モードとして併存させた。

- [x] **SF-3.2**: `-hash-dir` / `-d` 短縮フラグ実装
  - 所要時間: 30分
  - 依存: SF-3.1
  - 詳細: `flag.StringVar`を使用
  - 実施内容: `-hash-dir` と同じ変数に `-d` をバインドし、ヘルプの Usage 出力でも短縮形を表示するように更新した。

#### 3.2 複数ファイル処理ロジック

- [x] **SF-3.3**: 複数ファイル処理ループ実装
  - 所要時間: 1.5時間
  - 依存: SF-3.1, SF-3.2
  - 詳細: 各ファイルを順次処理、成功数と失敗数を記録
  - 実施内容: `processFiles` を新設し、`hashValidator.Verify` の結果に応じて成功/失敗をカウントするループを導入した。

- [x] **SF-3.4**: 進捗表示と結果サマリー実装
  - 所要時間: 1時間
  - 依存: SF-3.3
  - 詳細: `[1/3] file1.dat: OK` 形式で表示
  - 実施内容: `Verifying N files...` のヘッダー、`[i/n] path: OK/FAILED` ログ、および `Summary: X succeeded, Y failed` を stdout に表示するようにした。

#### 3.3 テストとエラーハンドリング

- [x] **SF-3.5**: エラーハンドリング実装
  - 所要時間: 1時間
  - 依存: SF-3.3
  - 詳細: エラー発生時も残りを処理、最後に失敗があれば exit 1
  - 実施内容: 失敗したファイルで stderr に詳細を出しつつ処理継続し、失敗数が 1 件以上なら exit code 1 を返却するロジックを実装した。

- [x] **SF-3.6**: 単体テストと統合テスト実装
  - 所要時間: 2時間
  - 依存: SF-3.3, SF-3.4, SF-3.5
  - 詳細: 正常系・異常系すべてのケースをカバー
  - 実施内容: `cmd/verify/main_test.go` を書き換え、複数ファイル成功、部分失敗継続、`-d` 利用、`-file` 警告、無効ハッシュディレクトリエラーをフェイクバリデーターで検証した。

### 成果物チェックリスト

- [x] 位置引数で複数ファイルを受け取れる
- [x] `-hash-dir` / `-d` 短縮フラグが実装されている
- [x] 各ファイルの検証結果が表示される
- [x] 最終サマリーが表示される
- [x] エラーハンドリングが適切
- [x] 単体テストと統合テストがすべてパスする
- [x] `make test` がパスする
- [x] `make lint` がパスする

### 検証基準

```bash
# ビルド確認
make build

# 単一ファイル検証
./build/verify -d /tmp/hash testdata/file1.dat

# 複数ファイル検証
./build/verify -d /tmp/hash testdata/file1.dat testdata/file2.txt testdata/file3.sh

# エラーケース確認（ハッシュが一致しないファイル）
./build/verify -d /tmp/hash testdata/file1.dat modified.dat testdata/file2.txt

# ヘルプメッセージ確認
./build/verify -h

# テスト実行
make test

# Lint確認
make lint
```

---

## Phase 4: ドキュメントと最終調整

### 概要

ドキュメントを更新し、最終的な品質チェックとリリース準備を行う。

### タスク一覧

#### 4.1 ドキュメント更新

- [ ] **SF-4.1**: README.md更新
  - 所要時間: 1.5時間
  - 依存: Phase 1, 2, 3完了
  - 詳細: 短縮フラグと複数ファイル処理の使用例追加

- [ ] **SF-4.2**: ヘルプメッセージ最終調整
  - 所要時間: 1時間
  - 依存: SF-4.1
  - 詳細: すべてのコマンドのヘルプメッセージを統一的に整理

#### 4.2 最終テストと品質チェック

- [ ] **SF-4.3**: E2Eテスト実装と実行
  - 所要時間: 2時間
  - 依存: Phase 1, 2, 3完了
  - 詳細: すべての機能を統合したE2Eテスト

- [ ] **SF-4.4**: カバレッジ確認と改善
  - 所要時間: 1時間
  - 依存: SF-4.3
  - 詳細: テストカバレッジ ≥ 85% を達成

- [ ] **SF-4.5**: 最終レビューと調整
  - 所要時間: 2時間
  - 依存: SF-4.1 ~ SF-4.4
  - 詳細: コードレビュー、ドキュメントレビュー、最終調整

### 成果物チェックリスト

- [ ] README.mdが更新されている
- [ ] すべてのヘルプメッセージが統一されている
- [ ] E2Eテストがすべてパスする
- [ ] テストカバレッジ ≥ 85%
- [ ] すべてのテストがパスする
- [ ] すべてのlintチェックがパスする
- [ ] コードレビュー完了
- [ ] ドキュメントレビュー完了

### 検証基準

```bash
# 全テスト実行
make test

# カバレッジ確認
go test -tags test -cover ./cmd/runner
go test -tags test -cover ./cmd/record
go test -tags test -cover ./cmd/verify

# Lint確認
make lint

# ビルド確認
make build

# 手動テスト（すべてのコマンド）
./build/runner -c testdata/config.toml -n -g build
./build/record -d /tmp/hash file1.dat file2.txt
./build/verify -d /tmp/hash file1.dat file2.txt

# ヘルプメッセージ確認
./build/runner -h
./build/record -h
./build/verify -h
```

---

## 完了定義 (Definition of Done)

各Phaseは以下の条件をすべて満たした場合に完了とする。

### Phase 1 完了条件

- [ ] すべての短縮フラグが実装され、動作する
- [ ] ヘルプメッセージに短縮形が表示される
- [ ] 単体テストがすべてパスする
- [ ] `make test` がパスする
- [ ] `make lint` がパスする

### Phase 2 完了条件

- [ ] 複数ファイル処理が実装され、動作する
- [ ] `-hash-dir` / `-d` 短縮フラグが動作する
- [ ] 進捗表示とサマリーが適切に表示される
- [ ] エラーハンドリングが適切
- [ ] 単体テストと統合テストがすべてパスする
- [ ] `make test` がパスする
- [ ] `make lint` がパスする

### Phase 3 完了条件

- [x] 複数ファイル検証が実装され、動作する
- [x] `-hash-dir` / `-d` 短縮フラグが動作する
- [x] 進捗表示とサマリーが適切に表示される
- [x] エラーハンドリングが適切
- [x] 単体テストと統合テストがすべてパスする
- [x] `make test` がパスする
- [x] `make lint` がパスする

### Phase 4 完了条件

- [ ] README.mdが更新されている
- [ ] すべてのヘルプメッセージが統一されている
- [ ] E2Eテストがすべてパスする
- [ ] テストカバレッジ ≥ 85%
- [ ] すべてのテストがパスする
- [ ] すべてのlintチェックがパスする
- [ ] 最終コードレビュー完了
- [ ] 成果物がすべて完成

---

## リスク管理

### 技術的リスク

| リスクID | リスク内容 | 影響度 | 発生確率 | 対策 | 状態 |
|---------|----------|--------|---------|------|------|
| SF-R1 | flagパッケージの短縮形実装が予想と異なる | 低 | 低 | 事前に動作確認、Phase 1で早期検証 | 🟢 監視中 |
| SF-R2 | 複数ファイル処理でのエラーハンドリングが複雑 | 中 | 中 | Phase 2/3で十分なテストケース作成 | 🟢 監視中 |
| SF-R3 | テストカバレッジ目標の未達成 | 中 | 低 | 各Phaseで継続的にカバレッジ確認 | 🟢 監視中 |

### スケジュールリスク

| リスクID | リスク内容 | 影響度 | 発生確率 | 対策 | 状態 |
|---------|----------|--------|---------|------|------|
| SF-S1 | テスト実装に予想以上の時間がかかる | 中 | 中 | 各Phaseで並行してテスト実装 | 🟢 監視中 |
| SF-S2 | ドキュメント作成に予想以上の時間がかかる | 低 | 低 | テンプレートを事前準備 | 🟢 監視中 |

---

## 品質基準

### コード品質基準

| 基準 | 目標値 | 測定方法 |
|------|--------|----------|
| テストカバレッジ | ≥ 85% | `go test -cover` |
| Lintエラー | 0 | `make lint` |
| 単体テスト合格率 | 100% | `make test` |
| 統合テスト合格率 | 100% | `make test` |

### ドキュメント品質基準

- [ ] すべての短縮フラグがヘルプに記載されている
- [ ] README.mdに使用例が3つ以上ある
- [ ] エラーメッセージが分かりやすく、解決方法が示されている

---

**文書バージョン**: 1.0
**作成日**: 2025-11-17
**最終更新**: 2025-11-17
