# 短縮コマンドラインフラグと複数ファイル対応 - 要件定義

## 概要

よく使用するコマンドラインフラグに1文字の短縮エイリアスを追加し、`record`および`verify`コマンドで複数ファイルを一度に処理できるようにする。

## 背景

### 現状の課題

1. **頻繁に使用するフラグの入力が冗長**
   - `-config`、`-dry-run`、`-groups`など、頻繁に使用するフラグが長い
   - 開発・デバッグ時に入力効率が低下

2. **record/verifyコマンドの非効率性**
   - 現在は`-file`フラグで1ファイルずつ処理
   - 複数ファイルを処理する場合、コマンドを繰り返し実行する必要がある

### 目標

1. Unix標準に従った短縮フラグの提供
2. record/verifyコマンドでの複数ファイル一括処理
3. 既存機能との完全な互換性維持

## 詳細要件

### 1. runner コマンド - 短縮フラグ

#### 1.1 高優先度フラグ

| 既存フラグ | 短縮形 | 理由 |
|---------|-------|------|
| `-config` | `-c` | 最も基本的で必須のフラグ。Unix伝統的な慣習 |
| `-dry-run` | `-n` | makeやgitなど多くのツールで使用される標準的なエイリアス |
| `-groups` | `-g` | グループフィルタリングは頻繁に使用される機能 |

#### 1.2 中優先度フラグ

| 既存フラグ | 短縮形 | 理由 |
|---------|-------|------|
| `-log-level` | `-l` | デバッグ時に頻繁に変更される |
| `-quiet` | `-q` | 多くのツールで使用される標準的な静音モード |
| `-validate` | `-V` | 設定検証は開発時に頻繁に使用 |

### 2. record/verify コマンド - 複数ファイル対応

#### 2.1 現在の仕様

```bash
# record コマンド
record -file /path/to/file1.dat -hash-dir /usr/local/etc/hash

# verify コマンド
verify -file /path/to/file1.dat -hash-dir /usr/local/etc/hash
```

#### 2.2 新しい仕様

```bash
# record コマンド - 複数ファイルを一度に処理
record -hash-dir /usr/local/etc/hash file1.dat file2.txt file3.sh

# 短縮形も使用可能
record -d /usr/local/etc/hash file1.dat file2.txt file3.sh

# verify コマンド - 複数ファイルを一度に検証
verify -hash-dir /usr/local/etc/hash file1.dat file2.txt file3.sh

# 短縮形も使用可能
verify -d /usr/local/etc/hash file1.dat file2.txt file3.sh
```

#### 2.3 短縮フラグ

| 既存フラグ | 短縮形 | 理由 |
|---------|-------|------|
| `-hash-dir` | `-d` | ディレクトリ指定の一般的なエイリアス |

#### 2.4 動作要件

1. **必須パラメータ**
   - 少なくとも1つのファイルパスが指定されていること
   - ファイルパスは位置引数として受け取る

2. **処理方式**
   - 各ファイルを順次処理
   - 1つでもエラーが発生した場合は即座に失敗
   - 成功したファイル数と失敗したファイル数を報告

3. **出力形式**
   ```
   Processing 3 files...
   [1/3] file1.dat: OK
   [2/3] file2.txt: OK
   [3/3] file3.sh: OK

   Summary: 3 succeeded, 0 failed
   ```

4. **エラーハンドリング**
   - エラーが発生した場合も、可能な限り残りのファイルを処理
   - 最終的に1つでも失敗があれば終了コード1を返す
   - 各ファイルのエラー詳細を表示

### 3. 互換性要件

#### 3.1 後方互換性

- 既存の長いフラグ名はすべて維持
- 短縮形と長い形式は完全に同等
- 既存のスクリプトやドキュメントは変更不要

#### 3.2 record/verify の段階的移行

- **非推奨期間**: `-file` フラグは非推奨として警告表示（将来削除予定）
- **移行期間**: 両方の形式をサポート
  ```bash
  # 新形式（推奨）
  record -d /hash file1.dat file2.txt

  # 旧形式（非推奨警告）
  record -file file1.dat -d /hash
  ```

### 4. テスト要件

#### 4.1 runner コマンド

- [ ] 各短縮フラグが対応する長いフラグと同じ動作をする
- [ ] 短縮形と長い形式を混在させても正常動作する
- [ ] ヘルプメッセージに短縮形が表示される

#### 4.2 record コマンド

- [ ] 単一ファイル処理が正常動作する
- [ ] 複数ファイル処理が正常動作する
- [ ] すべて成功した場合の出力が正しい
- [ ] 一部失敗した場合の出力が正しい
- [ ] すべて失敗した場合の出力が正しい
- [ ] 短縮フラグ `-d` が正常動作する

#### 4.3 verify コマンド

- [ ] 単一ファイル検証が正常動作する
- [ ] 複数ファイル検証が正常動作する
- [ ] すべて成功した場合の出力が正しい
- [ ] 一部失敗した場合の出力が正しい
- [ ] すべて失敗した場合の出力が正しい
- [ ] 短縮フラグ `-d` が正常動作する

### 5. ドキュメント要件

#### 5.1 更新対象

- [ ] `README.md` - 使用例の更新
- [ ] `cmd/runner/main.go` - ヘルプメッセージ
- [ ] `cmd/record/main.go` - ヘルプメッセージ
- [ ] `cmd/verify/main.go` - ヘルプメッセージ

#### 5.2 記載内容

- 短縮フラグの一覧表
- 複数ファイル処理の使用例
- 移行ガイド（旧形式から新形式へ）

## 成功基準

1. **機能性**
   - すべての短縮フラグが正常に動作する
   - 複数ファイル処理が正常に動作する
   - 後方互換性が維持されている

2. **品質**
   - すべてのテストがパスする
   - `make lint` がパスする
   - テストカバレッジ ≥ 85%

3. **ドキュメント**
   - すべてのヘルプメッセージが更新されている
   - README.mdに使用例が記載されている

## 非機能要件

### パフォーマンス

- 複数ファイル処理でも、各ファイルの処理時間は単一ファイル処理と同等
- メモリ使用量は処理するファイル数に対して線形

### ユーザビリティ

- エラーメッセージが明確で理解しやすい
- 進捗状況が視覚的に分かりやすい
- ヘルプメッセージが簡潔で分かりやすい

### 保守性

- コードが読みやすく、保守しやすい
- テストが十分で、将来の変更に対して安全

---

**文書バージョン**: 1.0
**作成日**: 2025-11-17
**承認日**: 2025-11-17
