# コマンド実行ラッパー アーキテクチャ設計書

## 1. システム構成

### 1.1. コンポーネント図

```
+-------------------------+       +-------------------------+
|     コマンド定義ファイル    |       |                         |
|     (TOML形式)         |<----->|  コマンド実行ラッパー    |
+-------------------------+       |                         |
    ^                             +-----------+-------------+
    |                                         |
    |                                         v
    |                             +-----------+-------------+
    |                             |                         |
    |                             |   認証情報管理モジュール  |
    |                             |                         |
    |                             +-----------+-------------+
    |                                         |
    |                                         v
    |                             +-----------+-------------+
    |                             |                         |
    |                             |     セキュリティモジュール  |
    |                             |                         |
    |                             +-----------+-------------+
    |                                         |
    |                                         v
    |                             +-----------+-------------+
    |                             |                         |
    |                             |    コマンド実行エンジン   |
    |                             |                         |
    |                             +-----------+-------------+
    |                                         |
    |                                         v
    |                             +-----------+-------------+
    |                             |                         |
    |                             |    ロギングモジュール    |
    |                             |                         |
    |                             +-------------------------+
    |
+-------------------------+
|    認証情報ファイル      |
|    (.env形式)          |
+-------------------------+
```

### 1.2. コンポーネント説明

1. **コマンド定義ファイル**
   - TOML形式で記述されたコマンド実行定義
   - コマンドグループ、実行順序、権限、タイムアウトなどを定義
   - 認証情報は含まず、環境変数名のみを参照
   - テンプレート機能による設定の再利用をサポート
   - ファイル検証ルールの定義
   - 実行制御（ロック、多重実行防止）の設定

2. **コマンド実行ラッパー**
   - エントリポイント
   - コマンドライン引数のパース
   - 設定ファイルの読み込みとバリデーション
   - 各モジュールの初期化と実行フローの制御

3. **認証情報管理モジュール**
   - 認証情報ファイル（.env）の読み込みと検証
   - 認証情報のメモリ上での保護
   - 環境変数としての安全な受け渡し
   - 認証情報ファイルのパーミッションチェック
   - 認証情報の漏洩防止策の適用

4. **テンプレートエンジン**
   - テンプレートの解決と適用
   - 動的パラメータの解決
   - 自動リソース管理（テンポラリディレクトリなど）
   - テンプレート展開のデバッグ機能
     - 展開前後の設定の差分表示
     - テンプレート変数のトレース
     - テンプレート適用の検証モード

5. **実行制御モジュール**
   - コマンドの多重実行防止
   - ロックファイルの管理
   - プロセス間の排他制御
   - タイムアウト処理
   - クリーンアップ処理

6. **セキュリティモジュール**
   - ファイルの改ざん検証
   - 権限昇格の管理
   - サンドボックス環境の提供
   - コマンドのホワイトリスト検証
   - 認証情報の漏洩防止（コマンドライン引数、環境変数、ログなど）
   - ファイル検証ルールの管理

7. **コマンド実行エンジン**
   - コマンドの並列/直列実行の管理
   - 依存関係の解決
   - タイムアウト制御
   - テンプレートの展開と適用
   - ファイル検証の実行

8. **ロギングモジュール**
   - 実行ログの収集と出力
   - エラーログの管理
   - 実行結果のサマリー生成

## 2. デバッグと検証

### 2.1 テンプレートデバッグ機能

1. **展開前の検証**
   - テンプレート構文のバリデーション
   - 未定義変数の検出
   - 型チェック

2. **展開の可視化**
   - テンプレート適用前後の差分表示
   - 変数のトレース（どの値がどこから来たか）
   - テンプレートの適用経路の表示

3. **ドライラン実行**
   - 実際のコマンドを実行せずにテンプレート展開のみ実行
   - 展開結果の検証と確認

### 2.2 コマンドラインオプション

```
# テンプレート展開のデバッグ
cmd-runner --debug-template [config.toml]

# ドライラン（実際のコマンドは実行しない）
cmd-runner --dry-run [command]

# テンプレート展開の詳細なトレースを表示
cmd-runner --trace-template [command]

# 環境変数のみを表示
cmd-runner --show-env [command]
```

## 3. 実行制御フロー

### 2.1 多重実行防止
1. コマンド実行前にロックファイルの存在を確認
2. ロックファイルが存在する場合、プロセスの生存確認を実施
3. 実行中のプロセスが存在しない場合は古いロックとみなし、ロックをクリア
4. 新規ロックを取得し、プロセスIDを記録
5. コマンド実行終了後、ロックを解放

### 2.2 エラーハンドリング
- ロック取得失敗時の適切なエラーメッセージ表示
- プロセス異常終了時のロッククリーンアップ
- タイムアウト処理

## 3. データフロー

1. **初期化フェーズ**
   - コマンドライン引数のパース
   - 設定ファイルの読み込みと検証
   - ロガーの初期化
   - セキュリティコンテキストの確立

2. **実行準備フェーズ**
   - コマンド定義の読み込み
   - 依存関係の解決
   - 実行順序の決定
   - リソースの事前確保

3. **実行フェーズ**
   - コマンドの実行（グループごと）
   - 権限昇格の適用
   - タイムアウト制御
   - エラーハンドリング

4. **終了フェーズ**
   - リソースの解放
   - 実行結果の集計
   - ログの出力
   - 終了コードの設定

## 3. セキュリティアーキテクチャ

### 3.1. 認証情報保護
- 認証情報の分離管理
  - コマンド定義ファイルとは別のファイルで管理
  - パーミッションは600に制限
  - 環境変数経由でのみ値を受け渡し
- メモリ保護
  - メモリ上での認証情報の暗号化
  - 不要になったら即座にメモリからクリア
  - スワップ領域への書き込み防止
- 漏洩防止
  - コマンドライン引数として認証情報を渡さない
  - 環境変数名をマスクしてログ出力
  - プロセスリストに認証情報が表示されない仕組み

### 3.2. 権限モデル
- 最小権限の原則に基づく権限制御
- 必要なコマンドのみに特権昇格を許可
- コマンド実行ごとに権限を切り替え
- 認証情報へのアクセス制御

### 3.2. サンドボックス
- コマンドごとに分離された実行環境を提供
- ファイルシステムの制限
- ネットワークアクセスの制限
- リソース制限（CPU, メモリ）

### 3.3. 監査証跡
- すべてのコマンド実行の記録
- 実行ユーザー、タイムスタンプ、引数などの記録
- 改ざん防止のためのハッシュ値記録

## 4. エラーハンドリング

### 4.1. エラー階層
1. **設定エラー**
   - ファイル形式不正
   - 必須パラメータ不足
   - 値のバリデーションエラー

2. **実行時エラー**
   - コマンド実行失敗
   - タイムアウト
   - リソース不足

3. **セキュリティエラー**
   - 権限エラー
   - 改ざん検知
   - ホワイトリスト違反

### 4.2. リカバリ戦略
- 自動リトライ（設定可能）
- クリーンアップ処理の保証
- 安全な状態への復帰

## 5. パフォーマンス考慮事項

### 5.1. 並列処理
- コマンドグループ内での並列実行
- リソース競合の回避
- スロットリングの実装

### 5.2. リソース管理
- メモリ使用量の制限
- ファイルディスクリプタの管理
- ゴルーチンのリーク防止

## 6. 拡張性

### 6.1. プラグインアーキテクチャ
- カスタムコマンドタイプの追加
- 認証/認可プロバイダーの差し替え
- ロギングバックエンドの変更

### 6.2. 設定の継承とオーバーライド
- グローバル設定
- 環境ごとの設定
- コマンドラインオプションによる上書き
