# 実装計画書：ハイブリッドハッシュファイル名エンコーディング

## 1. 既存コードとの関係分析

### 1.1. 既存コードベース分析結果

- **HashFilePathGetter インターフェース**: `internal/filevalidator/validator.go:42-45` で既に定義済み
- **ProductionHashFilePathGetter**: `internal/filevalidator/validator.go:47-61` で既存実装済み（SHA256ベース）
- **Hash関連エラー**: `internal/filevalidator/errors.go` で定義済み
- **ロガー**: `internal/runner/audit/logger.go` で slog ベースのロガーが存在
- **FileSystem**: `internal/verification/types.go` および関連ファイルで抽象化済み

### 1.2. 重複回避戦略

1. **HashFilePathGetter インターフェースを再利用**（新規定義しない）
2. **既存エラータイプを拡張**（完全に新規作成しない）
3. **slog ベースのロガーを利用**（独自ロガーインターフェースを定義しない）
4. **既存のファイルシステム抽象化を使用**

### 1.3. 実装戦略

1. **段階的実装**: 破壊的変更を最小限に抑制
2. **後方互換性**: テスト環境での互換性維持
3. **セキュリティ優先**: プロダクション環境のセキュリティ最大化
4. **品質保証**: 包括的なテストと検証

## 2. 段階的実装計画

### ✅ 完了したフェーズ: エンコーディングコア機能（シンプル化版）

#### ✅ 1.1. エンコーディングパッケージ基盤作成
- **場所**: `internal/filevalidator/encoding/`
- **実装済みファイル**:
  - `substitution_hash_escape.go` - メインエンコーダー（最適化済み）
  - `encoding_result.go` - Result構造体
  - `errors.go` - エラータイプ定義
- **特徴**:
  - パス検証の厳格化（正規化済み絶対パスのみ受け付け）
  - シングルパス最適化済み
  - 分析機能は削除（シンプル化）

#### ✅ 1.2. 基本エンコード関数実装
- **実装済み機能**:
  - `Encode()` - エラー処理付きエンコード関数
  - `Decode()` - エラー処理付きデコード関数
  - `encodeOptimized()` - シングルパス最適化エンコード
  - `decodeOptimized()` - シングルパス最適化デコード
- **特徴**:
  - エラーハンドリングの強化
  - パフォーマンス最適化
  - セキュリティ重視の入力検証

#### ✅ 1.3. フォールバック機能実装
- **実装済み機能**:
  - `EncodeWithFallback()` - ハイブリッド機能の中核
  - `generateSHA256Fallback()` - SHA256フォールバック
  - `IsNormalEncoding()` / `IsFallbackEncoding()` - 判定機能
- **特徴**:
  - 長いパス自動検出
  - SHA256フォールバック常時有効
  - Result構造体による詳細情報提供

### 将来のフェーズ（当面実装しない）

#### ❌ 削除されたフェーズ 2: HybridHashFilePathGetter 実装
- **理由**: 実装が複雑すぎるため、コアエンコーディング機能に集中
- **代替**: 必要に応じて将来的に実装可能

#### ❌ 削除されたフェーズ 3: MigrationHashFilePathGetter 実装
- **理由**: 移行機能は複雑で当面不要
- **代替**: 手動移行が必要な場合は別途検討

#### ❌ 削除されたフェーズ 4: 分析・デバッグ機能
- **理由**: シンプル化のため分析機能は削除
- **代替**: 基本的なログ出力で十分

### 次のフェーズ: テスト強化とドキュメント

#### [ ] 2.1. テストカバレッジ向上
- **場所**: `internal/filevalidator/encoding/substitution_hash_escape_test.go`
- **強化項目**:
  - エラーケースの網羅
  - 境界値テスト
  - ラウンドトリップテスト
- **戦略**: 既存実装の品質保証を最優先

#### [ ] 2.2. パフォーマンス検証
- **ベンチマークテスト実装**
- **メモリ使用量測定**
- **パフォーマンス回帰検出**
- **戦略**: 最適化済み実装の効果測定

#### [ ] 2.3. ドキュメント整備
- **コード内ドキュメント完備**
- **使用例とベストプラクティス**
- **エラーハンドリングガイド**
- **戦略**: 実装の安全な利用促進

## 3. 実装の詳細事項

### 3.1. 実装済みの主要コンポーネント

```go
// 新規パッケージ
package encoding

// 構造体ベースの実装（シンプル化）
type SubstitutionHashEscape struct{}

// 主要関数（エラー処理付き）
func (e *SubstitutionHashEscape) Encode(path string) (string, error)
func (e *SubstitutionHashEscape) Decode(encoded string) (string, error)
func (e *SubstitutionHashEscape) EncodeWithFallback(path string) Result

// 結果構造体
type Result struct {
    EncodedName    string
    IsFallback     bool
    OriginalLength int
    EncodedLength  int
}
```

### 3.2. 実装済みエラータイプ

```go
// errors.go で定義済み
var (
    ErrEmptyPath = errors.New("empty path")
    ErrNotAbsoluteOrNormalized = errors.New("path is not absolute or normalized")
)

type ErrInvalidPath struct {
    Path string
    Err  error
}

type ErrFallbackNotReversible struct {
    EncodedName string
}
```

### 3.3. 実装における主な改善点

- **パス検証の厳格化**: 正規化済み絶対パスのみ受け付け
- **シングルパス最適化**: エンコード・デコードを1回のループで実行
- **エラーハンドリング強化**: 詳細なエラー情報提供
- **分析機能削除**: シンプル化のため複雑な分析機能は削除

## 4. テスト戦略

### 4.1. ユニットテスト
- **各関数の単体テスト**
- **エラーケースの網羅**
- **境界値テスト**

### 4.2. 統合テスト
- **既存Validatorとの結合**
- **ファイルシステム操作**
- **移行シナリオ**

### 4.3. パフォーマンステスト
- **エンコード・デコード速度**
- **メモリ使用量**
- **大量ファイル処理**

### 4.4. プロパティベーステスト
- **エンコード/デコードの可逆性**
- **決定論的動作**
- **ユニークネス保証**

## 5. リスク管理

### 5.1. 技術的リスク
- **既存システムとの互換性**: 段階的移行で対応
- **パフォーマンス劣化**: ベンチマークテストで監視
- **エッジケース**: 豊富なテストケースで対応

### 5.2. 移行リスク
- **データ損失**: バックアップ機能を強制実装
- **ダウンタイム**: 手動移行のみサポート
- **ロールバック**: 既存ファイルの保持

## 6. 成功基準

### 6.1. 実装済み機能要件
- [x] **コアエンコーディング機能**: Encode/Decode関数の実装
- [x] **SHA256フォールバック機能**: 長いパス自動検出・フォールバック
- [x] **エンコード/デコードの可逆性**: 通常エンコードの完全可逆性
- [x] **パス検証の厳格化**: 正規化済み絶対パスのみサポート

### 6.2. 実装済み品質要件
- [x] **エラーハンドリング強化**: 詳細なエラー情報とWrap対応
- [x] **パフォーマンス最適化**: シングルパス最適化済み
- [x] **コード品質**: リンターエラー解消
- [x] **シンプル化**: 複雑な分析機能削除

### 6.3. 今後の要件
- [ ] **テストカバレッジ向上**: 90% 以上
- [ ] **ベンチマークテスト実装**: パフォーマンス測定
- [ ] **ドキュメント完備**: 使用例とベストプラクティス
- [ ] **統合テスト**: 実際の使用シナリオでの検証

## 7. 実装状況とその後の方針

### 7.1. 実装完了事項
- ✅ **コアエンコーディング機能**: 最適化済みエンコード・デコード実装
- ✅ **フォールバック機能**: SHA256フォールバック自動選択
- ✅ **エラーハンドリング**: 厳密なパス検証とエラー処理
- ✅ **パフォーマンス最適化**: シングルパス処理による高速化

### 7.2. 次の優先アクション
1. **テストカバレッジ向上**: 包括的なテストケース作成
2. **ベンチマークテスト**: パフォーマンス測定と検証
3. **ドキュメント整備**: 使用方法とベストプラクティス文書化
4. **統合準備**: 実際のValidatorとの統合検討

### 7.3. 長期的な方針
- **段階的な統合**: 必要に応じてHybridHashFilePathGetterを実装
- **移行サポート**: 需要に応じてMigrationHashFilePathGetterを検討
- **機能拡張**: 分析機能が必要になった場合の再実装

この計画変更により、複雑な機能を削除してコアエンコーディング機能に集中することで、実装の安定性と保守性を向上させました。
