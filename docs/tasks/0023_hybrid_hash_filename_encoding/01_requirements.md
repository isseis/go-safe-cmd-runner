# 要件定義書：ハイブリッドハッシュファイル名エンコーディング

## 1. 概要 (Overview)

**目的:** このドキュメントは、ADR「ハッシュファイル命名方式の決定」に基づく、ハイブリッド換字+ダブルエスケープ方式（#メタ文字版 + SHA256フォールバック）の実装に関する要件を定義する。

**背景:**
現在のgo-safe-cmd-runnerプロジェクトでは、ファイル整合性検証用のハッシュファイル名にSHA256ハッシュの最初の12文字を使用している。この方式には以下の問題が存在する：

1. **可読性の欠如**: ハッシュファイル名から元ファイルを特定できない
2. **デバッグの困難**: ハッシュディレクトリ内でのファイル対応関係が不明
3. **ハッシュ衝突の可能性**: 可能性は低いが、起きた場合に回避策がない（72ビット名前空間）

これらの問題を解決するため、優れた空間効率（1.00x膨張率）と完全な可逆性を持つハイブリッド換字+ダブルエスケープ方式を実装する。

## 2. 目的とスコープ (Goals and Scope)

### 2.1. 目的 (Goals)

- **空間効率の最適化**: 通常ケースで1.00x膨張率を実現し、ストレージ使用量を最小化する
- **完全な可逆性の保証**: エンコード・デコード処理の数学的可逆性を確保する
- **可読性とデバッグ性の向上**: ハッシュファイル名から元のファイルパスを特定可能にする
- **堅牢性の確保**: LinuxのNAME_MAX制限に対する自動フォールバック機能を実装する
- **後方互換性の維持**: 既存のSHA256短縮方式との段階的移行をサポートする

### 2.2. スコープ (In Scope)

- ハイブリッド換字+ダブルエスケープエンコーダーの実装
- SHA256フォールバック機能の実装
- エンコード・デコード処理の実装
- NAME_MAX制限対応（250文字制限）
- 既存システムとの移行機能
- 包括的なテストスイートの実装
- パフォーマンス測定・ベンチマーク機能

### 2.3. スコープ外 (Out of Scope)

- 既存ハッシュファイルの自動一括変換機能（手動移行のみサポート）
- Windows固有のファイル名制限への対応（260文字制限、禁止文字等）
- ハッシュディレクトリの物理的な構造変更
- 暗号化やセキュリティ機能の追加
- 他のエンコーディング方式への対応
- 設定ファイルベースの複雑な構成管理（ソースコード内定数で制御）
- 250文字を超えるパス名での100%のハッシュ衝突回避

## 3. 機能要件 (Functional Requirements)

### 3.1. 機能一覧

#### 3.1.1 基本エンコーディング機能

- **機能ID:** `F-001`
- **機能名:** 換字+ダブルエスケープエンコード
- **概要:** ファイルパスを換字（`/` ↔ `~`）+ ダブルエスケープ（#メタ文字）方式でエンコードする
- **入力:** 元ファイルパス（string）
- **出力:** エンコード済みファイル名（string）
- **処理:**
  1. `/` と `~` を入れ替え（換字）
  2. `#` を `#1` に、`/` を `##` に置換（ダブルエスケープ）

#### 3.1.2 基本デコーディング機能

- **機能ID:** `F-002`
- **機能名:** 換字+ダブルエスケープデコード
- **概要:** エンコード済みファイル名を元のファイルパスに復元する
- **入力:** エンコード済みファイル名（string）
- **出力:** 元ファイルパス（string）
- **処理:** エンコード処理の逆順実行

#### 3.1.3 ハイブリッドハッシュファイルパス生成

- **機能ID:** `F-003`
- **機能名:** ハイブリッドハッシュファイルパス生成
- **概要:** エンコード後の長さに基づいて適切な方式を選択し、ハッシュファイルパスを生成する
- **入力:** ハッシュアルゴリズム、ハッシュディレクトリ、元ファイルパス
- **出力:** ハッシュファイルパス（string）
- **処理:**
  1. 換字+ダブルエスケープを試行
  2. 結果が250文字以下の場合：そのまま使用
  3. 結果が250文字を超える場合：SHA256フォールバックに切り替え

#### 3.1.4 SHA256フォールバック機能

- **機能ID:** `F-004`
- **機能名:** SHA256フォールバック
- **概要:** 長いパスに対してSHA256ハッシュベースのファイル名を生成する
- **入力:** 元ファイルパス（string）
- **出力:** SHA256ベースファイル名（string）
- **処理:** SHA256ハッシュ12文字 + ".json" で拡張子付きファイル名を生成

#### 3.1.5 フォールバック識別機能

- **機能ID:** `F-005`
- **機能名:** フォールバック識別
- **概要:** ハッシュファイル名からエンコード方式を識別する
- **入力:** ハッシュファイル名（string）
- **出力:** 通常エンコード／フォールバックの判定（boolean）
- **処理:** 先頭文字による判定（`~` = 通常エンコード、`~` 以外 = SHA256フォールバック）

#### 3.1.6 移行サポート機能

- **機能ID:** `F-006`
- **機能名:** 既存システムとの移行サポート（手動のみ）
- **概要:** ハイブリッド方式とSHA256方式のハッシュファイルを手動で段階的に移行する
- **入力:** 元ファイルパス（string）
- **出力:** 有効なハッシュファイルパス（string）
- **処理:**
  1. ハイブリッド方式のハッシュファイル存在確認
  2. 存在しない場合、SHA256方式のハッシュファイル確認
  3. どちらも存在しない場合、ハイブリッド方式で作成
  4. 移行は手動でのみ実行（自動移行機能は提供しない）

### 3.2. API仕様

#### 3.2.1 SubstitutionHashEscape構造体

```go
type SubstitutionHashEscape struct{}

// Encode encodes a file path using substitution + double escape method
func (e *SubstitutionHashEscape) Encode(path string) string

// Decode decodes an encoded filename back to original file path
func (e *SubstitutionHashEscape) Decode(encoded string) string

// GetHashFilePath generates hash file path with hybrid approach
func (e *SubstitutionHashEscape) GetHashFilePath(
    hashAlgorithm HashAlgorithm,
    hashDir string,
    filePath common.ResolvedPath) (string, error)

// DecodeHashFileName decodes hash filename to original path if possible
func (e *SubstitutionHashEscape) DecodeHashFileName(hashFileName string) (originalPath string, isFallback bool, err error)
```

#### 3.2.2 HybridHashFilePathGetter構造体

```go
type HybridHashFilePathGetter struct {
    encoder *SubstitutionHashEscape
    sha256Getter *SHA256HashFilePathGetter
}

// GetHashFilePath implements HashFilePathGetter interface
func (h *HybridHashFilePathGetter) GetHashFilePath(
    hashAlgorithm HashAlgorithm,
    hashDir string,
    filePath common.ResolvedPath) (string, error)
```

## 4. 非機能要件 (Non-Functional Requirements)

### 4.1. 性能 (Performance)

- **エンコード処理速度**: 10,000パス/秒以上の処理性能を維持する
- **メモリ使用量**: エンコード・デコード処理でのメモリ使用量を最小化する
- **空間効率**: 通常ケースで1.00x膨張率を実現する（99%以上のファイルで達成）
- **フォールバック効率**: フォールバック時でもFILE_MAX文字以内に収める

### 4.2. セキュリティ (Security)

- **情報漏洩防止**: エンコード処理でセンシティブ情報を漏洩しない
- **入力検証**: 不正な入力に対して適切なエラーハンドリングを行う
- **可逆性保証**: エンコード・デコード処理の完全な可逆性を数学的に保証する

### 4.3. 信頼性・可用性 (Reliability/Availability)

- **エラーハンドリング**: すべてのエラーケースで適切なエラーメッセージを提供する
- **境界値処理**: NAME_MAX制限での正確な動作を保証する
- **衝突回避**: 通常エンコーディング使用時に、異なるパスが同じハッシュファイル名を生成しないことを保証する

### 4.4. 互換性 (Compatibility)

- **プラットフォーム**: Linux/Unix系システムで動作する
- **Go言語**: Go 1.18以上でビルド・動作する
- **既存システム**: 現在のValidator実装と互換性を保つ
- **ファイルシステム**: ext4、XFS、Btrfs等の主要LinuxファイルシステムでNAME_MAX制限内で動作する

### 4.5. 保守性 (Maintainability)

- **コード品質**: Goの標準的なコーディング規約に従う
- **テスト充実**: 包括的なユニットテスト・統合テストを提供する
- **ドキュメント**: 実装の詳細仕様とAPIドキュメントを整備する
- **ログ出力**: フォールバック使用時の適切なログ出力を提供する

## 5. 制約条件 (Constraints)

### 5.1. 技術的制約

- **使用言語**: Go言語（既存コードベースとの統一）
- **外部ライブラリ**: 標準ライブラリのみ使用、外部依存関係の追加は行わない
- **ファイル名長制限**: LinuxのNAME_MAX制限（通常255文字）に対応する
- **既存API**: 現在のHashFilePathGetterインターフェースとの互換性を維持する

### 5.2. 運用制約

- **段階的移行**: 既存システムから新システムへの手動による段階的移行をサポートする
- **後方互換性**: 既存のハッシュファイルを引き続き読み込み可能にする
- **パフォーマンス影響**: 既存システムのパフォーマンスに悪影響を与えない
- **設定管理**: 複雑な設定ファイルは使用せず、ソースコード内定数で制御する

### 5.3. 設計制約

- **単純性原則**: 複雑な実装を避け、理解しやすいコードとする
- **テスト可能性**: 各機能が独立してテスト可能な設計とする
- **拡張可能性**: 将来的な機能追加に対応可能な設計とする

## 6. テスト要件 (Test Requirements)

### 6.1. ユニットテスト

- **エンコード・デコードテスト**: すべてのエッジケースでの可逆性検証
- **境界値テスト**: NAME_MAX制限周辺での動作確認
- **フォールバックテスト**: 長いパスでの自動切り替え動作確認
- **エラーハンドリングテスト**: 不正入力に対する適切なエラー処理確認

### 6.2. 統合テスト

- **Validator統合テスト**: 既存Validatorとの統合動作確認
- **移行機能テスト**: 旧システムから新システムへの移行動作確認
- **ファイルシステムテスト**: 実際のファイルシステムでの動作確認

### 6.3. プロパティベーステスト

- **可逆性テスト**: 任意の入力での完全な可逆性検証
- **一意性テスト**: 異なる入力が異なる出力を生成することの検証
- **長さ制約テスト**: エンコード後の長さが期待値内であることの検証

### 6.4. パフォーマンステスト

- **ベンチマークテスト**: エンコード・デコード処理の性能測定
- **膨張率測定**: 実世界データでの空間効率測定
- **大量データテスト**: 大量ファイルでのメモリ使用量・処理速度測定

## 7. 用語集 (Glossary)

- **換字 (Substitution)**: 特定の文字を別の文字に一対一で置き換える処理（この場合 `/` ↔ `~`）
- **ダブルエスケープ (Double Escape)**: メタ文字を使った二段階エスケープ処理（`#` → `#1`, `/` → `##`）
- **ハイブリッド方式**: 通常のエンコーディングとSHA256フォールバックを組み合わせた方式
- **NAME_MAX**: Linuxファイルシステムでの単一ファイル名の最大長制限（通常255文字）
- **膨張率 (Expansion Ratio)**: エンコード後の文字数 ÷ 元の文字数
- **フォールバック**: 通常処理が制限に達した場合の代替処理
- **可逆性 (Reversibility)**: エンコード→デコード処理で元の値を完全に復元できる性質
- **HashFilePathGetter**: ハッシュファイルパス生成のための既存インターフェース

## 8. 受け入れ基準 (Acceptance Criteria)

### 8.1. 機能受け入れ基準

- [ ] 通常ケース（250文字以下）で1.00x膨張率を実現
- [ ] 長いパス（250文字超）で自動的にSHA256フォールバックに切り替わる
- [ ] エンコード・デコードの完全な可逆性を持つ
- [ ] 通常エンコーディングにおいては、異なるファイルパスが異なるハッシュファイル名を生成する
- [ ] 既存のValidator実装と統合できる

### 8.2. 品質受け入れ基準

- [ ] すべてのユニットテストがパスする（カバレッジ95%以上）
- [ ] プロパティベーステストで可逆性が検証される
- [ ] ベンチマークテストでパフォーマンス要件を満たす
- [ ] 静的解析（golint、go vet）でエラーが発生しない

### 8.3. 統合受け入れ基準

- [ ] 既存システムとの段階的移行が動作する
- [ ] 実際のファイルシステムで正常に動作する
- [ ] エラー時に適切なログ出力が行われる
- [ ] メモリリークやデッドロックが発生しない
