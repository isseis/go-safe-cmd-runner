# GroupExecutor リファクタリング - 要件定義書

## 1. プロジェクト概要

### 1.1 目的

`NewDefaultGroupExecutor` 関数の引数が11個と非常に多く、保守性と可読性に問題があることから、Functional Options パターンを採用してリファクタリングを行う。

### 1.2 背景

現在の `NewDefaultGroupExecutor` 関数は以下の問題を抱えている：

1. **引数の数が多すぎる（11個）**: 可読性が低く、メンテナンスが困難
2. **関連する引数のグループ化がない**: dry-run 関連の3つの引数がバラバラ
3. **デフォルト値が存在するのに毎回指定が必要**: 特にテストコードで冗長
4. **プロダクションコードで常に同じ値を設定する引数がある**: `notificationFunc`
5. **テストでのボイラープレートコードが多い**: 固定値を毎回指定

### 1.3 スコープ

#### 対象範囲

- `NewDefaultGroupExecutor` 関数のシグネチャ変更
- Functional Options パターンの実装
- テスト用ヘルパー関数の追加
- 既存の全コールサイトの更新（プロダクションコード1箇所、テストコード22箇所）

#### 対象外

- `DefaultGroupExecutor` 構造体自体の変更
- 既存の機能の変更や削除
- パフォーマンスの最適化

## 2. 機能要件

### 2.1 新しいインターフェース要件

#### FR-1: Functional Options パターンの採用

**要件**: Functional Options パターンを使用して、必須引数は位置引数、オプション引数は可変長引数で受け取る。

**詳細**:
- 必須引数: `executor`, `config`, `validator`, `verificationManager`, `resourceManager`, `runID`
- オプション引数: `notificationFunc`, dry-run関連設定, `keepTempDirs`

#### FR-2: デフォルト値の提供

**要件**: オプション引数にはすべて適切なデフォルト値を提供する。

**デフォルト値**:
- `notificationFunc`: `nil` （通知なし）
- dry-run関連: 無効化（`isDryRun: false`）
- `keepTempDirs`: `false`

#### FR-3: 既存の型の再利用

**要件**: 既存の `resource.DryRunOptions` 型を再利用して、コードベース全体での一貫性を保つ。

#### FR-4: 後方互換性の保持

**要件**: 段階的移行をサポートし、移行期間中は既存コードが動作し続ける。

### 2.2 テスト用ヘルパー関数要件

#### FR-5: 基本ヘルパー関数

**要件**: テストで最も頻繁に使用されるパターンのための簡潔なヘルパー関数を提供する。

**シグネチャ**:
```go
NewTestGroupExecutor(
    config *runnertypes.ConfigSpec,
    resourceManager resource.ResourceManager,
    options ...GroupExecutorOption,
) *DefaultGroupExecutor
```

#### FR-6: カスタマイズ可能なヘルパー関数

**要件**: 特定の引数をカスタマイズしたい場合のためのヘルパー関数を提供する。

### 2.3 Option 関数要件

#### FR-7: WithNotificationFunc オプション

**要件**: 通知関数を設定するオプション関数を提供する。

#### FR-8: WithDryRun オプション

**要件**: dry-run モードを設定するオプション関数を提供する。`resource.DryRunOptions` を受け取る。

#### FR-9: WithKeepTempDirs オプション

**要件**: 一時ディレクトリを保持するかを設定するオプション関数を提供する。

## 3. 非機能要件

### 3.1 パフォーマンス要件

#### NFR-1: パフォーマンスの非劣化

**要件**: リファクタリング後のパフォーマンスは現在と同等以上を維持する。

**基準**:
- 関数呼び出しのオーバーヘッドは10%以内
- メモリ使用量の増加は5%以内

### 3.2 保守性要件

#### NFR-2: 可読性の向上

**要件**: 新しいインターフェースは現在より可読性が高い。

**基準**:
- オプション名が明示的で、何を設定しているか一目で分かる
- テストコードにおける GroupExecutor 初期化処理の行数が30-40%削減される

#### NFR-3: 拡張性の確保

**要件**: 将来の新しいオプション追加が容易である。

**基準**:
- 新しいオプション追加時に既存コードへの影響が最小限
- 後方互換性を保ちながら機能追加が可能

### 3.3 品質要件

#### NFR-4: テストカバレッジの維持

**要件**: 既存のテストカバレッジを維持する。

**基準**: 現在のテストカバレッジ以上を維持

#### NFR-5: エラーハンドリングの改善

**要件**: 不正な設定に対する適切なエラーハンドリングを提供する。

## 4. 制約条件

### 4.1 技術的制約

#### TC-1: Go バージョン

**制約**: Go 1.19 以上で動作する。

#### TC-2: 既存の依存関係

**制約**: 新たな外部依存関係は追加しない。

#### TC-3: パッケージ構造

**制約**: 既存のパッケージ構造を大きく変更しない。

### 4.2 移行制約

#### TC-4: 段階的移行

**制約**: すべての変更は段階的に行い、各段階で動作確認が可能であること。

#### TC-5: テスト継続性

**制約**: 移行期間中も既存のテストが継続して動作すること。

## 5. 成功基準

### 5.1 定量的基準

#### SC-1: 引数数の削減

**基準**: 関数の引数数を11個から6個（必須）+ 可変長（オプション）に削減する。

#### SC-2: テストコードの簡潔化

**基準**: テストコードの行数を30-40%削減する。

#### SC-3: 移行完了率

**基準**:
- プロダクションコード: 100%（1箇所）
- テストコード: 100%（22箇所）

### 5.2 定性的基準

#### SC-4: 可読性の向上

**基準**: コードレビューにおいて、可読性の向上が確認される。

#### SC-5: 開発者体験の向上

**基準**: 新しいテストを書く際の学習コストが削減される。

#### SC-6: 拡張性の確保

**基準**: 新しいオプション追加のシミュレーションで、既存コードへの影響が最小限であることが確認される。

## 6. リスク管理

### 6.1 技術的リスク

#### R-1: デフォルト値の不一致

**リスク**: 新しい実装のデフォルト値が既存の動作と異なる。

**対策**:
- 既存の動作を詳細に分析し、テストで比較検証
- 段階的移行により早期発見

**影響度**: 中
**発生確率**: 低

#### R-2: Option 関数の誤実装

**リスク**: Option 関数の実装に誤りがあり、期待した設定が適用されない。

**対策**:
- 各 Option 関数に対する徹底的なユニットテスト
- 統合テストでの動作確認

**影響度**: 高
**発生確率**: 低

### 6.2 スケジュールリスク

#### R-3: 移行期間の長期化

**リスク**: テストコードの移行が予想より時間がかかる。

**対策**:
- 自動化ツールの使用検討
- 並行作業による効率化

**影響度**: 中
**発生確率**: 中

### 6.3 品質リスク

#### R-4: リグレッションの発生

**リスク**: リファクタリングにより既存機能に不具合が発生。

**対策**:
- 既存テストの継続実行
- 追加的なリグレッションテスト実装

**影響度**: 高
**発生確率**: 低

## 7. 受け入れテスト基準

### 7.1 機能テスト

#### AT-1: 基本機能テスト

**テスト内容**:
- 新しいインターフェースで `DefaultGroupExecutor` が正常に作成される
- すべてのオプションが正しく設定される
- デフォルト値が正しく適用される

#### AT-2: 互換性テスト

**テスト内容**:
- 既存のプロダクションコードが新しいインターフェースで正常動作する
- 既存のテストコードがヘルパー関数で正常動作する

### 7.2 パフォーマンステスト

#### AT-3: パフォーマンス回帰テスト

**テスト内容**:
- 関数呼び出しのレスポンス時間が既存実装の110%以内
- メモリ使用量が既存実装の105%以内

### 7.3 セキュリティテスト

#### AT-4: セキュリティ設定テスト

**テスト内容**:
- セキュリティ関連の設定（validator など）が正しく適用される
- 不正な設定に対して適切にエラーが発生する

## 8. 前提条件・仮定

### 8.1 前提条件

1. Go 1.19 以上の開発環境が利用可能
2. 既存のテストスイートが正常に動作している
3. コードレビューおよび品質管理プロセスが確立されている

### 8.2 仮定

1. 現在のテストコードは適切に動作を検証している
2. プロダクションコードでの使用パターンは大きく変わらない
3. 新しいオプション追加の頻度は低い（年1-2回程度）

## 9. 承認・レビュー

### 9.1 関係者

- **プロジェクトオーナー**: [名前]
- **アーキテクト**: [名前]
- **開発チームリード**: [名前]
- **品質保証責任者**: [名前]

### 9.2 承認基準

1. すべての機能要件が満たされている
2. 非機能要件が満たされている
3. リスクが適切に管理されている
4. 受け入れテスト基準が明確に定義されている

---

**文書バージョン**: 1.0
**作成日**: 2025-10-27
**承認日**: [日付]
**次回レビュー予定**: [日付]
