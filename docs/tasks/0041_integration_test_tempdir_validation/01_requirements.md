# 要件定義書：統合テストにおける一時ディレクトリ検証の強化

## 1. 概要 (Overview)

**目的:** このドキュメントは、`TestIntegration_TempDirHandling` 統合テストにおける一時ディレクトリ処理の検証機能を強化する要件を定義する。

**背景:**

現在の `cmd/runner/integration_workdir_test.go` の `TestIntegration_TempDirHandling` テストは、一時ディレクトリ処理機能の統合テストとして実装されているが、以下の問題がある：

1. **未使用フィールド**: `expectTempDir` フィールドが定義されているが使用されていない
2. **不完全な検証**: 一時ディレクトリの作成・削除が実際に行われているかを確認していない
3. **副作用の未検証**: `keepTempDirs` フラグの効果が検証されていない

これらの問題により、統合テストとしての価値が低下しており、実際のバグを見逃す可能性がある。

## 2. 目的とスコープ (Goals and Scope)

### 2.1. 目的 (Goals)

- 一時ディレクトリの作成・削除が正しく行われることを統合テストで検証する
- `keepTempDirs` フラグが正しく動作することを確認する
- コマンド出力から `__runner_workdir` の値を抽出し、実際のディレクトリ存在を確認する

### 2.2. スコープ (In Scope)

- `TestIntegration_TempDirHandling` テストの改善
- コマンド出力のキャプチャ機能の追加
- 一時ディレクトリの存在確認ロジックの実装
- `expectTempDir` フィールドの活用
- テストケースの拡充（必要に応じて）

### 2.3. スコープ外 (Out of Scope)

- 他の統合テストの変更（必要性が明確になった場合を除く）
- ユニットテストレベルの詳細な動作検証（既存のユニットテストで対応済み）
- パフォーマンステスト
- Windows環境での一時ディレクトリパーミッション検証

## 3. 機能要件 (Functional Requirements)

### 3.1. 機能一覧

#### F-001: コマンド出力のキャプチャ

- **機能ID:** `F-001`
- **機能名:** コマンド出力のキャプチャ
- **概要:** 統合テスト内でコマンドの標準出力・標準エラー出力をキャプチャできる
- **詳細要件:**
  - `ResourceManager` に出力キャプチャ機能を統合する
  - テスト実行後に出力内容を取得できる
  - 既存の `internal/runner/output` パッケージを活用する

#### F-002: __runner_workdir 値の抽出

- **機能ID:** `F-002`
- **機能名:** `__runner_workdir` 変数値の抽出
- **概要:** キャプチャした出力から `__runner_workdir` の実際の値を抽出する
- **詳細要件:**
  - 正規表現またはパターンマッチングで出力をパースする
  - 複数のコマンドが実行される場合、各コマンドのワークディレクトリを識別できる
  - パース失敗時には明確なエラーメッセージを提供する

#### F-003: 一時ディレクトリの存在確認

- **機能ID:** `F-003`
- **機能名:** 一時ディレクトリの存在確認
- **概要:** 抽出したパスのディレクトリが実際に存在するかを確認する
- **詳細要件:**
  - `os.Stat()` を使用してディレクトリの存在を確認する
  - シンボリックリンクを適切に処理する
  - パーミッションエラーと存在しないエラーを区別する

#### F-004: クリーンアップ後の検証

- **機能ID:** `F-004`
- **機能名:** クリーンアップ後の一時ディレクトリ状態検証
- **概要:** `CleanupAllResources()` 実行後、`keepTempDirs` フラグに応じてディレクトリが削除または保持されることを確認する
- **詳細要件:**
  - `keepTempDirs=false` の場合、一時ディレクトリが削除される
  - `keepTempDirs=true` の場合、一時ディレクトリが保持される
  - 固定ワークディレクトリの場合、削除されない（そもそも作成されていない）

#### F-005: expectTempDir フィールドの活用

- **機能ID:** `F-005`
- **機能名:** `expectTempDir` フィールドによる検証制御
- **概要:** テストケースごとに一時ディレクトリの作成有無を `expectTempDir` で制御し、検証する
- **詳細要件:**
  - `expectTempDir=true`: 一時ディレクトリが作成されることを期待する
  - `expectTempDir=false`: 一時ディレクトリが作成されないことを期待する（固定ワークディレクトリの場合）
  - 期待値と実際の動作が一致することを確認する

## 4. 非機能要件 (Non-Functional Requirements)

### 4.1. 性能 (Performance)

- 統合テストの実行時間が現在から大幅に増加しない（+30%以内を目安）
- 出力キャプチャによるオーバーヘッドを最小限にする

### 4.2. セキュリティ (Security)

- 一時ディレクトリのパス検証時、パストラバーサル攻撃を防止する
- テスト用の一時ディレクトリが適切なパーミッションで作成される（0700）

### 4.3. 信頼性・可用性 (Reliability/Availability)

- テストが非決定的な結果を返さないこと（flaky test の回避）
- 並列実行時のディレクトリ名衝突を防ぐ（テストごとに一意な名前を使用）
- テスト失敗時も一時ディレクトリをクリーンアップする（defer による保証）

### 4.4. 互換性 (Compatibility)

- Linux/Unix 環境で動作すること
- Go 1.23.10 以上でビルド・実行できること
- 既存の `stretchr/testify` テストフレームワークと整合性を保つ

### 4.5. 保守性 (Maintainability)

- テストコードは明確でわかりやすい構造を持つ
- テスト失敗時のエラーメッセージが診断に役立つ
- 既存のテストパターンと一貫性を保つ

## 5. 制約条件 (Constraints)

### 5.1. 技術的制約

- 使用言語は Go 1.23.10
- テストフレームワークは `stretchr/testify` を使用
- 既存の `internal/runner/output` パッケージのインターフェースを利用
- `internal/runner/resource` パッケージの出力キャプチャ機能を活用

### 5.2. 設計制約

- 既存の統合テスト構造を大きく変更しない
- ユニットテストとの責務の重複を避ける（統合テストでしか検証できない内容に焦点を当てる）
- dry-run モードのテスト (`TestIntegration_DryRunWithTempDir`) は別テストとして維持

### 5.3. プロジェクト制約

- Task 0034（workdir redesign）の一部として実装
- 実装はフェーズ 4（テスト）の範囲内
- TDD（Test-Driven Development）アプローチに従う

## 6. テスト要件 (Test Requirements)

### 6.1. テストケース

以下のシナリオをカバーする：

| テストケース | 説明 | `keepTempDirs` | `expectTempDir` | 期待される動作 |
|------------|------|---------------|----------------|--------------|
| TC-001 | 自動一時ディレクトリ（クリーンアップあり） | `false` | `true` | 一時ディレクトリが作成され、クリーンアップ後に削除される |
| TC-002 | 自動一時ディレクトリ（保持） | `true` | `true` | 一時ディレクトリが作成され、クリーンアップ後も保持される |
| TC-003 | 固定ワークディレクトリ | `false` | `false` | 一時ディレクトリは作成されず、固定パスが使用される |

### 6.2. 検証ポイント

各テストケースで以下を検証する：

1. **実行前**: テスト開始時点で一時ディレクトリが存在しない
2. **実行中**: コマンド実行が成功する
3. **出力解析**: `__runner_workdir` の値を出力から抽出できる
4. **クリーンアップ前**: 抽出したパスのディレクトリが存在する（`expectTempDir=true` の場合）
5. **クリーンアップ後**: `keepTempDirs` フラグに応じてディレクトリが削除/保持される

### 6.3. エラーハンドリング

以下のエラーケースを適切に処理する：

- 出力のパースに失敗した場合
- ディレクトリの存在確認でエラーが発生した場合
- クリーンアップに失敗した場合

## 7. 成功基準 (Success Criteria)

以下の条件をすべて満たすことで、本要件が達成されたとみなす：

1. **機能要件の充足**: F-001 ～ F-005 のすべての機能が実装されている
2. **テスト実行成功**: すべてのテストケース（TC-001 ～ TC-003）が成功する
3. **コードレビュー**: Go のコーディング規約に準拠し、可読性が高い
4. **ドキュメント**: 実装内容が適切にドキュメント化されている
5. **CI/CD統合**: 既存の CI/CD パイプラインで自動実行される

## 8. 用語集 (Glossary)

- **一時ディレクトリ (Temporary Directory)**: グループ実行時に自動作成される作業ディレクトリ。`workdir` が指定されていない場合に `os.MkdirTemp()` で作成される。
- **固定ワークディレクトリ (Fixed Work Directory)**: TOML 設定の `groups.workdir` フィールドで明示的に指定されたディレクトリ。
- **`__runner_workdir`**: 実行時に自動設定される予約変数。グループまたはコマンドの実効ワークディレクトリのパスを保持する。
- **`keepTempDirs` フラグ**: コマンドラインオプション `--keep-temp-dirs` で制御されるフラグ。`true` の場合、一時ディレクトリをクリーンアップせずに保持する。
- **`expectTempDir` フィールド**: テストケース構造体のフィールド。そのテストケースで一時ディレクトリが作成されることを期待するかを示すブール値。
- **統合テスト (Integration Test)**: 複数のコンポーネントを組み合わせて動作を検証するテスト。`cmd/runner/*_test.go` に配置される。
- **出力キャプチャ (Output Capture)**: コマンドの標準出力・標準エラー出力を取得する機能。`internal/runner/output` パッケージで提供される。

## 9. 参考資料

- `cmd/runner/integration_workdir_test.go`: 現在のテスト実装
- `internal/runner/output/capture.go`: 出力キャプチャ機能
- `internal/runner/resource/normal_manager.go`: 出力キャプチャの統合実装
- `docs/tasks/0034_workdir_redesign/`: workdir redesign タスクのドキュメント
