# グループ展開時のコマンド事前展開 - 実装計画書

## 1. 概要

### 1.1 目的

グループ展開時のコマンド事前展開機能を段階的かつ安全に実装するための計画を定義する。

### 1.2 実装の目標

- **一貫性**: 検証時と実行時で同じ展開済みコマンドを使用
- **完全性**: コマンドレベル変数を検証時にも利用可能にする
- **Fail Fast**: 設定エラーを可能な限り早期に検出
- **後方互換性**: 既存の動作を維持しながら改善

### 1.3 前提条件

- Go 1.21 以上
- 既存のテストスイートがすべてパス
- `RuntimeGroup.Commands` フィールドは定義済みだが未使用

### 1.4 インターフェース変更

**重要**: この実装では**公開インターフェースの変更は行いません**。

- `preExpandCommands`は`DefaultGroupExecutor`の**非公開メソッド**として実装
- `GroupExecutor`インターフェースへのメソッド追加は不要
- `RuntimeGroup`と`RuntimeCommand`の型定義は既存のまま使用
- 外部パッケージからのAPI変更なし

## 2. 実装フェーズ

### Phase 1: コア機能の実装 (優先度: 高)

**期間**: 2-3日

**目標**: 基本的なコマンド事前展開機能を実装し、動作を確認する。

#### タスク

##### 1.1 `preExpandCommands` 関数の実装

**ファイル**: `internal/runner/group_executor.go`

**作業内容**:
- 新規メソッド `preExpandCommands` を追加
- グループ内の全コマンドを `config.ExpandCommand` で展開
- `resolveCommandWorkDir` を呼び出して `EffectiveWorkDir` を設定
- 展開済みコマンドを `runtimeGroup.Commands` に格納

**受け入れ基準**:
- [ ] 関数が正しく実装されている
- [ ] すべてのコマンドが展開される
- [ ] `EffectiveWorkDir` が正しく設定される
- [ ] エラーハンドリングが適切

**所要時間**: 4時間

##### 1.2 `ExecuteGroup` の修正

**ファイル**: `internal/runner/group_executor.go`

**作業内容**:
- `__runner_workdir` 設定後、`verifyGroupFiles` 呼び出し前に `preExpandCommands` を呼び出し
- エラーハンドリングを追加

**受け入れ基準**:
- [ ] `preExpandCommands` が適切なタイミングで呼ばれる
- [ ] エラー時にグループ実行が中断される
- [ ] エラーメッセージが適切

**所要時間**: 2時間

##### 1.3 `executeAllCommands` の修正

**ファイル**: `internal/runner/group_executor.go`

**作業内容**:
- `groupSpec.Commands` から `runtimeGroup.Commands` へループを変更
- `config.ExpandCommand` 呼び出しを削除
- `resolveCommandWorkDir` 呼び出しを削除
- 展開済みコマンドを直接使用

**受け入れ基準**:
- [ ] 展開済みコマンドが使用される
- [ ] 重複した展開処理が削除される
- [ ] 既存の実行ロジックが維持される

**所要時間**: 3時間

##### 1.4 基本単体テストの作成

**ファイル**: `internal/runner/group_executor_test.go`

**作業内容**:
- `TestPreExpandCommands_Success` の実装
- `TestPreExpandCommands_Error` の実装
- 基本的な正常系・異常系のカバレッジ

**受け入れ基準**:
- [ ] 単一コマンドのテストがパス
- [ ] 複数コマンドのテストがパス
- [ ] 変数展開エラーのテストがパス
- [ ] コードカバレッジ > 80%

**所要時間**: 4時間

**Phase 1 完了基準**:
- [ ] すべてのタスクが完了
- [ ] 既存テストがすべてパス
- [ ] 新規テストがすべてパス
- [ ] コードレビュー完了

---

### Phase 2: 検証機能の統合 (優先度: 高)

**期間**: 1-2日

**目標**: 検証フェーズで事前展開済みコマンドを使用するように変更する。

#### タスク

##### 2.1 `collectVerificationFiles` の修正

**ファイル**: `internal/verification/manager.go`

**作業内容**:
- `groupSpec.Commands` から `runtimeGroup.Commands` へループを変更
- `config.ExpandString` 呼び出しを削除
- 展開済みの `ExpandedCmd` フィールドを使用
- 空チェックを追加（`len(runtimeGroup.Commands) > 0`）
  - **注**: `NewRuntimeGroup`は`Commands`を空スライスで初期化するため、`nil`チェックは不要

**受け入れ基準**:
- [ ] 展開済みコマンドが使用される
- [ ] 重複した展開処理が削除される
- [ ] コマンドレベル変数が検証時に利用可能
- [ ] パス解決エラーのハンドリングが維持される

**推奨実装方針**:
- `runtimeGroup.Commands`を直接イテレートし、`Spec`フィールド経由で`CommandSpec`にアクセス
- `groupSpec.Commands`とのインデックス整合性に依存しない安全な実装

**所要時間**: 3時間

##### 2.2 検証関連の単体テストの更新

**ファイル**: `internal/verification/manager_test.go`

**作業内容**:
- `TestCollectVerificationFiles_UsesPreExpandedCommands` の実装
- 展開済みコマンドの使用を検証
- コマンドレベル変数のテスト
- 後方互換性のテスト（`Commands == nil`）

**受け入れ基準**:
- [ ] 展開済みコマンドの使用が検証される
- [ ] コマンドレベル変数が正しく処理される
- [ ] NULLケースが正しく処理される
- [ ] 既存のテストがすべてパス

**所要時間**: 3時間

**Phase 2 完了基準**:
- [ ] すべてのタスクが完了
- [ ] 既存テストがすべてパス
- [ ] 新規テストがすべてパス
- [ ] 検証時にコマンドレベル変数が利用可能
- [ ] コードレビュー完了

---

### Phase 3: 統合テストとドキュメント (優先度: 中)

**期間**: 2-3日

**目標**: エンドツーエンドの動作を検証し、ドキュメントを整備する。

#### タスク

##### 3.1 統合テストの作成

**ファイル**: `cmd/runner/integration_preexpand_test.go`

**作業内容**:
- コマンドレベル変数の検証時利用テスト
- Fail Fast動作のテスト
- Dry-runモード互換性のテスト
- ワークディレクトリ解決エラーのFail Fastテスト

**具体的なテストケース**:
1. `TestIntegration_PreExpand_CommandLevelVariableInVerification`
   - コマンドレベル変数を使ったファイルパスが検証時に解決される
2. `TestIntegration_PreExpand_FailFast_UndefinedVariable`
   - 未定義変数参照がグループ実行開始直後に検出される
3. `TestIntegration_PreExpand_FailFast_WorkdirResolutionError`
   - workdir解決エラーが実行前（検証前）に検出される
4. `TestIntegration_PreExpand_DryRunMode`
   - Dry-runモードでも事前展開が正常に動作する
5. `TestIntegration_PreExpand_MultipleCommands_FirstFails`
   - 複数コマンドで最初のコマンドの展開エラーが即座に検出される

**受け入れ基準**:
- [ ] コマンドレベル変数が検証時に使用される
- [ ] 展開エラーが実行前に検出される
- [ ] Dry-runモードが正常に動作する
- [ ] Workdir解決エラーが事前に検出される

**所要時間**: 6時間

##### 3.2 既存統合テストの回帰確認

**ファイル**: `cmd/runner/integration_*_test.go`

**作業内容**:
- すべての既存統合テストを実行
- 失敗したテストの原因分析
- 必要に応じて修正（動作変更による妥当な失敗の場合）

**受け入れ基準**:
- [ ] すべての統合テストがパス
- [ ] 動作変更が意図通り
- [ ] 予期しない副作用がない

**所要時間**: 4時間

##### 3.2.1 既存テストへの影響分析

**想定される動作変更**:

1. **エラー検出タイミングの変更**
   - **現状**: `collectVerificationFiles`でコマンドパス展開に失敗 → ワーニングログ出力 → スキップ
   - **変更後**: `preExpandCommands`でコマンド展開に失敗 → エラー → グループ実行中断
   - **影響**: エラーハンドリングが厳格化（Fail Fast原則）

2. **ログ出力内容の変更**
   - **現状**: 検証時にコマンドパス展開の警告ログ
   - **変更後**: 事前展開時にエラーログ（エラーとして扱う）
   - **影響**: ログレベルと内容が変更される

3. **エラーメッセージの詳細化**
   - **現状**: 実行時エラー（コマンド実行ループ中）
   - **変更後**: 事前展開エラー（コンテキスト情報が充実）
   - **影響**: エラーメッセージ文字列マッチングを使用しているテストケースへの影響

**テスト修正が必要な可能性のあるケース**:
- [ ] コマンドパス展開エラーを期待するテスト
- [ ] ログ出力内容を検証するテスト
- [ ] エラーメッセージの文字列マッチングを使用するテスト

**推奨**: エラー文字列マッチングではなく`errors.Is()`によるエラー型検証を使用

##### 3.3 ドキュメントの更新

**ファイル**: 複数

**作業内容**:
- コード内コメントの追加・更新
- CHANGELOG.md への記載
- 必要に応じてユーザードキュメントの更新

**受け入れ基準**:
- [ ] `preExpandCommands` に適切なGoDocコメント
- [ ] CHANGELOG.md に変更内容を記載
- [ ] 動作変更が明確に文書化される

**所要時間**: 3時間

**Phase 3 完了基準**:
- [ ] すべての統合テストがパス
- [ ] ドキュメントが更新される
- [ ] コードレビュー完了

---

### Phase 4: パフォーマンス最適化と最終検証 (優先度: 低)

**期間**: 1-2日

**目標**: パフォーマンスを計測・最適化し、リリース準備を完了する。

#### タスク

##### 4.1 ベンチマークテストの作成

**ファイル**: `internal/runner/group_executor_bench_test.go`

**作業内容**:
- `BenchmarkPreExpandCommands` の実装
- `BenchmarkExecuteGroupWithPreExpand` の実装
- `BenchmarkPreExpandCommands_Memory` の実装
- コマンド数のバリエーション（1, 10, 50, 100）

**受け入れ基準**:
- [ ] ベンチマークが実装される
- [ ] 期待値以内のパフォーマンス（**CPU時間のみ、ファイルシステムI/Oを除外**）
  - 10コマンド < 1ms（変数展開とメモリ操作のみ）
  - 100コマンド < 10ms（変数展開とメモリ操作のみ）
  - 1コマンドあたりのメモリ < 10KB

**計測条件の明確化**:
- `resolveCommandWorkDir`はファイルシステムアクセス（workdir存在確認）を含む
- ベンチマークでは以下の2つを分離計測：
  1. **Pure expansion**: `config.ExpandCommand`のみ（変数展開のみ）
  2. **Full preExpand**: workdir解決を含む完全な事前展開処理
- 上記の期待値は**Pure expansion**に適用
- **Full preExpand**の期待値はファイルシステムの状態に依存するため設定しない

**所要時間**: 4時間

##### 4.2 パフォーマンス計測と最適化

**作業内容**:
- ベンチマークの実行
- 変更前後の比較（`benchstat`）
- 必要に応じて最適化
- メモリプロファイリング

**受け入れ基準**:
- [ ] パフォーマンス劣化 < 5%
- [ ] メモリ使用量が妥当
- [ ] ホットパスの特定と最適化

**所要時間**: 4時間

##### 4.3 最終テストとリリース準備

**作業内容**:
- 全テストスイートの実行
- リンターの実行
- セキュリティチェック（`scripts/additional-security-checks.py`）
- リリースノートの作成

**受け入れ基準**:
- [ ] すべてのテストがパス
- [ ] リンターエラーなし
- [ ] セキュリティチェックパス
- [ ] リリースノート作成完了

**所要時間**: 3時間

**Phase 4 完了基準**:
- [ ] パフォーマンスが期待値内
- [ ] すべての品質チェックがパス
- [ ] リリース準備完了

---

## 3. スケジュール

### 3.1 全体スケジュール

```
Week 1:
  Mon-Wed: Phase 1 (コア機能の実装)
  Thu-Fri: Phase 2 (検証機能の統合)

Week 2:
  Mon-Wed: Phase 3 (統合テストとドキュメント)
  Thu-Fri: Phase 4 (パフォーマンス最適化)
```

### 3.2 マイルストーン

| マイルストーン | 日付 | 成果物 |
|--------------|------|--------|
| M1: コア機能完成 | Week 1 Wed | `preExpandCommands` 実装完了 |
| M2: 検証統合完成 | Week 1 Fri | 検証フェーズの更新完了 |
| M3: 統合テスト完成 | Week 2 Wed | 統合テスト実装完了 |
| M4: リリース準備完了 | Week 2 Fri | 全品質チェック完了 |

### 3.3 クリティカルパス

```
preExpandCommands実装 → ExecuteGroup修正 → executeAllCommands修正
  → collectVerificationFiles修正 → 統合テスト → リリース
```

**ボトルネック**:
- Phase 1の実装（他のフェーズの前提条件）
- 統合テスト（問題発見時の修正時間が不確定）

## 4. リスク管理

### 4.1 技術的リスク

#### R-001: 既存テストの予期しない失敗

**確率**: 中
**影響度**: 高

**軽減策**:
- 段階的な実装（フェーズ分割）
- 各フェーズでの既存テスト実行
- 早期の統合テスト実施

**対応策**:
- 失敗したテストの原因分析
- 必要に応じて実装の調整
- テストケースの更新（動作変更が妥当な場合）

#### R-002: パフォーマンス劣化

**確率**: 低
**影響度**: 中

**軽減策**:
- 早期のベンチマーク実装
- メモリプロファイリング
- 不要なアロケーションの削除

**対応策**:
- ホットパスの最適化
- データ構造の見直し
- 必要に応じて遅延展開の検討

#### R-003: Workdir解決タイミングの問題

**確率**: 低
**影響度**: 中

**説明**: `resolveCommandWorkDir` を事前展開フェーズに移動することで、予期しない副作用が発生する可能性。

**軽減策**:
- `resolveCommandWorkDir` の依存関係を事前確認
- 単体テストで各種ケースを網羅
- 統合テストでworkdir関連の動作を検証

**対応策**:
- 問題発生時は元のタイミングに戻す選択肢を保持
- workdir解決のみ別フェーズに分離

### 4.2 スケジュールリスク

#### R-004: 統合テストでの問題発見

**確率**: 中
**影響度**: 中

**軽減策**:
- Phase 1-2で既存テストを頻繁に実行
- 早期のスモークテスト実施
- バッファー期間の確保

**対応策**:
- Phase 4を優先度低に設定（必要に応じてスキップ可能）
- 問題箇所の特定と集中対応

### 4.3 品質リスク

#### R-005: エッジケースの見落とし

**確率**: 中
**影響度**: 中

**軽減策**:
- 包括的なテストケース設計
- コードレビューの実施
- 既存コードの挙動確認

**対応策**:
- 発見次第、テストケースを追加
- 必要に応じて実装を調整

## 5. 依存関係

### 5.1 既存コンポーネント

#### 必須依存

- `config.ExpandCommand`: コマンド展開の実装
- `config.ExpandString`: 文字列展開の実装（削除予定）
- `resolveCommandWorkDir`: 作業ディレクトリ解決
- `RuntimeGroup`: ランタイムグループ型定義
- `RuntimeCommand`: ランタイムコマンド型定義

#### オプション依存

- `verification.Manager`: 検証マネージャー
- `PathResolver`: パス解決インターフェース

### 5.2 外部依存

- Go標準ライブラリ（`context`, `fmt`, `log/slog`）
- テストフレームワーク（`testing`, `testify`）
- ベンチマークツール（`go test -bench`, `benchstat`）

## 6. 品質基準

### 6.1 コードカバレッジ

| フェーズ | カバレッジ目標 |
|---------|--------------|
| Phase 1 | > 80% |
| Phase 2 | > 85% |
| Phase 3 | > 90% |

### 6.2 テスト基準

#### 単体テスト

- [ ] すべての公開関数がテスト済み
- [ ] 正常系と異常系をカバー
- [ ] エッジケースを含む

#### 統合テスト

- [ ] コマンドレベル変数の検証時利用
- [ ] Fail Fast動作
- [ ] Dry-runモード
- [ ] Workdir解決エラー

#### 回帰テスト

- [ ] 既存の全テストがパス
- [ ] 動作変更が意図通り

### 6.3 パフォーマンス基準

| メトリクス | 閾値 |
|-----------|------|
| 10コマンド展開時間 | < 1ms |
| 100コマンド展開時間 | < 10ms |
| 1コマンドあたりのメモリ | < 10KB |
| 既存ベンチマークの劣化 | < 5% |

### 6.4 コード品質基準

- [ ] `go vet` エラーなし
- [ ] `golint` 警告なし
- [ ] `go fmt` 適用済み
- [ ] GoDocコメント記述済み
- [ ] セキュリティチェックパス

## 7. 実装チェックリスト

### 7.1 Phase 1: コア機能

- [ ] `preExpandCommands` 関数実装
- [ ] `ExecuteGroup` 修正
- [ ] `executeAllCommands` 修正
- [ ] 基本単体テスト作成
- [ ] 既存テスト実行・確認

### 7.2 Phase 2: 検証統合

- [ ] `collectVerificationFiles` 修正
- [ ] 検証関連テスト更新
- [ ] 既存テスト実行・確認

### 7.3 Phase 3: 統合テスト

- [ ] コマンドレベル変数テスト
- [ ] Fail Fastテスト
- [ ] Dry-runテスト
- [ ] Workdir解決テスト
- [ ] 既存統合テスト確認
- [ ] ドキュメント更新

### 7.4 Phase 4: 最適化

- [ ] ベンチマークテスト作成
- [ ] パフォーマンス計測
- [ ] 最適化実施
- [ ] 全テスト実行
- [ ] リンター実行
- [ ] セキュリティチェック
- [ ] リリースノート作成

## 8. レビューポイント

### 8.1 コードレビュー観点

#### アーキテクチャ

- [ ] `RuntimeGroup.Commands` の活用が適切
- [ ] 展開タイミングが適切
- [ ] 責任分担が明確

#### エラーハンドリング

- [ ] エラーメッセージが明確
- [ ] Fail Fast原則が守られている
- [ ] エラーコンテキストが十分

#### テスト

- [ ] カバレッジが十分
- [ ] テストケースが網羅的
- [ ] テストが理解しやすい

#### ドキュメント

- [ ] GoDocコメントが適切
- [ ] CHANGELOGが明確
- [ ] 動作変更が文書化されている

### 8.2 Phase ゲート基準

各フェーズ完了時に以下を確認：

- [ ] すべてのタスクが完了
- [ ] すべてのテストがパス
- [ ] コードレビューが完了
- [ ] ドキュメントが更新済み
- [ ] 次フェーズへの準備完了

## 9. ロールバックプラン

### 9.1 ロールバックトリガー

以下の場合にロールバックを検討：

- 重大なバグの発見
- パフォーマンス劣化 > 10%
- 既存機能の破壊
- スケジュール遅延 > 1週間

### 9.2 ロールバック手順

1. 変更をrevert
2. 既存テストの実行確認
3. 問題の原因分析
4. 再実装計画の作成

### 9.3 部分ロールバック

可能な限り部分的なロールバックを検討：

- Phase 4のみスキップ（最適化なしでリリース）
- Workdir事前解決のみロールバック
- 検証統合のみロールバック

## 10. 参照

### 10.1 関連ドキュメント

- 要件定義書: `01_requirements.md`
- アーキテクチャ設計書: `02_architecture.md`
- 詳細仕様書: `03_detailed_spec.md`

### 10.2 関連ファイル

- `internal/runner/group_executor.go`
- `internal/verification/manager.go`
- `internal/runner/config/expansion.go`
- `internal/runner/runnertypes/runtime.go`

### 10.3 参考資料

- Go Testing Best Practices
- Go Benchmark Guide
- VS Code Extension Development

---

**文書バージョン**: 1.0
**作成日**: 2025-11-28
**承認日**: [レビュー後に記載]
**次回レビュー予定**: [Phase 1完了後]
