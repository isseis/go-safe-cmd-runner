# タスク0040: テストカバレッジ改善

## 1. 目的

現在のテストカバレッジは77.2%であり、特にセキュリティ重要機能や初期化処理において未テスト部分が多く存在する。本タスクでは、カバレッジが低いパッケージに対してテストを追加し、全体的なコード品質とテストの信頼性を向上させる。

## 2. 背景

### 2.1 現状分析

2025-10-21時点でのカバレッジ測定結果:

- **総合カバレッジ**: 77.2%
- **カバレッジ0%のパッケージ**: 4パッケージ
- **カバレッジ50%未満のパッケージ**: 1パッケージ
- **カバレッジ50-70%のパッケージ**: 3パッケージ

### 2.2 問題点

1. **セキュリティ重要機能の未テスト**
   - 権限管理 (`internal/runner/privilege`): 62%
   - リスク評価 (`internal/runner/risk`): 0%
   - 初期化処理 (`internal/runner/bootstrap`): 11.5%

2. **エラーハンドリングの検証不足**
   - CLI パーサー (`internal/runner/cli`): 0%
   - ロギング (`internal/logging`): 53%

3. **統合テストの不足**
   - リソース管理 (`internal/runner/resource`): 78.4%
   - グループメンバーシップ (`internal/groupmembership`): 65.7%

## 3. 要件

### 3.1 機能要件

#### 3.1.1 短期目標 (Phase 1: 1-2週間)

1. **カバレッジ0%パッケージの改善**
   - `internal/runner/risk`: 0% → 80%以上
   - `internal/runner/cli`: 0% → 80%以上
   - `internal/cmdcommon`: 0% → 80%以上
   - `internal/runner/errors`: 0% → 50%以上

2. **セキュリティ重要パッケージの改善**
   - `internal/runner/privilege`: 62% → 80%以上
   - `internal/runner/bootstrap`: 11.5% → 80%以上

**Phase 1 目標カバレッジ**: 82%以上

#### 3.1.2 中期目標 (Phase 2: 1ヶ月)

3. **中カバレッジパッケージの改善**
   - `internal/logging`: 53% → 70%以上
   - `internal/groupmembership`: 65.7% → 75%以上
   - `internal/runner`: 71.7% → 75%以上
   - `internal/runner/runnertypes`: 70.2% → 75%以上

4. **高カバレッジパッケージの補完**
   - `internal/safefileio`: 76.4% → 85%以上
   - `internal/runner/resource`: 78.4% → 85%以上

**Phase 2 目標カバレッジ**: 85%以上

#### 3.1.3 長期目標 (Phase 3: 2-3ヶ月)

5. **セキュリティパッケージの完全カバレッジ**
   - `internal/runner/security`: 87.5% → 95%以上
   - `internal/runner/privilege`: 80% → 95%以上
   - `internal/verification`: 83.2% → 95%以上
   - `internal/filevalidator`: 82.9% → 95%以上

6. **全体の底上げ**
   - すべてのパッケージを75%以上に
   - セキュリティ関連パッケージを90%以上に

**Phase 3 目標カバレッジ**: 90%以上

### 3.2 非機能要件

#### 3.2.1 テストの品質

1. **ユニットテストの原則**
   - 各関数は独立してテスト可能であること
   - モックを活用し、外部依存を排除すること
   - テストは高速に実行できること (1パッケージ < 1秒)

2. **テストケースの網羅性**
   - 正常系: 少なくとも1ケース
   - 異常系: 主要なエラーパターンをカバー
   - エッジケース: 境界値、空値、nil値等をカバー

3. **可読性と保守性**
   - テスト名は機能と期待結果を明確に示すこと
   - テーブル駆動テストを活用すること
   - テストの意図をコメントで明示すること

#### 3.2.2 テスト実行環境

1. **CI/CD統合**
   - すべてのテストがCI/CDで自動実行されること
   - カバレッジレポートが自動生成されること
   - カバレッジ閾値を下回る場合はビルド失敗とすること

2. **パフォーマンス**
   - 全テストの実行時間は5分以内であること
   - 個別パッケージのテストは10秒以内であること

#### 3.2.3 ドキュメント

1. **テスト戦略ドキュメント**
   - 各パッケージのテスト方針を文書化すること
   - モックの使い方をドキュメント化すること
   - テスト追加のガイドラインを提供すること

2. **カバレッジレポート**
   - 週次でカバレッジレポートを更新すること
   - 改善状況を追跡可能にすること

## 4. 詳細要件

### 4.1 Priority: High パッケージ

#### 4.1.1 `internal/runner/risk` (0% → 80%以上)

**未テスト機能:**
- `NewStandardEvaluator()` - リスク評価器の作成
- `EvaluateRisk()` - コマンドリスク評価ロジック

**必要なテストケース:**
1. リスク評価器の正常な作成
2. 各リスクレベルの判定 (Low, Medium, High, Critical)
3. 危険なコマンドパターンの検出
4. ワイルドカードを含むコマンドの評価
5. システムクリティカルパスへのアクセス検出
6. 空のコマンドのハンドリング
7. nil入力のエラーハンドリング
8. 特殊文字を含むコマンドの評価
9. 複数のリスク要因を持つコマンドの評価
10. rootユーザー実行コマンドのリスク評価

**推定工数**: 2-3時間
**推定テストケース数**: 15-20

#### 4.1.2 `internal/runner/cli` (0% → 80%以上)

**未テスト機能:**
- `ParseDryRunDetailLevel()` - Dry-run詳細レベルのパース

**必要なテストケース:**
1. "none" レベルのパース
2. "minimal" レベルのパース
3. "full" レベルのパース
4. 大文字入力の処理
5. 無効な入力のエラーハンドリング
6. 空文字列のハンドリング
7. 数値入力のエラーハンドリング
8. 特殊文字を含む入力のエラーハンドリング

**推定工数**: 1-2時間
**推定テストケース数**: 8-10

#### 4.1.3 `internal/runner/bootstrap` (11.5% → 80%以上)

**未テスト機能:**
- `SetupLogging()` - 基本ロギング初期化
- `SetupLoggerWithConfig()` - 設定ベースロガー初期化
- `InitializeVerificationManager()` - 検証マネージャー初期化
- `InitializeVerificationManagerForTest()` - テスト用初期化

**必要なテストケース:**
1. デフォルト設定でのロギング初期化
2. カスタム設定でのロガー初期化
3. Slack通知有効時の初期化
4. ファイル出力有効時の初期化
5. 無効な設定でのエラーハンドリング
6. 権限不足でのエラーハンドリング
7. 検証マネージャーの正常初期化
8. テストモードでの初期化
9. ハッシュディレクトリ未指定時の動作
10. セキュリティレベル設定の反映確認

**推定工数**: 3-4時間
**推定テストケース数**: 12-15

#### 4.1.4 `internal/runner/privilege` (62% → 80%以上)

**未テスト機能:**
- `escalatePrivileges()` - 権限昇格処理
- `restorePrivileges()` - 権限復元処理
- `emergencyShutdown()` - 緊急シャットダウン
- `restoreUserGroupInternal()` - ユーザー/グループ復元
- `WithUserGroup()` - ユーザー/グループ指定実行
- `IsUserGroupSupported()` - サポート確認

**必要なテストケース:**
1. モック環境での権限昇格テスト
2. モック環境での権限復元テスト
3. 昇格失敗時のエラーハンドリング
4. 復元失敗時のエラーハンドリング
5. 緊急シャットダウンの動作確認
6. ユーザー/グループ指定の正常実行
7. 無効なユーザー指定時のエラー
8. 無効なグループ指定時のエラー
9. 非root環境での昇格試行エラー
10. メトリクス記録の確認
11. 監査ログ出力の確認
12. タイムアウト処理の確認

**推定工数**: 4-5時間
**推定テストケース数**: 20-25

#### 4.1.5 `internal/safefileio` (76.4% → 85%以上)

**未テスト機能:**
- `IsOpenat2Available()` - openat2システムコール利用可否

**必要なテストケース:**
1. Linux環境でのopenat2サポート確認
2. モック環境でのサポート判定
3. 非対応環境でのフォールバック動作

**推定工数**: 2-3時間
**推定テストケース数**: 10-15

### 4.2 Priority: Medium パッケージ

#### 4.2.1 `internal/logging` (53% → 70%以上)

**未テスト機能:**
- Slack通知ハンドラー全般
- セーフファイルオープン機能
- 実行前エラーハンドリング

**必要なテストケース:**
1. Slack Webhook URLの取得
2. Slackハンドラーの有効/無効判定
3. 各種メッセージフォーマットのビルド
4. リトライロジックの動作確認
5. セーフファイルオープンの正常動作
6. RunID生成の一意性確認
7. ログディレクトリ検証
8. 実行前エラーの各種ケース処理

**推定工数**: 4-5時間
**推定テストケース数**: 20-25

#### 4.2.2 `internal/runner/resource` (78.4% → 85%以上)

**未テスト機能:**
- 出力パス検証
- 一時ディレクトリクリーンアップ
- 分析記録機能
- Dry-run結果取得

**必要なテストケース:**
1. デフォルトマネージャーの出力パス検証
2. ノーマルマネージャーの出力パス検証
3. 一時ディレクトリの作成と削除
4. 複数一時ディレクトリの一括削除
5. クリーンアップ失敗時のエラー処理
6. 分析結果の記録
7. Dry-run結果の取得と検証
8. リソース解放の確実性確認

**推定工数**: 3-4時間
**推定テストケース数**: 15-20

#### 4.2.3 `internal/groupmembership` (65.7% → 75%以上)

**未テスト機能:**
- `IsUserInGroup()` の強化
- 要求権限検証
- キャッシュクリア機能

**必要なテストケース:**
1. グループメンバーシップ判定の各パターン
2. キャッシュヒット時の動作
3. キャッシュミス時の動作
4. キャッシュ期限切れ時の自動クリア
5. 要求権限の妥当性検証
6. 不正な権限要求のエラー処理

**推定工数**: 2-3時間
**推定テストケース数**: 10-15

#### 4.2.4 `internal/runner` (71.7% → 75%以上)

**未テスト機能:**
- ビルダーパターンの各メソッド
- コマンド一覧取得
- 全リソースクリーンアップ

**必要なテストケース:**
1. WithXXX()メソッドの連鎖テスト
2. 各コンポーネントの設定確認
3. Dry-run設定の反映確認
4. コマンド一覧の取得
5. 全リソースの確実なクリーンアップ
6. クリーンアップ失敗時の処理

**推定工数**: 2-3時間
**推定テストケース数**: 10-12

#### 4.2.5 `internal/cmdcommon` (0% → 80%以上)

**未テスト機能:**
- フラグパース
- バリデーター作成
- 使用方法表示

**必要なテストケース:**
1. 各種フラグの正常パース
2. 無効なフラグのエラー処理
3. バリデーター作成と設定
4. 使用方法の正しい表示

**推定工数**: 1-2時間
**推定テストケース数**: 6-8

### 4.3 Priority: Low パッケージ

#### 4.3.1 `internal/runner/errors` (0% → 50%以上)

**未テスト機能:**
- エラー型のメソッド群

**必要なテストケース:**
1. Error()メソッドの出力確認
2. Is()メソッドの比較動作
3. Unwrap()メソッドのチェーン確認
4. MarshalJSON()の出力確認
5. SecurityViolationErrorの作成と判定

**推定工数**: 0.5-1時間
**推定テストケース数**: 5-8

#### 4.3.2 `internal/runner/security` (87.5% → 95%以上)

**未テスト機能:**
- 危険コマンド判定の各種メソッド

**必要なテストケース:**
1. 危険なrootコマンドの判定
2. 危険な引数パターンの検出
3. ワイルドカード検出
4. システムクリティカルパス検出
5. リスクパターン取得メソッド

**推定工数**: 1-2時間
**推定テストケース数**: 8-10

#### 4.3.3 `internal/verification` (83.2% → 95%以上)

**未テスト機能:**
- ファイル検証フローの強化
- テスト用オプション

**必要なテストケース:**
1. グローバルファイル検証の各ケース
2. グループファイル検証の各ケース
3. ファイル収集ロジック
4. テスト用オプションの動作確認

**推定工数**: 2-3時間
**推定テストケース数**: 10-12

## 5. 成功基準

### 5.1 定量的基準

| フェーズ | 期間 | 目標カバレッジ | カバレッジ0%パッケージ数 | カバレッジ<70%パッケージ数 |
|---------|------|--------------|----------------------|------------------------|
| Phase 1 | 1-2週間 | 82%以上 | 0 | 2以下 |
| Phase 2 | 1ヶ月 | 85%以上 | 0 | 0 |
| Phase 3 | 2-3ヶ月 | 90%以上 | 0 | 0 |

### 5.2 定性的基準

1. **テストの信頼性**
   - すべてのテストが安定して合格すること
   - フレーキーテスト（不安定なテスト）が0であること

2. **テストの保守性**
   - テストコードが理解しやすく、修正しやすいこと
   - テスト失敗時の原因が明確にわかること

3. **セキュリティ保証**
   - セキュリティ重要機能が十分にテストされていること
   - 脆弱性につながる可能性のあるコードパスがすべてテストされていること

## 6. 制約条件

### 6.1 技術的制約

1. **既存テストへの影響**
   - 既存のテストを破壊しないこと
   - 既存のテストカバレッジを低下させないこと

2. **パフォーマンス**
   - テスト追加により全体のテスト実行時間が10分を超えないこと
   - 個別パッケージのテスト実行時間が15秒を超えないこと

3. **互換性**
   - Go 1.23.10以降で動作すること
   - 既存のCI/CD環境で実行可能であること

### 6.2 プロセス制約

1. **開発プロセス**
   - TDD原則に従うこと（テスト先行）
   - 各フェーズ完了時にカバレッジを測定・レポートすること

2. **レビュー**
   - 各フェーズ完了時にコードレビューを実施すること
   - カバレッジレポートをレビューに含めること

## 7. リスクと対策

### 7.1 リスク

| リスク | 影響度 | 発生確率 | 対策 |
|-------|-------|---------|------|
| テスト実行時間の増加 | 中 | 高 | 並列実行の最適化、遅いテストの特定と改善 |
| フレーキーテストの発生 | 高 | 中 | モックの適切な使用、タイミング依存の排除 |
| テストの保守コスト増加 | 中 | 中 | テーブル駆動テスト、ヘルパー関数の活用 |
| カバレッジ目標未達 | 高 | 低 | 段階的な目標設定、優先順位付け |
| 既存機能の破壊 | 高 | 低 | 既存テストの継続実行、リグレッションテスト |

### 7.2 前提条件

1. テスト環境が正常に動作すること
2. `make test`、`make coverage` コマンドが利用可能であること
3. Go 1.23.10以降がインストールされていること
4. 必要な依存パッケージがインストールされていること

## 8. 関連ドキュメント

- カバレッジレポート: `/tmp/coverage_report.md`
- 既存テストガイドライン: `CLAUDE.md` (Testing Strategy セクション)
- モック実装ガイドライン: `CLAUDE.md` (Mock File Organization セクション)

## 9. 次のステップ

1. アーキテクチャ設計書の作成 (`02_architecture.md`)
2. 詳細仕様書の作成 (`03_specification.md`)
3. 実装計画書の作成 (`04_implementation_plan.md`)
4. Phase 1 の実装開始
