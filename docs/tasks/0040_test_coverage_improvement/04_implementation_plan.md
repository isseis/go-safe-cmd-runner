# タスク0040: テストカバレッジ改善 - 実装計画書

## 1. 概要

本ドキュメントは、テストカバレッジを77.2%から段階的に90%以上まで改善するための実装計画を記述する。各フェーズごとに具体的なタスクをチェックリスト形式で管理する。

## 2. 実装フェーズ

### Phase 1: 緊急度の高いパッケージ (目標: 82%以上)
**期間**: 1-2週間
**推定総工数**: 13-17時間

### Phase 2: 中優先度パッケージ (目標: 85%以上)
**期間**: 追加2-3週間
**推定総工数**: 12-17時間

### Phase 3: 完全カバレッジ達成 (目標: 90%以上)
**期間**: 追加2-4週間
**推定総工数**: 5-8時間

---

## 3. Phase 1: 緊急度の高いパッケージ (1-2週間)

### 3.1 `internal/runner/risk` (0% → 80%以上)

**目標**: リスク評価機能の完全なテストカバレッジ
**推定工数**: 2-3時間
**ファイル**: `internal/runner/risk/evaluator_test.go`

#### タスクチェックリスト

- [ ] 3.1.1 テストファイルの作成
  - [ ] `evaluator_test.go` の作成
  - [ ] テスト用のヘルパー関数定義

- [ ] 3.1.2 `NewStandardEvaluator()` のテスト
  - [ ] 正常な評価器作成のテスト
  - [ ] 初期化状態の確認

- [ ] 3.1.3 `EvaluateRisk()` の基本テスト
  - [ ] Low リスクコマンドのテスト（例: `echo`, `ls`）
  - [ ] Medium リスクコマンドのテスト（例: `chmod`, `chown`）
  - [ ] High リスクコマンドのテスト（例: `rm -rf`, `dd`）
  - [ ] Critical リスクコマンドのテスト（例: `rm -rf /`, `dd of=/dev/sda`）

- [ ] 3.1.4 危険パターン検出のテスト
  - [ ] ワイルドカード検出（`*`, `?`, `[...]`）
  - [ ] システムクリティカルパス検出（`/etc`, `/bin`, `/usr/bin`）
  - [ ] 危険なroot引数検出（`--force`, `--no-preserve-root`）

- [ ] 3.1.5 エッジケースのテスト
  - [ ] 空のコマンド
  - [ ] nil入力のハンドリング
  - [ ] 特殊文字を含むコマンド（`;`, `|`, `&`, `$`）
  - [ ] 非常に長いコマンド

- [ ] 3.1.6 複合条件のテスト
  - [ ] 複数のリスク要因を持つコマンド
  - [ ] rootユーザー実行 + 危険コマンドの組み合わせ
  - [ ] ワイルドカード + システムパスの組み合わせ

- [ ] 3.1.7 カバレッジ確認
  - [ ] `go test -cover` で80%以上を確認
  - [ ] 未カバー箇所の特定と追加テスト

### 3.2 `internal/runner/cli` (0% → 80%以上)

**目標**: CLIパーサーの完全なテストカバレッジ
**推定工数**: 1-2時間
**ファイル**: `internal/runner/cli/output_test.go`

#### タスクチェックリスト

- [ ] 3.2.1 テストファイルの作成
  - [ ] `output_test.go` の作成

- [ ] 3.2.2 `ParseDryRunDetailLevel()` の正常系テスト
  - [ ] "none" レベルのパース
  - [ ] "minimal" レベルのパース
  - [ ] "full" レベルのパース
  - [ ] 大文字入力（"NONE", "MINIMAL", "FULL"）のパース
  - [ ] 混在ケース（"None", "Minimal", "Full"）のパース

- [ ] 3.2.3 `ParseDryRunDetailLevel()` の異常系テスト
  - [ ] 無効な文字列（"invalid", "unknown"）のエラー
  - [ ] 空文字列のエラー
  - [ ] 数値入力（"0", "1", "2"）のエラー
  - [ ] 特殊文字を含む入力のエラー

- [ ] 3.2.4 カバレッジ確認
  - [ ] `go test -cover` で80%以上を確認

### 3.3 `internal/runner/bootstrap` (11.5% → 80%以上)

**目標**: 初期化処理の信頼性確保
**推定工数**: 3-4時間
**ファイル**: `internal/runner/bootstrap/*_test.go`

#### タスクチェックリスト

- [ ] 3.3.1 `SetupLogging()` のテスト (`environment_test.go`)
  - [ ] デフォルト設定での初期化
  - [ ] 環境変数による設定の反映
  - [ ] 初期化済みロガーの再初期化

- [ ] 3.3.2 `SetupLoggerWithConfig()` のテスト (`logger_test.go`)
  - [ ] 基本設定でのロガー作成
  - [ ] Slack通知有効時の初期化
  - [ ] ファイル出力有効時の初期化
  - [ ] インタラクティブモード有効時の初期化
  - [ ] 複数ハンドラーの組み合わせ
  - [ ] 無効な設定でのエラーハンドリング
  - [ ] ログディレクトリ作成失敗時のエラー

- [ ] 3.3.3 `InitializeVerificationManager()` のテスト (`verification_test.go`)
  - [ ] 正常な検証マネージャー初期化
  - [ ] ハッシュディレクトリ指定時の初期化
  - [ ] ハッシュディレクトリ未指定時の動作
  - [ ] セキュリティレベル設定の反映
  - [ ] 無効なハッシュディレクトリでのエラー
  - [ ] 権限不足でのエラー

- [ ] 3.3.4 `InitializeVerificationManagerForTest()` のテスト (`verification_test_helper_test.go`)
  - [ ] テストモードでの初期化
  - [ ] モックファイルシステムの使用
  - [ ] セキュリティレベルの上書き

- [ ] 3.3.5 統合テスト
  - [ ] ロギング + 検証マネージャーの連携
  - [ ] エラー時のログ出力確認

- [ ] 3.3.6 カバレッジ確認
  - [ ] `go test -cover` で80%以上を確認

### 3.4 `internal/runner/privilege` (62% → 80%以上)

**目標**: 権限管理の完全なテストカバレッジ
**推定工数**: 4-5時間
**ファイル**: `internal/runner/privilege/unix_test.go`

#### タスクチェックリスト

- [ ] 3.4.1 テストヘルパーとモックの準備
  - [ ] 権限操作のモックインターフェース作成
  - [ ] システムコールのモック作成
  - [ ] テスト用のヘルパー関数定義

- [ ] 3.4.2 `escalatePrivileges()` のテスト
  - [ ] モック環境での権限昇格成功
  - [ ] 昇格前の状態記録確認
  - [ ] 既に昇格済みの場合のハンドリング
  - [ ] システムコール失敗時のエラー
  - [ ] 権限不足でのエラー

- [ ] 3.4.3 `restorePrivileges()` のテスト
  - [ ] モック環境での権限復元成功
  - [ ] 保存された状態への復元確認
  - [ ] 復元前状態がない場合のエラー
  - [ ] システムコール失敗時のエラー

- [ ] 3.4.4 `emergencyShutdown()` のテスト
  - [ ] 緊急シャットダウンの動作確認
  - [ ] ログ出力の確認
  - [ ] リソースクリーンアップの確認

- [ ] 3.4.5 `WithUserGroup()` のテスト
  - [ ] 正常なユーザー/グループ指定実行
  - [ ] 実行前後のUID/GID確認
  - [ ] 無効なユーザー指定時のエラー
  - [ ] 無効なグループ指定時のエラー
  - [ ] 存在しないユーザーのエラー
  - [ ] 存在しないグループのエラー

- [ ] 3.4.6 `restoreUserGroupInternal()` のテスト
  - [ ] ユーザー/グループの復元成功
  - [ ] 復元失敗時のエラーハンドリング

- [ ] 3.4.7 `IsUserGroupSupported()` のテスト
  - [ ] サポート状況の確認
  - [ ] 各OS環境での動作確認

- [ ] 3.4.8 メトリクスと監査ログのテスト
  - [ ] 成功率の記録確認
  - [ ] 監査ログの出力確認
  - [ ] タイムアウトのメトリクス記録

- [ ] 3.4.9 統合テスト
  - [ ] 昇格 → 実行 → 復元の一連の流れ
  - [ ] エラー発生時の自動復元
  - [ ] 緊急シャットダウンのトリガー

- [ ] 3.4.10 カバレッジ確認
  - [ ] `go test -cover` で80%以上を確認

### 3.5 `internal/safefileio` (76.4% → 85%以上)

**目標**: ファイルI/Oセキュリティの強化
**推定工数**: 2-3時間
**ファイル**: `internal/safefileio/safe_file_test.go`

#### タスクチェックリスト

- [ ] 3.5.1 `IsOpenat2Available()` のテスト
  - [ ] Linux環境でのopenat2サポート確認
  - [ ] モック環境でのサポート判定
  - [ ] 非対応環境での判定

- [ ] 3.5.2 未テストパスの追加テスト
  - [ ] `safeOpenFileInternal()` のエッジケース
  - [ ] `ensureParentDirsNoSymlinks()` の各ケース
  - [ ] `canSafelyAccessFile()` の境界ケース

- [ ] 3.5.3 カバレッジ確認
  - [ ] `go test -cover` で85%以上を確認

### 3.6 `internal/cmdcommon` (0% → 80%以上)

**目標**: コマンド共通機能のテストカバレッジ
**推定工数**: 1-2時間
**ファイル**: `internal/cmdcommon/common_test.go`

#### タスクチェックリスト

- [ ] 3.6.1 テストファイルの作成
  - [ ] `common_test.go` の作成

- [ ] 3.6.2 `ParseFlags()` のテスト
  - [ ] 正常なフラグパース
  - [ ] 複数フラグの組み合わせ
  - [ ] 無効なフラグのエラー
  - [ ] ヘルプフラグ（-h, --help）の処理

- [ ] 3.6.3 `CreateValidator()` のテスト
  - [ ] バリデーター作成と設定
  - [ ] 設定の反映確認

- [ ] 3.6.4 `PrintUsage()` のテスト
  - [ ] 使用方法の正しい出力
  - [ ] 出力フォーマットの確認

- [ ] 3.6.5 カバレッジ確認
  - [ ] `go test -cover` で80%以上を確認

### 3.7 `internal/runner/errors` (0% → 50%以上)

**目標**: エラー型の基本テストカバレッジ
**推定工数**: 0.5-1時間
**ファイル**: `internal/runner/errors/errors_test.go`

#### タスクチェックリスト

- [ ] 3.7.1 テストファイルの作成
  - [ ] `errors_test.go` の作成（存在する場合はrunnertypes/errors_test.go）

- [ ] 3.7.2 基本メソッドのテスト
  - [ ] `Error()` メソッドの出力確認
  - [ ] `Is()` メソッドの比較動作
  - [ ] `Unwrap()` メソッドのチェーン確認
  - [ ] `MarshalJSON()` の出力確認

- [ ] 3.7.3 SecurityViolationError のテスト
  - [ ] エラー作成と取得
  - [ ] 型判定の確認

- [ ] 3.7.4 カバレッジ確認
  - [ ] `go test -cover` で50%以上を確認

### 3.8 Phase 1 完了確認

- [ ] 3.8.1 全体カバレッジの測定
  - [ ] `make coverage` で全体カバレッジを測定
  - [ ] 82%以上を確認

- [ ] 3.8.2 パッケージ別カバレッジの確認
  - [ ] カバレッジ0%のパッケージが0であることを確認
  - [ ] 各対象パッケージが目標を達成していることを確認

- [ ] 3.8.3 テストの品質確認
  - [ ] すべてのテストが安定して合格すること
  - [ ] フレーキーテストがないこと
  - [ ] テスト実行時間が許容範囲内であること

- [ ] 3.8.4 ドキュメント更新
  - [ ] カバレッジレポートの更新
  - [ ] 進捗状況の記録

---

## 4. Phase 2: 中優先度パッケージ (2-3週間)

### 4.1 `internal/logging` (53% → 70%以上)

**目標**: ロギング機能の信頼性向上
**推定工数**: 4-5時間
**ファイル**: `internal/logging/*_test.go`

#### タスクチェックリスト

- [ ] 4.1.1 Slack通知ハンドラーのテスト (`slack_handler_test.go`)
  - [ ] `GetSlackWebhookURL()` のテスト
    - [ ] 環境変数からのURL取得
    - [ ] 未設定時の動作
  - [ ] `Enabled()` のテスト
    - [ ] 有効/無効の判定
  - [ ] `Handle()` のテスト
    - [ ] 各種ログレベルの処理
    - [ ] フィルタリング動作

- [ ] 4.1.2 メッセージフォーマットのテスト
  - [ ] `buildCommandGroupSummary()` のテスト
  - [ ] `buildPreExecutionError()` のテスト
  - [ ] `buildSecurityAlert()` のテスト
  - [ ] `buildPrivilegedCommandFailure()` のテスト
  - [ ] `buildPrivilegeEscalationFailure()` のテスト
  - [ ] `buildGenericMessage()` のテスト

- [ ] 4.1.3 リトライロジックのテスト
  - [ ] `generateBackoffIntervals()` のテスト
    - [ ] バックオフ間隔の計算確認
  - [ ] `sendToSlack()` のテスト（モック使用）
    - [ ] 送信成功ケース
    - [ ] リトライ動作
    - [ ] 最終失敗時の処理

- [ ] 4.1.4 セーフファイルオープンのテスト (`safeopen_test.go`)
  - [ ] `NewSafeFileOpener()` のテスト
  - [ ] `OpenFile()` のテスト
    - [ ] 正常なファイルオープン
    - [ ] 権限エラーのハンドリング
  - [ ] `GenerateRunID()` のテスト
    - [ ] ID生成の一意性確認
  - [ ] `ValidateLogDir()` のテスト
    - [ ] ディレクトリ検証の成功
    - [ ] 無効なディレクトリのエラー

- [ ] 4.1.5 実行前エラーハンドリングのテスト (`pre_execution_error_test.go`)
  - [ ] `HandlePreExecutionError()` のテスト
    - [ ] 検証失敗エラーの処理
    - [ ] 権限エラーの処理
    - [ ] 設定エラーの処理

- [ ] 4.1.6 カバレッジ確認
  - [ ] `go test -cover` で70%以上を確認

### 4.2 `internal/runner/resource` (78.4% → 85%以上)

**目標**: リソース管理の信頼性向上
**推定工数**: 3-4時間
**ファイル**: `internal/runner/resource/*_test.go`

#### タスクチェックリスト

- [ ] 4.2.1 DefaultManager のテスト (`default_manager_test.go`)
  - [ ] `ValidateOutputPath()` のテスト
    - [ ] 有効なパスの検証
    - [ ] 無効なパスのエラー
  - [ ] `CleanupTempDir()` のテスト
    - [ ] 一時ディレクトリの削除確認
  - [ ] `CleanupAllTempDirs()` のテスト
    - [ ] 複数ディレクトリの一括削除
  - [ ] `RecordAnalysis()` のテスト
    - [ ] 分析結果の記録

- [ ] 4.2.2 DryRunManager のテスト (`dryrun_manager_test.go`)
  - [ ] `CleanupAllTempDirs()` のテスト
  - [ ] `analyzeOutput()` のテスト
    - [ ] 出力分析の動作確認

- [ ] 4.2.3 NormalManager のテスト (`normal_manager_test.go`)
  - [ ] `ValidateOutputPath()` のテスト
  - [ ] `executeCommandWithOutput()` のテスト
    - [ ] コマンド実行と出力の確認
    - [ ] エラー時の処理
  - [ ] `CleanupAllTempDirs()` のテスト
  - [ ] `GetDryRunResults()` のテスト

- [ ] 4.2.4 クリーンアップの確実性テスト
  - [ ] エラー発生時のクリーンアップ
  - [ ] パニック発生時のクリーンアップ

- [ ] 4.2.5 カバレッジ確認
  - [ ] `go test -cover` で85%以上を確認

### 4.3 `internal/groupmembership` (65.7% → 75%以上)

**目標**: グループ管理の信頼性向上
**推定工数**: 2-3時間
**ファイル**: `internal/groupmembership/manager_test.go`

#### タスクチェックリスト

- [ ] 4.3.1 `IsUserInGroup()` のテスト強化
  - [ ] プライマリグループのメンバーシップ
  - [ ] セカンダリグループのメンバーシップ
  - [ ] 非メンバーの判定
  - [ ] 存在しないグループのエラー
  - [ ] 存在しないユーザーのエラー

- [ ] 4.3.2 `ValidateRequestedPermissions()` のテスト
  - [ ] 有効な権限要求の検証
  - [ ] 無効な権限要求のエラー
  - [ ] ファイル権限との整合性確認

- [ ] 4.3.3 `clearExpiredCache()` のテスト
  - [ ] キャッシュの自動クリア確認
  - [ ] 期限切れ判定の動作
  - [ ] 有効なキャッシュの保持

- [ ] 4.3.4 キャッシュ動作の統合テスト
  - [ ] キャッシュヒット時のパフォーマンス
  - [ ] キャッシュミス時の動作
  - [ ] キャッシュ更新の動作

- [ ] 4.3.5 カバレッジ確認
  - [ ] `go test -cover` で75%以上を確認

### 4.4 `internal/runner` (71.7% → 75%以上)

**目標**: Runner本体の信頼性向上
**推定工数**: 2-3時間
**ファイル**: `internal/runner/runner_test.go`

#### タスクチェックリスト

- [ ] 4.4.1 ビルダーパターンのテスト
  - [ ] `WithVerificationManager()` のテスト
  - [ ] `WithExecutor()` のテスト
  - [ ] `WithPrivilegeManager()` のテスト
  - [ ] `WithAuditLogger()` のテスト
  - [ ] `WithDryRun()` のテスト
  - [ ] メソッドチェーンのテスト

- [ ] 4.4.2 `ListCommands()` のテスト
  - [ ] コマンド一覧の取得
  - [ ] グループ別コマンドのフィルタ
  - [ ] 空の設定の処理

- [ ] 4.4.3 `CleanupAllResources()` のテスト
  - [ ] 全リソースのクリーンアップ確認
  - [ ] エラー発生時の処理
  - [ ] 部分的なクリーンアップ失敗の処理

- [ ] 4.4.4 統合テスト
  - [ ] ビルダーで構築したRunnerの動作確認
  - [ ] 各コンポーネントの連携確認

- [ ] 4.4.5 カバレッジ確認
  - [ ] `go test -cover` で75%以上を確認

### 4.5 `internal/runner/runnertypes` (70.2% → 75%以上)

**目標**: 型定義とランタイム構造体の信頼性向上
**推定工数**: 1-2時間
**ファイル**: `internal/runner/runnertypes/*_test.go`

#### タスクチェックリスト

- [ ] 4.5.1 RuntimeGlobal のテスト (`runtime_test.go`)
  - [ ] `NewRuntimeGlobal()` のテスト
  - [ ] 各Getterメソッドのテスト
  - [ ] デフォルト値の確認

- [ ] 4.5.2 RuntimeGroup のテスト
  - [ ] `NewRuntimeGroup()` のテスト
  - [ ] 各Getterメソッドのテスト
  - [ ] 継承動作の確認

- [ ] 4.5.3 RuntimeCommand のテスト
  - [ ] `NewRuntimeCommand()` のテスト
  - [ ] 各Getterメソッドのテスト
  - [ ] リスクレベル判定のテスト

- [ ] 4.5.4 カバレッジ確認
  - [ ] `go test -cover` で75%以上を確認

### 4.6 Phase 2 完了確認

- [ ] 4.6.1 全体カバレッジの測定
  - [ ] `make coverage` で全体カバレッジを測定
  - [ ] 85%以上を確認

- [ ] 4.6.2 パッケージ別カバレッジの確認
  - [ ] カバレッジ70%未満のパッケージが0であることを確認
  - [ ] 各対象パッケージが目標を達成していることを確認

- [ ] 4.6.3 テストの品質確認
  - [ ] すべてのテストが安定して合格すること
  - [ ] テスト実行時間が許容範囲内であること

- [ ] 4.6.4 ドキュメント更新
  - [ ] カバレッジレポートの更新
  - [ ] 進捗状況の記録

---

## 5. Phase 3: 完全カバレッジ達成 (2-4週間)

### 5.1 `internal/runner/security` (87.5% → 95%以上)

**目標**: セキュリティ検証機能の完全カバレッジ
**推定工数**: 1-2時間
**ファイル**: `internal/runner/security/*_test.go`

#### タスクチェックリスト

- [ ] 5.1.1 コマンド分析機能のテスト (`command_analysis_test.go`)
  - [ ] `IsDangerousRootCommand()` のテスト
    - [ ] 危険なrootコマンドの判定
    - [ ] 安全なコマンドの判定
  - [ ] `HasDangerousRootArgs()` のテスト
    - [ ] 危険な引数パターンの検出
  - [ ] `HasWildcards()` のテスト
    - [ ] 各種ワイルドカード検出
  - [ ] `HasSystemCriticalPaths()` のテスト
    - [ ] システムパスの検出

- [ ] 5.1.2 リスクパターン取得のテスト (`types_test.go`)
  - [ ] `GetPathPatternsByRisk()` のテスト
  - [ ] `GetSuspiciousExtensions()` のテスト
  - [ ] `GetSystemCriticalPaths()` のテスト

- [ ] 5.1.3 False positive/negative のテスト
  - [ ] 誤検知ケースの確認
  - [ ] 見逃しケースの確認

- [ ] 5.1.4 カバレッジ確認
  - [ ] `go test -cover` で95%以上を確認

### 5.2 `internal/verification` (83.2% → 90%以上)

**目標**: ファイル検証機能の完全カバレッジ
**推定工数**: 2-3時間
**ファイル**: `internal/verification/*_test.go`

#### タスクチェックリスト

- [ ] 5.2.1 ファイル検証フローのテスト (`manager_test.go`)
  - [ ] `VerifyGlobalFiles()` のテスト強化
    - [ ] 複数ファイルの検証
    - [ ] ハッシュ不一致の検出
    - [ ] ファイル不存在のエラー
  - [ ] `VerifyGroupFiles()` のテスト強化
    - [ ] グループ別ファイル検証
    - [ ] エラーケースの処理
  - [ ] `collectVerificationFiles()` のテスト
    - [ ] ファイル収集ロジック
    - [ ] 優先順位の確認

- [ ] 5.2.2 テスト用オプションのテスト (`manager_testing_test.go`)
  - [ ] `WithFS()` のテスト
    - [ ] カスタムファイルシステムの使用
  - [ ] `WithFileValidatorEnabled()` のテスト
    - [ ] 検証の有効/無効切り替え
  - [ ] `WithTestingSecurityLevel()` のテスト
    - [ ] セキュリティレベルの上書き

- [ ] 5.2.3 統合テスト
  - [ ] Global + Group ファイルの統合検証
  - [ ] エラー発生時の処理フロー

- [ ] 5.2.4 カバレッジ確認
  - [ ] `go test -cover` で90%以上を確認

### 5.3 `internal/runner/privilege` (80% → 95%以上)

**目標**: 権限管理の完全カバレッジ
**推定工数**: 2-3時間
**ファイル**: `internal/runner/privilege/unix_test.go`

#### タスクチェックリスト

- [ ] 5.3.1 残存する未テスト部分の特定
  - [ ] カバレッジレポートで未カバー箇所を確認

- [ ] 5.3.2 追加テストの作成
  - [ ] エッジケースの追加
  - [ ] エラーパスの網羅
  - [ ] 統合シナリオの追加

- [ ] 5.3.3 カバレッジ確認
  - [ ] `go test -cover` で95%以上を確認

### 5.4 その他のパッケージの最終調整

#### タスクチェックリスト

- [ ] 5.4.1 `internal/filevalidator` (82.9% → 90%以上)
  - [ ] 未カバー箇所の特定と追加テスト
  - [ ] カバレッジ確認

- [ ] 5.4.2 `internal/runner/environment` (82.5% → 90%以上)
  - [ ] 未カバー箇所の特定と追加テスト
  - [ ] カバレッジ確認

- [ ] 5.4.3 `internal/runner/executor` (86.5% → 90%以上)
  - [ ] 未カバー箇所の特定と追加テスト
  - [ ] カバレッジ確認

- [ ] 5.4.4 `internal/runner/output` (90.5% → 95%以上)
  - [ ] 未カバー箇所の特定と追加テスト
  - [ ] カバレッジ確認

### 5.5 Phase 3 完了確認

- [ ] 5.5.1 全体カバレッジの測定
  - [ ] `make coverage` で全体カバレッジを測定
  - [ ] 90%以上を確認

- [ ] 5.5.2 パッケージ別カバレッジの確認
  - [ ] セキュリティ関連パッケージが90%以上であることを確認
  - [ ] すべてのパッケージが75%以上であることを確認

- [ ] 5.5.3 テストの品質確認
  - [ ] すべてのテストが安定して合格すること
  - [ ] フレーキーテストがないこと
  - [ ] テスト実行時間が10分以内であること

- [ ] 5.5.4 最終ドキュメント更新
  - [ ] 最終カバレッジレポートの作成
  - [ ] テスト戦略ドキュメントの更新
  - [ ] 完了報告の作成

---

## 6. 継続的改善

### 6.1 CI/CD統合

#### タスクチェックリスト

- [ ] 6.1.1 カバレッジ閾値の設定
  - [ ] CI/CDでカバレッジ閾値を85%に設定
  - [ ] 閾値を下回る場合のビルド失敗設定

- [ ] 6.1.2 カバレッジレポートの自動生成
  - [ ] HTMLレポートの自動生成
  - [ ] レポートのアーティファクト保存

- [ ] 6.1.3 カバレッジトレンドの追跡
  - [ ] カバレッジ履歴の記録
  - [ ] トレンドグラフの作成

### 6.2 テストドキュメント整備

#### タスクチェックリスト

- [ ] 6.2.1 テスト戦略ドキュメントの作成
  - [ ] 各パッケージのテスト方針
  - [ ] モック使用ガイドライン
  - [ ] テスト追加ガイドライン

- [ ] 6.2.2 テストベストプラクティスの文書化
  - [ ] テーブル駆動テストの例
  - [ ] モックパターンの例
  - [ ] エラーテストの例

- [ ] 6.2.3 カバレッジ維持ガイドラインの作成
  - [ ] 新機能追加時のテスト要件
  - [ ] リファクタリング時の注意点

---

## 7. 進捗管理

### 7.1 週次レビュー

- **Week 1 (Phase 1前半)**
  - [ ] risk, cli, bootstrap パッケージの完了
  - [ ] 中間カバレッジ測定

- **Week 2 (Phase 1後半)**
  - [ ] privilege, safefileio, cmdcommon, errors パッケージの完了
  - [ ] Phase 1 完了確認（82%達成）

- **Week 3-4 (Phase 2前半)**
  - [ ] logging, resource パッケージの完了
  - [ ] 中間カバレッジ測定

- **Week 4-5 (Phase 2後半)**
  - [ ] groupmembership, runner, runnertypes パッケージの完了
  - [ ] Phase 2 完了確認（85%達成）

- **Week 6-8 (Phase 3)**
  - [ ] security, verification パッケージの完了
  - [ ] その他パッケージの最終調整
  - [ ] Phase 3 完了確認（90%達成）

### 7.2 マイルストーン

| マイルストーン | 目標日 | 目標カバレッジ | ステータス |
|-------------|-------|--------------|-----------|
| Phase 1 完了 | Week 2終了 | 82%以上 | [ ] |
| Phase 2 完了 | Week 5終了 | 85%以上 | [ ] |
| Phase 3 完了 | Week 8終了 | 90%以上 | [ ] |
| CI/CD統合 | Week 9終了 | - | [ ] |
| ドキュメント完成 | Week 10終了 | - | [ ] |

---

## 8. リスク対応

### 8.1 リスク監視項目

- [ ] テスト実行時間の監視
  - [ ] 各フェーズ後に全体の実行時間を測定
  - [ ] 10分を超える場合は最適化を検討

- [ ] フレーキーテストの監視
  - [ ] 新規追加テストの安定性確認
  - [ ] 不安定なテストの特定と修正

- [ ] カバレッジの後退防止
  - [ ] 各コミット時のカバレッジ確認
  - [ ] 低下を検出したら即座に対応

### 8.2 問題発生時の対応

- [ ] テスト実行時間超過時
  - [ ] 並列実行の最適化
  - [ ] 遅いテストの特定とリファクタリング
  - [ ] 不要なセットアップの削減

- [ ] フレーキーテスト発生時
  - [ ] タイミング依存の排除
  - [ ] モックの適切な使用
  - [ ] テスト隔離の強化

- [ ] カバレッジ目標未達時
  - [ ] 未カバー箇所の優先度再評価
  - [ ] リソースの再配分
  - [ ] 段階的な目標の調整

---

## 9. 完了基準

### 9.1 必須基準

- [x] 総合カバレッジが90%以上
- [ ] カバレッジ0%のパッケージが0
- [ ] カバレッジ70%未満のパッケージが0
- [ ] セキュリティ関連パッケージが90%以上
- [ ] すべてのテストが安定して合格
- [ ] フレーキーテストが0
- [ ] テスト実行時間が10分以内

### 9.2 推奨基準

- [ ] テスト戦略ドキュメントの完成
- [ ] CI/CDへのカバレッジ閾値設定
- [ ] カバレッジトレンドの可視化
- [ ] テストベストプラクティスの文書化
- [ ] カバレッジ維持ガイドラインの作成

---

## 10. 参考情報

- **カバレッジレポート**: `coverage_report.md`
- **測定コマンド**: `make coverage`
- **テスト実行**: `make test`
- **パッケージ別テスト**: `go test -tags test -v -cover ./internal/パッケージ名`
