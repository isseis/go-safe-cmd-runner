# 要件定義書：コマンド出力キャプチャ機能

## 1. 概要 (Overview)

**目的:** このドキュメントは、go-safe-cmd-runnerにおいてコマンドの標準出力をファイルにキャプチャする機能の実装要件を定義する。

**背景:**
現在のgo-safe-cmd-runnerでは、実行されるコマンドの標準出力は端末に直接表示されるか、ログシステムに記録される。しかし、以下のようなユースケースにおいて、コマンドの出力を特定のファイルに保存する需要がある：

1. **結果の永続化**: コマンドの実行結果を後で参照するため
2. **後続処理での利用**: 他のコマンドの入力として使用するため
3. **レポート生成**: 実行結果をレポートファイルに含めるため
4. **デバッグとトラブルシューティング**: 問題発生時の証跡として保存するため

この機能により、TOMLファイルで設定した特定のコマンドの出力を指定されたファイルに自動的に保存できるようになる。

## 2. 目的とスコープ (Goals and Scope)

### 2.1. 目的 (Goals)

- **出力の永続化**: コマンドの標準出力を指定ファイルに確実に保存する
- **設定の柔軟性**: 絶対パス・相対パス両方に対応し、出力サイズ制限を設定可能にする
- **セキュリティの確保**: パストラバーサル攻撃を防ぎ、安全なファイル出力を実現する
- **エラーハンドリング**: ファイル書き込み失敗時の適切な処理とエラー報告
- **既存機能との整合性**: Dry-Runモードやログシステムとの適切な統合

### 2.2. スコープ (In Scope)

- コマンド定義へのoutputフィールド追加
- 標準出力のファイル書き込み機能
- 絶対パス・相対パス対応
- ファイル書き込み権限とディレクトリ存在確認
- 出力サイズ制限機能
- Dry-Runモードでの出力計画表示
- エラーハンドリングと適切なログ記録
- 設定検証機能

### 2.3. スコープ外 (Out of Scope)

- 標準エラー出力のキャプチャ（標準出力のみ対象）
- リアルタイム書き込み（バッファリングによる遅延書き込みを許容）
- 出力内容の加工・フィルタリング（生の出力をそのまま保存）
- 既存ファイルへの追記機能（常に上書き）
- 複数ファイルへの出力分散
- 出力内容の暗号化・圧縮
- ネットワーク経由での出力送信

## 3. 機能要件 (Functional Requirements)

### 3.1. 機能一覧

#### 3.1.1 基本出力キャプチャ機能

**F1: 標準出力キャプチャ**
- コマンドの標準出力を完全にキャプチャし、Runner標準出力とファイルの両方に書き込む
- バイナリ出力も含めて生データをそのまま保存する
- メモリ効率を考慮した書き込み処理を実装する
- Runner標準出力への表示は output フィールドの有無に関係なく常に実行

**F2: outputフィールドサポート**
- Command構造体にoutputフィールド（string型、optional）を追加
- outputフィールドが空文字列または未設定の場合は従来通りの動作（Runner標準出力のみ）
- outputフィールド指定時は標準出力をRunner標準出力とファイルの両方に書き込む（Tee機能）

**F2-1: 出力ファイル権限制御**
- 出力ファイルは常に実行者（元のUID）の権限で作成する
- `run_as_user`指定によるEUID変更に関係なく、実UID権限でファイル作成
- 機密情報保護のため、ファイルパーミッションは0600（owner read/write only）に設定
- グループやその他のユーザーからのアクセスを防止

#### 3.1.2 パス処理機能

**F3: 絶対パス対応**
- outputフィールドに絶対パス（/で始まる）が指定された場合、そのまま使用
- ファイル作成権限とディレクトリ存在を事前確認

**F4: 相対パス対応**
- outputフィールドに相対パスが指定された場合、WorkDirを基準とする
- パストラバーサル攻撃を防ぐため、親ディレクトリ参照（..）を禁止
- 相対パスの正規化処理を実装

**F5: ディレクトリ自動作成**
- 出力ファイルのディレクトリが存在しない場合、自動的に作成
- 作成時の権限は適切に設定（0755）
- ディレクトリ作成も実UID権限で実行（`run_as_user`による影響を受けない）
- 作成失敗時は適切なエラーメッセージを表示

#### 3.1.3 出力サイズ制御機能

**F6: デフォルトサイズ制限**
- デフォルトの出力サイズ制限を設定（例：10MB）
- 制限を超えた場合はコマンドを強制終了し、エラーとして処理

**F7: カスタムサイズ制限**
- GlobalConfigにmax_output_sizeフィールドを追加
- TOML設定でデフォルト制限を上書き可能
- 0指定で制限を無効化可能

#### 3.1.4 エラーハンドリング機能

**F8: ファイル書き込みエラー処理**
- ファイル作成・書き込み失敗時はコマンド自体を失敗として扱う
- 具体的なエラー理由をログに記録（権限不足、ディスク容量不足等）
- 部分的に書き込まれたファイルは削除する

**F9: セキュリティ検証**
- 出力パスにおけるパストラバーサルの検出と防止
- シンボリックリンク経由でのパストラバーサルも検出
- 不正なパス指定時は設定検証エラーとして処理

### 3.2. 非機能要件 (Non-Functional Requirements)

#### 3.2.1 パフォーマンス要件

**NF1: メモリ効率**
- 大きな出力でもメモリ使用量を一定に抑える（ストリーミング処理）
- 出力サイズに比例してメモリ使用量が増加しないようにする

**NF2: ファイルI/O効率**
- バッファリングを適切に行い、小刻みな書き込みを避ける
- 一時ファイルを使用して原子的な書き込みを実現

#### 3.2.2 セキュリティ要件

**NF3: パス検証**
- 全ての出力パスで正規化とセキュリティ検証を実施
- ファイルシステムの境界を超えたアクセスを防止

**NF4: 権限確認**
- ファイル作成前に書き込み権限の存在を確認（実UID基準）
- 権限不足時は事前にエラーとして処理

**NF5: 特権分離**
- 出力ファイル操作は`run_as_user`指定の影響を受けない
- コマンド実行権限と出力ファイル権限を明確に分離
- 機密情報漏洩防止のための制限的ファイル権限（0600）設定

#### 3.2.3 信頼性要件

**NF6: 原子的操作**
- ファイル書き込みの失敗時は部分的なファイルが残らないようにする
- 一時ファイル→リネームによる原子的更新を実装

**NF7: エラー復旧**
- 出力ファイル関連のエラーが他のコマンドの実行を妨げないようにする
- 適切なクリーンアップ処理を実装

## 4. 技術要件 (Technical Requirements)

### 4.1. データ構造要件

#### 4.1.1 Command構造体拡張
```go
type Command struct {
    // 既存フィールド
    Name         string   `toml:"name"`
    Description  string   `toml:"description"`
    Cmd          string   `toml:"cmd"`
    Args         []string `toml:"args"`
    // ... other existing fields

    // 新規追加フィールド
    Output       string   `toml:"output"`        // 標準出力の書き込み先ファイル（optional）
}
```

#### 4.1.2 GlobalConfig構造体拡張
```go
type GlobalConfig struct {
    // 既存フィールド
    Timeout           int      `toml:"timeout"`
    // ... other existing fields

    // 新規追加フィールド
    MaxOutputSize     int64    `toml:"max_output_size"` // 出力サイズ制限（bytes、0で無制限）
}
```

### 4.2. 設定ファイル仕様

#### 4.2.1 TOML設定例
```toml
[global]
timeout = 3600
max_output_size = 10485760  # 10MB (デフォルト)

[[groups]]
name = "data_processing"
description = "Data processing commands"

[[groups.commands]]
name = "generate_report"
description = "Generate system report"
cmd = "/usr/bin/system-info"
args = ["--detailed"]
output = "reports/system-report.txt"  # 相対パス（WorkDir基準）
# 動作: Runner標準出力に表示 + ファイルにも保存

[[groups.commands]]
name = "export_data"
description = "Export database data"
cmd = "/usr/bin/pg_dump"
args = ["mydb"]
output = "/var/backups/db-export.sql"  # 絶対パス
# 動作: Runner標準出力に表示 + ファイルにも保存

[[groups.commands]]
name = "show_status"
description = "Show system status (no file output)"
cmd = "/usr/bin/uptime"
# output フィールドなし: Runner標準出力のみに表示
```

### 4.3. 処理フロー要件

#### 4.3.1 コマンド実行フロー
1. **事前検証フェーズ**
   - outputフィールドの存在確認
   - パス正規化とセキュリティ検証
   - 出力ディレクトリの存在確認・作成
   - 書き込み権限の確認

2. **実行フェーズ**
   - コマンドの標準出力をキャプチャ
   - 出力サイズの監視
   - 一時ファイルへの書き込み

3. **完了フェーズ**
   - 一時ファイルから最終ファイルへの原子的移動
   - ファイルパーミッションを0600に設定（機密情報保護）
   - 成功時のログ記録
   - エラー時のクリーンアップ

#### 4.3.2 Dry-Runフロー
1. 出力ファイルパスの表示
2. 出力予定サイズの推定値ならびに上限値表示（不可能な場合は"不明"）
3. 書き込み権限の確認結果表示
4. 実際のファイル作成は行わない

### 4.4. エラーハンドリング仕様

#### 4.4.1 設定検証エラー
- 空のoutputフィールド → 警告（機能無効として処理）
- 不正なパス（..を含む等） → エラー
- 絶対パスの権限不足 → エラー

#### 4.4.2 実行時エラー
- ディレクトリ作成失敗 → コマンド失敗
- ファイル書き込み失敗 → コマンド失敗
- 出力サイズ制限超過 → コマンド強制終了・失敗

## 5. 使用例とユースケース (Use Cases)

### 5.1. 基本的な使用例

#### 5.1.1 システムレポート生成
```toml
[[groups.commands]]
name = "system_report"
cmd = "df"
args = ["-h"]
output = "reports/disk_usage.txt"
# 動作: Runner標準出力に表示 + reports/disk_usage.txt にも保存（0600権限）
```

#### 5.1.2 データベースバックアップ（特権実行）
```toml
[[groups.commands]]
name = "db_backup"
cmd = "pg_dump"
args = ["--no-password", "mydb"]
output = "/backups/mydb_backup.sql"
run_as_user = "postgres"
# 動作: Runner標準出力に表示 + /backups/mydb_backup.sql にも保存
# コマンドはpostgresユーザーで実行されるが、出力ファイルは実行者権限（0600）で作成
```

#### 5.1.3 設定ファイル生成と権限変更
```toml
# 機密ファイルを生成（Runner標準出力に表示 + ファイルに保存）
[[groups.commands]]
name = "generate_config"
cmd = "echo"
args = ["server_name=production"]
output = "config/server.conf"
# 動作: Runner標準出力に "server_name=production" 表示 + config/server.conf に保存（0600権限）

# 必要に応じて後続コマンドで権限変更
[[groups.commands]]
name = "set_config_permissions"
cmd = "chmod"
args = ["644", "config/server.conf"]
# 動作: Runner標準出力のみ（output指定なし）
```

### 5.2. エラーケース

#### 5.2.1 権限不足
```toml
[[groups.commands]]
name = "restricted_output"
cmd = "echo"
args = ["test"]
output = "/root/restricted.txt"  # 権限不足でエラー
```

#### 5.2.2 不正なパス
```toml
[[groups.commands]]
name = "invalid_path"
cmd = "echo"
args = ["test"]
output = "../../../etc/passwd"  # パストラバーサルでエラー
```

### 5.3. Dry-Run表示例

```bash
$ go-safe-cmd-runner --config config.toml --dry-run

=== DRY-RUN ANALYSIS REPORT ===

Resource Operations:
- File Creation: 2 operations

=== RESOURCE ANALYSIS ===

1. File Creation [FileOperation]
   Path: /home/user/project/reports/disk_usage.txt
   Command: system_report (df -h)
   Estimated Size: Unknown
   Permissions: Write access confirmed
   Security Risk: LOW

2. File Creation [FileOperation]
   Path: /backups/mydb_backup.sql
   Command: db_backup (pg_dump --no-password mydb)
   Estimated Size: Unknown
   Permissions: Write access confirmed
   Security Risk: MEDIUM
```

## 6. 制約と前提条件 (Constraints and Assumptions)

### 6.1. 制約条件

- **プラットフォーム**: Linux環境のみサポート（Windowsのパス形式は対象外）
- **ファイルシステム**: POSIX準拠のファイルシステムを前提
- **出力形式**: バイナリ・テキスト問わず生データをそのまま保存
- **同時実行**: 同一ファイルへの複数コマンドからの同時出力は未サポート
- **権限分離**: 出力ファイルは常に実UID権限で作成（`run_as_user`の影響を受けない）
- **ファイル権限**: セキュリティのため0600固定（所有者のみread/write可能）

### 6.2. 前提条件

- コマンドが標準出力に出力することを前提
- 出力先ディレクトリへの書き込み権限が適切に設定されていること
- ディスク容量が十分にあること
- WorkDirが適切に設定されていること（相対パス使用時）

### 6.3. 制限事項

- 標準エラー出力はキャプチャ対象外
- リアルタイムでの部分出力確認は不可
- 出力内容の事前検証やフィルタリングは未実装
- ログローテーションやファイル管理機能は未実装

## 7. 受け入れ基準 (Acceptance Criteria)

### 7.1. 基本機能

- [ ] outputフィールドが設定されたコマンドの標準出力が指定ファイルに保存される
- [ ] outputフィールドが空/未設定の場合は従来の動作が維持される
- [ ] 絶対パス・相対パス両方で正しく動作する
- [ ] 相対パスがWorkDir基準で解決される
- [ ] 出力ファイルが0600権限で作成される（機密情報保護）
- [ ] `run_as_user`指定時でも出力ファイルは実UID権限で作成される

### 7.2. セキュリティ

- [ ] パストラバーサル攻撃が適切に防がれる
- [ ] シンボリックリンク経由の攻撃が防がれる
- [ ] 権限不足時に適切なエラーが表示される

### 7.3. エラーハンドリング

- [ ] ファイル書き込み失敗時にコマンドが失敗として扱われる
- [ ] 部分的に書き込まれたファイルが適切にクリーンアップされる
- [ ] 出力サイズ制限超過時にコマンドが強制終了される

### 7.4. 設定と検証

- [ ] TOML設定ファイルで適切にパースされる
- [ ] 設定検証で不正な値が検出される
- [ ] max_output_sizeによるサイズ制限が機能する

### 7.5. Dry-Run

- [ ] Dry-Runモードで出力予定ファイルが表示される
- [ ] 実際のファイル作成が行われない
- [ ] 権限確認結果が表示される

## 8. 実装計画 (Implementation Plan)

### 8.1. Phase 1: 基本構造実装

1. Command/GlobalConfig構造体の拡張
2. TOML設定パース機能の追加
3. 基本的な出力キャプチャ機能
4. 単体テストの実装

### 8.2. Phase 2: パス処理とセキュリティ

1. 絶対パス・相対パス処理の実装
2. パストラバーサル防止機能
3. ディレクトリ自動作成機能
4. セキュリティテストの追加

### 8.3. Phase 3: エラーハンドリングと制限機能

1. 出力サイズ制限機能
2. エラーハンドリングの強化
3. 原子的ファイル操作の実装
4. 統合テストの実装

### 8.4. Phase 4: 統合と最適化

1. Dry-Run機能との統合
2. ログシステムとの統合
3. パフォーマンス最適化
4. ドキュメントとサンプル作成

## 9. テスト戦略 (Testing Strategy)

### 9.1. 単体テスト

- outputフィールドのパース機能
- パス正規化とセキュリティ検証
- 出力キャプチャ機能
- エラーハンドリング

### 9.2. 統合テスト

- 実際のコマンド実行との統合
- Dry-Runモードでの動作
- 複数コマンドでの動作
- 設定ファイル全体での動作

### 9.3. セキュリティテスト

- パストラバーサル攻撃のテスト
- シンボリックリンク攻撃のテスト
- 権限昇格攻撃のテスト

### 9.4. パフォーマンステスト

- 大きな出力での動作確認
- メモリ使用量の測定
- 出力サイズ制限の動作確認

## 10. リスク分析 (Risk Analysis)

### 10.1. 技術リスク

**R1: メモリ消費量増加**
- リスク: 大きな出力でメモリ使用量が急増
- 対策: ストリーミング処理とバッファサイズ制限

**R2: ファイルI/O性能影響**
- リスク: 頻繁なファイル書き込みによる性能低下
- 対策: 適切なバッファリングと非同期I/O

### 10.2. セキュリティリスク

**R3: パストラバーサル攻撃**
- リスク: 設定ファイル経由での不正ファイルアクセス
- 対策: 厳密なパス検証とサンドボックス化

**R4: ディスク容量不足攻撃**
- リスク: 意図的な大量出力によるディスク枯渇
- 対策: 出力サイズ制限とモニタリング

### 10.3. 運用リスク

**R5: 設定ミスによるデータ消失**
- リスク: 既存ファイルの意図しない上書き
- 対策: 適切なドキュメント化と警告メッセージ

**R6: 機密情報の意図しない露出**
- リスク: 出力ファイルに含まれる機密情報へのアクセス
- 対策: 制限的ファイル権限（0600）の強制適用

**R7: 権限昇格との混同**
- リスク: `run_as_user`と出力ファイル権限の関係の誤解
- 対策: 明確な権限分離の文書化と実装
