# 要件定義書：タイムアウト設定仕様の明確化

## 1. 概要 (Overview)

**目的:** このドキュメントは、TOML設定ファイルにおけるタイムアウト設定の仕様を明確化し、「未設定」と「明示的な0」を区別できるようにする変更に関する要件を定義する。

**背景:**
現在のgo-safe-cmd-runnerでは、TOML設定ファイルで`timeout`が未設定の場合と明示的に`timeout = 0`が設定された場合の両方で、同じ動作（デフォルト値60秒のタイムアウト）となっている。これにより、「タイムアウトなし（無制限実行）」を指定する方法がなく、長時間実行されるコマンドの処理が困難になっている。

## 2. 目的とスコープ (Goals and Scope)

### 2.1. 目的 (Goals)
- TOMLファイルでタイムアウト設定が未設定の場合と明示的に0が設定された場合を区別する
- 明示的に`timeout = 0`が設定された場合に「タイムアウトなし（無制限実行）」を実現する
- 既存のタイムアウト機能の安全性と信頼性を維持する
- 後方互換性への影響を最小限に抑える

### 2.2. スコープ (In Scope)
- グローバルレベル（`[global]`）の`timeout`設定
- グループレベルの`timeout`設定（継承がある場合）
- コマンドレベル（`[[groups.commands]]`）の`timeout`設定
- 関連するGoコードの型定義変更（`*int`型の使用）
- ドキュメント更新（日本語版・英語版）
- テストコードの更新

### 2.3. スコープ外 (Out of Scope)
- デフォルトタイムアウト値（60秒）の変更
- 他のタイムアウト関連機能（例：ネットワークタイムアウト）
- GUI または Web インターフェースでの表示変更
- 設定ファイルの自動マイグレーション機能

## 3. 機能要件 (Functional Requirements)

### 3.1. 機能一覧

#### **機能ID:** `F-001`
**機能名:** タイムアウト未設定時のデフォルト動作
**概要:** TOML設定でタイムアウトが未設定の場合、デフォルト値（60秒）を使用する
**詳細:**
- TOML設定で`timeout`フィールドが存在しない場合
- Goコード内で`nil`ポインタとして表現される
- 実行時にデフォルト値（60秒）が適用される

#### **機能ID:** `F-002`
**機能名:** 明示的なゼロタイムアウト設定
**概要:** TOML設定で`timeout = 0`が明示的に設定された場合、タイムアウトなしで実行する
**詳細:**
- TOML設定で`timeout = 0`が明示的に記述されている場合
- Goコード内で`0`の値を持つポインタとして表現される
- 実行時にタイムアウト処理を適用しない（無制限実行）

#### **機能ID:** `F-003`
**機能名:** 正の値タイムアウト設定
**概要:** TOML設定で正の値が設定された場合、その秒数でタイムアウトする
**詳細:**
- TOML設定で`timeout = N`（Nは正の整数）が設定された場合
- Goコード内で`N`の値を持つポインタとして表現される
- 実行時にN秒後にタイムアウト処理を実行する

#### **機能ID:** `F-004`
**機能名:** 階層的タイムアウト継承
**概要:** グループレベル、コマンドレベルでのタイムアウト設定オーバーライド
**詳細:**
- コマンドレベル > グループレベル > グローバルレベルの優先順位
- 各レベルで未設定、ゼロ設定、正の値設定が可能
- より具体的なレベルの設定が優先される

#### **機能ID:** `F-005`
**機能名:** 負の値の検証エラー
**概要:** 負の値が設定された場合、設定ファイル読み込み時にエラーとする
**詳細:**
- TOML設定で`timeout = -1`等の負の値が設定された場合
- 設定ファイルのバリデーション段階でエラーを発生させる
- エラーメッセージで有効な値の範囲を明示する

### 3.2. 動作仕様

#### 3.2.1. TOML設定とGo内部表現の対応

| TOML設定 | Go内部表現 | 実行時動作 |
|---------|-----------|-----------|
| 設定なし | `nil` | デフォルト60秒タイムアウト |
| `timeout = 0` | `*int(0)` | タイムアウトなし（無制限） |
| `timeout = N` (N>0) | `*int(N)` | N秒タイムアウト |
| `timeout = -N` (N>0) | 設定エラー | エラーで実行中止 |

#### 3.2.2. タイムアウト解決ロジック

```
実効タイムアウト値の決定:
1. コマンドレベルのタイムアウト設定を確認
   - 設定あり → その値を使用
   - 設定なし → 次へ
2. グループレベルのタイムアウト設定を確認
   - 設定あり → その値を使用
   - 設定なし → 次へ
3. グローバルレベルのタイムアウト設定を確認
   - 設定あり → その値を使用
   - 設定なし → デフォルト値（60秒）を使用

各レベルでの「設定あり」の判定:
- 未設定（nil）: 設定なし
- 明示的ゼロ（*int(0)）: 設定あり（タイムアウトなし）
- 正の値（*int(N)）: 設定あり（N秒タイムアウト）
```

## 4. 非機能要件 (Non-Functional Requirements)

### 4.1. パフォーマンス要件
- 設定ファイル読み込み時間: 既存実装から5%以内の増加
- 実行時オーバーヘッド: タイムアウト判定処理で1ms以内の追加コスト

### 4.2. 信頼性要件
- タイムアウト機能の既存動作を100%維持
- 設定エラー時の適切なエラーメッセージ表示
- 無制限実行時のリソース枯渇防止（運用上の注意喚起）

### 4.3. 保守性要件
- 既存テストケースの100%パス（新機能追加を除く）
- 新機能に対する包括的なテストカバレッジ（95%以上）
- 明確で理解しやすいエラーメッセージ

### 4.4. 互換性要件
- 後方互換性: 既存の設定ファイルで期待される動作の変更
  - `timeout = 0`の動作変更は破壊的変更として扱う
  - ドキュメントで明確に変更点を説明する
- Go APIの変更: 内部APIの破壊的変更は許容される

## 5. 技術要件 (Technical Requirements)

### 5.1. データ型変更
- `GlobalSpec.Timeout`: `int` → `*int`
- `CommandSpec.Timeout`: `int` → `*int`
- 関連する構造体の同様フィールドも対応

### 5.2. 実装箇所
- `internal/runner/runnertypes/spec.go`: 構造体定義変更
- `internal/runner/runnertypes/runtime.go`: タイムアウト取得ロジック変更
- `internal/runner/config/`: TOML読み込み処理
- 実行エンジン: タイムアウト制御ロジック

### 5.3. バリデーション
- 負の値の検証ロジック追加
- 設定値の妥当性チェック強化
- エラーメッセージの改善

## 6. ユーザーインターフェース要件 (User Interface Requirements)

### 6.1. エラーメッセージ
```
無効な設定例:
timeout = -1

期待されるエラーメッセージ:
Invalid timeout value: -1. Timeout must be a non-negative integer (0 for no timeout, positive values for timeout in seconds).
```

### 6.2. ログ出力
- タイムアウトなし実行時の警告ログ
- 実際に使用されるタイムアウト値のデバッグログ

## 7. テスト要件 (Test Requirements)

### 7.1. 単体テスト
- [ ] TOML未設定時のデフォルト値取得
- [ ] `timeout = 0`設定時の無制限動作
- [ ] 正の値設定時の正常動作
- [ ] 負の値設定時のエラー処理
- [ ] 階層的継承の正常動作

### 7.2. 統合テスト
- [ ] 実際のコマンド実行でのタイムアウト動作
- [ ] 長時間実行コマンドでの無制限動作
- [ ] 設定ファイル読み込みから実行までの一連の流れ

### 7.3. 回帰テスト
- [ ] 既存のタイムアウト設定での動作確認
- [ ] 他の設定項目との相互作用確認

## 8. ドキュメント更新要件 (Documentation Requirements)

### 8.1. 更新対象ドキュメント
- `docs/user/toml_config/04_global_level.md`: グローバルレベル設定説明
- `docs/user/toml_config/04_global_level.ja.md`: 日本語版
- `docs/user/toml_config/06_command_level.md`: コマンドレベル設定説明
- `docs/user/toml_config/06_command_level.ja.md`: 日本語版
- `README.md`: クイックスタート例
- `CHANGELOG.md`: 破壊的変更の記録

### 8.2. 更新内容
- タイムアウト設定の新しい仕様説明
- 設定例の追加（特に`timeout = 0`の使用例）
- 既存設定からの移行ガイド
- 破壊的変更の明確な説明

## 9. リスク分析 (Risk Analysis)

### 9.1. 高リスク
- **破壊的変更**: `timeout = 0`の動作変更により既存ユーザーに影響
- **軽減策**: 明確なドキュメント化、CHANGELOGでの告知

### 9.2. 中リスク
- **無制限実行**: `timeout = 0`設定時のリソース枯渇
- **軽減策**: ドキュメントでの注意喚起、適切な運用ガイド提供

### 9.3. 低リスク
- **型変更による内部エラー**: ポインタ型導入による nil 参照
- **軽減策**: 包括的な単体テスト、静的解析の活用

## 10. 実装計画 (Implementation Plan)

### 10.1. フェーズ1: 内部実装変更
1. データ型変更（`*int`の導入）
2. TOML読み込みロジック更新
3. タイムアウト解決ロジック実装
4. バリデーション強化

### 10.2. フェーズ2: テスト実装
1. 単体テスト追加・更新
2. 統合テスト実装
3. 回帰テスト実行

### 10.3. フェーズ3: ドキュメント更新
1. 技術文書更新
2. ユーザーガイド更新
3. サンプル設定ファイル更新

### 10.4. フェーズ4: 検証・リリース
1. 機能テスト実行
2. パフォーマンステスト
3. ドキュメントレビュー
4. リリースノート作成

## 11. 成功基準 (Success Criteria)

- [ ] 3つのタイムアウト設定パターン（未設定、ゼロ、正の値）が期待通りに動作する
- [ ] 既存のタイムアウト機能が正常に動作し続ける
- [ ] 負の値設定時に適切なエラーが発生する
- [ ] 全テストケースがパスする
- [ ] ドキュメントが更新され、新機能が適切に説明されている
- [ ] 破壊的変更が明確に文書化されている

## 12. 受け入れテスト (Acceptance Tests)

### 12.1. シナリオ1: デフォルトタイムアウト
```toml
version = "1.0"
# timeout 未設定

[[groups]]
name = "test"
[[groups.commands]]
name = "sleep_30"
cmd = "/bin/sleep"
args = ["30"]
```
**期待結果**: 60秒後にタイムアウトして終了

### 12.2. シナリオ2: 無制限実行
```toml
version = "1.0"
[global]
timeout = 0

[[groups]]
name = "test"
[[groups.commands]]
name = "sleep_120"
cmd = "/bin/sleep"
args = ["120"]
```
**期待結果**: 120秒待ってから正常終了（タイムアウトしない）

### 12.3. シナリオ3: カスタムタイムアウト
```toml
version = "1.0"
[global]
timeout = 30

[[groups]]
name = "test"
[[groups.commands]]
name = "sleep_45"
cmd = "/bin/sleep"
args = ["45"]
```
**期待結果**: 30秒後にタイムアウトして終了

### 12.4. シナリオ4: 設定エラー
```toml
version = "1.0"
[global]
timeout = -1
```
**期待結果**: 設定ファイル読み込み時にエラーが発生
