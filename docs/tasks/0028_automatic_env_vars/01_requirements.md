# 要件定義書: 自動環境変数設定機能

## 1. 概要

runnerが子プロセスを実行する際に、TOMLファイルで指定された環境変数に加えて、システムが自動的に設定する環境変数を追加する機能を実装する。

## 2. 目的

- 子プロセスに実行コンテキスト情報を提供する
- ログファイル名やタイムスタンプ付きファイル名の生成を容易にする
- 実行時の追跡可能性を向上させる

## 3. 機能要件

### 3.1 自動設定される環境変数

以下の環境変数を自動的に設定する：

| 環境変数名 | 内容 | 例 |
|-----------|------|-----|
| `__RUNNER_DATETIME` | 設定ファイルロード時の日時（UTC） | `20251005143022.123` |
| `__RUNNER_PID` | runnerプロセスのPID | `12345` |

### 3.2 日時フォーマット仕様

`__RUNNER_DATETIME` のフォーマット：
- 形式: `YYYYMMDDHHmmSS.msec`
- `YYYY`: 年（4桁）
- `MM`: 月（2桁、ゼロパディング）
- `DD`: 日（2桁、ゼロパディング）
- `HH`: 時（2桁、ゼロパディング、24時間制）
- `mm`: 分（2桁、ゼロパディング）
- `SS`: 秒（2桁、ゼロパディング）
- `.`: 区切り文字
- `msec`: ミリ秒（3桁、`%03d`フォーマット、000-999）
- タイムゾーン: UTC
- 例: `20251005143022.123`

### 3.3 設定タイミング

- 設定ファイルのロード時に生成する
- すべてのコマンドで同一の`__RUNNER_DATETIME`値を使用する（設定ロード時点の時刻で固定）
- dry-runモードでも同様に設定する（設定ロード時点の日時を使用）
- 変数展開（`${__RUNNER_DATETIME}`）は設定ロード時に実行される

### 3.4 環境変数の優先順位と保護

- `__RUNNER_` プレフィックスを持つ環境変数は予約済みとする
- TOMLファイルで `__RUNNER_` プレフィックスを持つ環境変数を指定した場合、エラーとする
- エラーメッセージ: 予約された環境変数プレフィックスの使用を明示的に通知する

### 3.5 セキュリティ要件

- 自動設定される環境変数はredaction対象外とする
- 他の環境変数と同様に監査ログに記録する
- 環境変数の値は改ざん不可能とする（TOMLでの上書き禁止）

## 4. 非機能要件

### 4.1 パフォーマンス

- 環境変数の設定による実行時間への影響は最小限とする
- 日時取得は設定ロード時に1回のみ行う
- すべてのコマンドで同一の自動環境変数を使用することで、オーバーヘッドを最小化する

### 4.2 互換性

- 既存のTOMLファイルとの後方互換性を維持する
- `__RUNNER_` プレフィックスを使用していない既存のTOMLファイルは変更なく動作する

### 4.3 拡張性

- 将来的に追加の自動環境変数を容易に追加できる設計とする
- 予約プレフィックスの検証ロジックは拡張可能とする

## 5. 制約事項

- 現時点では `DATETIME` と `PID` の2つの環境変数のみを実装する
- 将来的な拡張候補（現時点では実装しない）：
  - `__RUNNER_CONFIG_FILE`: 設定ファイルパス
  - `__RUNNER_COMMAND_NAME`: コマンド名
  - `__RUNNER_GROUP_NAME`: グループ名
  - `__RUNNER_USER`: 実行ユーザー名
  - `__RUNNER_HOSTNAME`: ホスト名

## 6. 成功基準

- [x] 子プロセスで `__RUNNER_DATETIME` と `__RUNNER_PID` が正しく設定される
- [x] 日時フォーマットが仕様通り（`YYYYMMDDHHmmSS.msec`形式、UTC）である
- [x] TOMLファイルで予約プレフィックスを使用した場合にエラーが発生する
- [x] dry-runモードでも正しく環境変数が設定される
- [x] 既存のテストが全て通過する
- [x] 新機能に対する包括的なテストが追加される

## 7. ユースケース

### ユースケース1: タイムスタンプ付きログファイル生成

```toml
[[commands]]
name = "backup"
command = "/usr/bin/tar"
args = ["czf", "/backup/data-${__RUNNER_DATETIME}.tar.gz", "/data"]
```

変数展開後: `/backup/data-20251005143022.123.tar.gz`

### ユースケース2: PIDを含むロックファイル

```toml
[[commands]]
name = "process"
command = "/usr/bin/process"
env = { LOCKFILE = "/var/run/process-${__RUNNER_PID}.lock" }
```

### ユースケース3: エラー時の検証

```toml
[[commands]]
name = "invalid"
command = "/usr/bin/test"
env = { __RUNNER_CUSTOM = "value" }  # エラー: 予約プレフィックス
```

期待される動作: 設定ロード時にエラー

## 8. 関連ドキュメント

- 既存の変数展開機能: `docs/tasks/0026_variable_expansion/`
- 環境変数管理: `internal/runner/environment/`
- 設定ファイル検証: `internal/runner/config/`
