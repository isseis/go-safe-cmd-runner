# 実装計画書：設定ファイル検証タイミングの修正

## 1. 概要 (Overview)

本ドキュメントは、go-safe-cmd-runnerにおける設定ファイル検証タイミング修正の段階的実装計画を定義する。

## 2. 実装方針

### 2.1. 基本方針

- **段階的実装**: TDDアプローチで段階的に進める
- **既存コード活用**: verification.Manager等の既存コンポーネントを最大限活用
- **最小変更**: 修正範囲を最小限に抑え、既存動作への影響を削減
- **セキュリティファースト**: 各段階でセキュリティ検証を徹底

### 2.2. 実装順序（TDD原則に基づく）

**注意**: TDD原則に従い、各機能の実装前に必ずテストを先行実装する

1. **ハッシュディレクトリ検証機能（テスト先行）** - セキュリティクリティカル
   - テスト実装 → 機能実装 → テスト通過確認
2. **ファイル検証フロー（テスト先行）** - 設定ファイルとエンバイロメントファイル
   - テスト実装 → 機能実装 → テスト通過確認
3. **実行フロー修正（テスト先行）** - main.go内の実行順序変更
   - 統合テスト実装 → フロー修正 → テスト通過確認
4. **エラーハンドリング強化（テスト先行）** - stderr出力とエラー分類
   - テスト実装 → 機能実装 → テスト通過確認

## 3. 実装スケジュール

### 3.1. フェーズ1: 基盤実装 (Phase 1: Foundation)

#### 3.1.1. ハッシュディレクトリ検証機能実装

**目標**: TOCTOU脆弱性を回避したセキュアなハッシュディレクトリ検証機能を実装

- [x] **ハッシュディレクトリ解決関数実装**
  - [x] `getHashDirectoryWithValidation()` 関数実装
  - [x] 優先順位付きディレクトリ取得ロジック
  - [x] コマンドライン引数 → 環境変数 → デフォルト値の順

- [x] **TOCTOU脆弱性回避セキュリティ検証機能実装**
  - [x] `validateHashDirectorySecurely()` 関数実装
  - [x] 絶対パス検証機能
  - [x] シンボリックリンク攻撃防御機能（safefileio活用）
  - [x] **TOCTOU対策ディレクトリ検証機能**：`os.Stat()`の代わりに
    - [x] `os.Lstat()`を使用したシンボリンク対応検証実装
    - [x] 直接的なディレクトリ検証でTOCTOU攻撃を回避
    - [x] チェックと使用の間にファイルシステム変更の余地を排除

- [x] **エラーハンドリング実装**
  - [x] `HashDirectoryError` 型定義
  - [x] 詳細エラー分類機能
  - [x] エラーメッセージテンプレート定義

**期待される成果物**:
- ハッシュディレクトリ検証機能（完全動作）
- エラーハンドリング機能
- 基本セキュリティテスト実装

#### 3.1.2. テストファーストアプローチでの単体テスト実装

**目標**: TDD原則に従いテストを先行実装

- [x] **ハッシュディレクトリ検証テスト**
  - [x] `TestGetHashDirectoryWithValidation` 実装
  - [x] 正常系：コマンドライン引数、環境変数、デフォルト値
  - [x] 異常系：相対パス、存在しないディレクトリ、権限不足

- [x] **セキュリティ検証テスト**
  - [x] `TestValidateHashDirectorySecurely` 実装
  - [x] シンボリックリンク攻撃テスト
  - [x] パーミッション検証テスト
  - [x] **TOCTOU攻撃対策検証テスト**
    - [x] シンボリンク攻撃防御テストの実装
    - [x] `os.Lstat()` 方式の安全性確認テスト
    - [x] ディレクトリ検証の安全性テスト

- [x] **テスト実行確認**
  - [x] 全テストが成功することを確認（実装完了後の動作検証）
  - [x] テスト修正（必要に応じて）
  - [x] テスト設計確認とコミット

**期待される成果物**:
- 包括的単体テストスイート
- テスト駆動開発環境の確立

### 3.2. フェーズ2: コア機能実装 (Phase 2: Core Implementation)

#### 3.2.1. ファイル検証フロー実装

**目標**: 設定ファイル・環境ファイル検証フローを実装

- [x] **設定ファイル検証機能**
  - [x] `performConfigFileVerification()` 関数実装
  - [x] verification.Manager連携機能
  - [x] クリティカルエラーハンドリング

- [x] **環境ファイル検証機能**
  - [x] `performEnvironmentFileVerification()` 関数実装
  - [x] 非クリティカル警告処理
  - [x] 実行継続ロジック

- [x] **検証管理機能**
  - [x] `initializeVerificationManager()` 関数実装
  - [x] verification.Manager初期化タイミング調整

**期待される成果物**:
- ファイル検証機能（設定・環境両方）
- verification.Manager連携機能

#### 3.2.2. 強制stderr出力機能

**目標**: セキュリティクリティカルなエラーの確実な出力

- [x] **強制出力機能実装**
  - [x] `logCriticalToStderr()` 関数実装
  - [x] ログレベルに依存しない出力機能
  - [x] タイムスタンプ付きエラーフォーマット

- [x] **エラー分類システム**
  - [x] クリティカル vs. 非クリティカル判定
  - [x] ErrorType拡張（設定検証・環境検証）
  - [x] エラーメッセージ標準化

**期待される成果物**:
- 強制stderr出力機能
- 統一エラーハンドリング機能

### 3.3. フェーズ3: 実行フロー統合 (Phase 3: Execution Flow Integration)

#### 3.3.1. main.go実行フロー修正

**目標**: セキュアな実行順序への全面的変更

- [ ] **新しいrun()関数実装**
  - [ ] セキュア実行フロー実装
  - [ ] 検証→読み込み順序の徹底
  - [ ] 段階的失敗ハンドリング

- [ ] **既存フロー削除**
  - [ ] 古い`getHashDir()`関数削除
  - [ ] 設定ファイル依存初期化処理削除
  - [ ] 未検証データ使用箇所の完全除去

- [ ] **補助関数実装**
  - [ ] `determineEnvironmentFile()` 関数実装
  - [ ] `loadSlackWebhookFromVerifiedEnv()` 関数実装
  - [ ] `setupVerifiedLogger()` 関数実装

**期待される成果物**:
- 完全に修正されたmain.go
- セキュアな実行フロー
- 既存脆弱性の完全除去

#### 3.3.2. 設定読み込みタイミング調整

**目標**: 検証後読み込みへの確実な変更

- [ ] **設定読み込み順序修正**
  - [ ] config.LoadConfig()実行タイミング変更
  - [ ] 環境ファイル読み込みタイミング変更
  - [ ] ログシステム初期化タイミング変更

- [ ] **依存関係整理**
  - [ ] 検証済みデータのみ使用の徹底
  - [ ] 未検証データアクセスの完全排除
  - [ ] 信頼境界の明確化

**期待される成果物**:
- 修正された初期化フロー
- 確実な検証→読み込み順序

### 3.4. フェーズ4: テスト・検証実装 (Phase 4: Testing & Validation)

#### 3.4.1. 統合テスト実装

**目標**: 全フロー統合テストの実装

- [ ] **正常系統合テスト**
  - [ ] `TestSecureExecutionFlow` 実装
  - [ ] 全検証成功シナリオ
  - [ ] エンドツーエンドテスト

- [ ] **異常系統合テスト**
  - [ ] 設定ファイル検証失敗テスト
  - [ ] 環境ファイル検証警告テスト
  - [ ] ハッシュディレクトリ検証失敗テスト

- [ ] **検証フロー統合テスト**
  - [ ] `TestVerificationIntegration` 実装
  - [ ] 複数検証ステップのテスト
  - [ ] エラー伝播テスト

**期待される成果物**:
- 包括的統合テストスイート
- エンドツーエンド動作検証

#### 3.4.2. セキュリティテスト実装

**目標**: セキュリティ脆弱性対策の検証

- [ ] **攻撃シナリオテスト**
  - [ ] 悪意のある設定ファイルテスト
  - [ ] 悪意のある環境ファイルテスト
  - [ ] シンボリックリンク攻撃テスト
  - [ ] TOCTOU攻撃対策テスト

- [ ] **セキュリティ境界テスト**
  - [ ] 信頼境界検証テスト
  - [ ] 未検証データ使用防止テスト
  - [ ] 強制終了機能テスト

**期待される成果物**:
- セキュリティテストスイート
- 攻撃シナリオ対策検証

### 3.5. フェーズ5: 最終検証・デプロイ準備 (Phase 5: Final Validation & Deployment)

#### 3.5.1. 包括的品質確認

**目標**: 実装品質の最終確認

- [ ] **コード品質検証**
  - [ ] `make lint` 実行とエラー修正
  - [ ] `make fmt` 実行と体裁整理
  - [ ] `make test` 実行と全テスト成功確認

- [ ] **パフォーマンス検証**
  - [ ] 起動時間測定（100ms未満の増加確認）
  - [ ] メモリ使用量確認（10MB未満増加確認）
  - [ ] ハッシュ計算時間測定

- [ ] **互換性確認**
  - [ ] 既存コマンドライン引数動作確認
  - [ ] 既存ハッシュファイル形式互換確認
  - [ ] エラーメッセージ一貫性確認

**期待される成果物**:
- 品質確認済み実装
- パフォーマンス検証結果
- 互換性確認結果

#### 3.5.2. ドキュメント整備

**目標**: 実装完了に伴う文書更新

- [x] **実装仕様書更新**
  - [x] 実装結果との差分確認
  - [x] 詳細仕様書の実装結果反映
  - [x] 実装計画書の完了マーク

- [ ] **運用ドキュメント更新**
  - [ ] 新しいコマンドライン引数説明
  - [ ] 環境変数設定方法説明
  - [ ] エラーメッセージ解説

**期待される成果物**:
- 更新された技術文書
- 運用マニュアル

## 4. 実装詳細計画

### 4.1. 実装順序詳細

#### 4.1.1. 実装段階1: ハッシュディレクトリ検証 [週1-2]

```go
// 実装対象ファイル: cmd/runner/main.go (新規関数追加)

// ステップ1: エラー型定義
type HashDirectoryError struct {
    Type  HashDirectoryErrorType
    Path  string
    Cause error
}

// ステップ2: 基本検証関数
func validateHashDirectorySecurely(path string) (string, error)

// ステップ3: 解決関数
func getHashDirectoryWithValidation() (string, error)

// ステップ4: テスト実装・実行
```

#### 4.1.2. 実装段階2: ファイル検証フロー [週2-3]

```go
// ステップ1: 検証管理関数
func initializeVerificationManager(hashDir, runID string) (*verification.Manager, error)

// ステップ2: 設定ファイル検証
func performConfigFileVerification(verificationManager *verification.Manager, runID string) error

// ステップ3: 環境ファイル検証
func performEnvironmentFileVerification(verificationManager *verification.Manager, envPath, runID string) error

// ステップ4: 強制stderr出力
func logCriticalToStderr(component, message string, err error)

// ステップ5: TOCTOU対策ディレクトリ検証関数
func validateHashDirectoryAccess(path string) error {
    // os.Stat()は使用しない
    // 代わりにos.Open()でディレクトリを開き、ファイルディスクリプタに対してfile.Stat()を実行
    // safefileioパッケージの設計思想に従ったTOCTOU対策を実装
}
```

#### 4.1.3. 実装段階3: 実行フロー修正 [週3-4]

```go
// ステップ1: 新しいrun()関数実装
func run(runID string) error {
    // セキュアな実行フロー
}

// ステップ2: 補助関数群実装
func determineEnvironmentFile() (string, error)
func loadSlackWebhookFromVerifiedEnv(envFile string) (string, error)
func setupVerifiedLogger(slackWebhookURL, runID string) error

// ステップ3: 既存関数削除
// getHashDir()等の削除
```

### 4.2. テスト実装計画

#### 4.2.1. 単体テスト実装スケジュール

- **週1**: ハッシュディレクトリ検証テスト
- **週2**: ファイル検証フロー テスト
- **週3**: 統合テスト実装
- **週4**: セキュリティテスト実装

#### 4.2.2. テストカバレッジ目標

- **単体テスト**: 新規実装関数の100%カバレッジ
- **統合テスト**: 全実行フローの90%カバレッジ
- **セキュリティテスト**: 主要攻撃シナリオの100%カバレッジ

## 5. 品質管理計画

### 5.1. 各段階での品質確認

#### 5.1.1. 実装段階チェック項目

各実装段階完了時に以下を確認：

- [ ] **コードレビュー基準**
  - [ ] 既存コード スタイルとの一貫性
  - [ ] エラーハンドリングの適切さ
  - [ ] セキュリティ設計原則の遵守

- [ ] **テスト品質基準**
  - [ ] テストケース網羅性
  - [ ] エッジケーステスト実装
  - [ ] 失敗シナリオテスト実装

- [ ] **動作確認基準**
  - [ ] `make test` 全テスト成功
  - [ ] `make lint` エラーゼロ
  - [ ] 基本動作テスト（手動）

#### 5.1.2. 継続的品質管理

- **毎日**: 実装コードのlint/format実行
- **実装段階完了時**: 包括的テスト実行
- **週末**: 進捗確認と品質レビュー

### 5.2. 品質基準詳細

#### 5.2.1. コード品質基準

- **可読性**: 関数・変数名の適切性、コメントの充実
- **保守性**: 単一責任の原則、適切な関数分割
- **セキュリティ**: 入力検証の徹底、エラー情報の適切な制御

#### 5.2.2. テスト品質基準

- **網羅性**: 正常系・異常系の両方をカバー
- **独立性**: テスト間の依存関係なし
- **再現性**: 任意の環境での実行可能性

## 6. リスク管理計画

### 6.1. 想定リスクと対策

#### 6.1.1. 技術リスク

**リスク1: TOCTOU脆弱性回避実装の複雑性**
- **影響**: セキュリティ検証機能の実装遅延・品質低下
- **対策**: safefileioパッケージの`os.Open()`+`file.Stat()`パターン適用
- **回避策**: 段階的実装・包括的TOCTOU攻撃テストの実装

**リスク2: 既存safefileio APIの理解不足**
- **影響**: セキュリティ検証機能の実装遅延
- **対策**: 実装前にAPIドキュメント・既存コード詳細調査
- **回避策**: 段階的実装による早期問題発見

**リスク3: verification.Manager API変更の必要性**
- **影響**: 既存実装への予期しない影響
- **対策**: API調査の徹底、必要最小限の変更
- **回避策**: Wrapper関数による影響局限化

#### 6.1.2. 品質リスク

**リスク4: 回帰バグの発生**
- **影響**: 既存機能の動作不良
- **対策**: 包括的回帰テスト実装
- **回避策**: 段階的統合による問題範囲限定

**リスク5: パフォーマンス劣化**
- **影響**: アプリケーション起動時間増加
- **対策**: 各段階でのパフォーマンス測定
- **回避策**: 最適化可能な実装選択

### 6.2. リスク監視指標

- **実装進捗遅延**: 週次進捗が10%以下
- **テスト失敗率**: 新規テストの失敗率30%以上
- **品質指標悪化**: lint エラー5個以上、テストカバレッジ85%以下

## 7. コミット・マージ戦略

### 7.1. 段階的コミット戦略

#### 7.1.1. コミット単位

- **機能単位**: 各関数の実装完了時
- **テスト単位**: テスト実装・修正完了時
- **フェーズ単位**: 各フェーズ完了時の統合コミット

#### 7.1.2. コミットメッセージ規則

```
[phase-N] <type>: <description>

Examples:
[phase-1] feat: implement hash directory validation with security checks
[phase-1] test: add comprehensive tests for hash directory validation
[phase-2] feat: add file verification flow with critical error handling
[phase-3] refactor: restructure main execution flow for security
[phase-4] test: add integration tests for secure execution flow
[phase-5] docs: update implementation plan with completion status
```

### 7.2. ブランチ戦略

- **開発ブランチ**: `feature/config-verification-timing`
- **段階ブランチ**: 各フェーズで個別ブランチ作成（必要に応じて）
- **マージ**: 全フェーズ完了後にmainブランチへマージ

## 8. 完了基準 (Definition of Done)

### 8.1. 機能完了基準

- [ ] **セキュリティ要件満足**
  - [ ] 未検証データによるシステム動作完全排除
  - [ ] 設定ファイル検証の事前実行
  - [ ] ハッシュディレクトリ検証の適切な実施

- [ ] **機能要件満足**
  - [ ] F-001からF-006まで全機能実装完了
  - [ ] 強制stderr出力機能動作確認
  - [ ] 実行フロー順序保証確認

- [ ] **品質要件満足**
  - [ ] 全単体テスト成功
  - [ ] 全統合テスト成功
  - [ ] 全セキュリティテスト成功
  - [ ] `make lint`, `make test` エラーゼロ

### 8.2. 非機能要件満足基準

- [ ] **パフォーマンス基準**
  - [ ] 起動時間増加100ms未満確認
  - [ ] メモリ使用量増加10MB未満確認

- [ ] **互換性基準**
  - [ ] 既存コマンドライン引数動作確認
  - [ ] 既存ハッシュファイル形式互換確認

### 8.3. 文書完了基準

- [ ] **技術文書更新**
  - [ ] 実装結果の仕様書への反映
  - [ ] 実装計画書の完了ステータス更新

この実装計画書に従って段階的に実装を進めることで、セキュリティ脆弱性を完全に解決し、信頼性の高いシステムを構築できます。
