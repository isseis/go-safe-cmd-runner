# 要件定義書：設定ファイル検証タイミングの修正

## 1. 概要 (Overview)

**目的:** このドキュメントは、go-safe-cmd-runnerにおける設定ファイル検証タイミングのセキュリティ脆弱性を修正するための要件を定義する。

**背景:**
現在の実装では、設定ファイルのハッシュ検証が実行される前に、未検証の設定ファイルの内容に基づいてシステムの重要な初期化処理が行われている。これにより、悪意のある設定ファイルを通じて作業ディレクトリの操作、ログレベルの変更、検証対象ファイルの操作などが可能となり、深刻なセキュリティ脆弱性が存在する。

## 2. 目的とスコープ (Goals and Scope)

### 2.1. 目的 (Goals)

- 未検証の設定ファイル内容に基づくシステム動作を完全に排除する
- 設定ファイルのハッシュ検証を設定読み込みより前に実行する
- 検証に必要な情報（ハッシュディレクトリ等）をコマンドライン引数または環境変数から取得する
- 設定ファイルからハッシュディレクトリ指定機能を削除する（後方互換性を破る変更）

### 2.2. スコープ (In Scope)

- `cmd/runner/main.go`の実行フローの修正
- 設定ファイルのハッシュ検証タイミングの変更
- 環境ファイルのハッシュ検証タイミングの変更
- コマンドライン引数処理の改善
- `verification.Manager`の初期化タイミングの調整
- 関連するエラーハンドリングの更新

### 2.3. スコープ外 (Out of Scope)

- 設定ファイルの構造変更（ハッシュディレクトリ指定の削除は除く）
- ハッシュ検証アルゴリズムの変更
- デジタル署名機能の追加
- 既存の`config.LoadConfig()`の内部実装変更
- グローバルファイル検証のタイミング変更（現在のタイミングは適切なため対象外）

## 3. 機能要件 (Functional Requirements)

### 3.1. 機能一覧

- **機能ID:** `F-001`
- **機能名:** 設定検証パラメータの多重取得方法
- **概要:** 設定ファイル検証に必要なハッシュディレクトリを以下の優先順位で取得する：
  1. コマンドライン引数 `--hash-directory`（最高優先度）
  2. 環境変数 `GO_SAFE_CMD_RUNNER_HASH_DIRECTORY`（中優先度）
  3. デフォルト値（最低優先度）

  **検証要件**: 各段階で取得された値は絶対パス検証とディレクトリ存在確認を実施し、検証に失敗した場合は明確なエラーメッセージを出力して即座に失敗させる。

- **機能ID:** `F-002`
- **機能名:** 早期検証管理システム初期化
- **概要:** 設定ファイル読み込み前に`verification.Manager`を初期化し、検証可能な状態にする。

- **機能ID:** `F-003`
- **機能名:** 設定ファイル事前検証
- **概要:** `config.LoadConfig()`実行前に設定ファイルのハッシュ検証を実行し、改ざんを検出する。

- **機能ID:** `F-003-ENV`
- **機能名:** 環境ファイル事前検証
- **概要:** 環境ファイルの内容を使用前（特にSlack WebhookURL等の機密設定読み取り前）にハッシュ検証を実行し、改ざんを検出する。

- **機能ID:** `F-004`
- **機能名:** 検証失敗時の安全な終了
- **概要:** 設定ファイルの検証に失敗した場合、未検証データを一切使用せずに安全にプログラムを終了する。

- **機能ID:** `F-005`
- **機能名:** 実行フロー順序の保証
- **概要:** 以下の順序でのみ実行されることを保証する：
  1. コマンドライン引数検証
  2. ハッシュディレクトリ検証
  3. verification.Manager初期化
  4. 設定ファイルハッシュ検証
  5. 環境ファイルハッシュ検証
  6. 設定ファイル読み込み
  7. 環境ファイルからの設定読み込み（Slack WebhookURL等）
  8. その他の初期化処理

- **機能ID:** `F-006`
- **機能名:** 検証失敗時の強制stderr出力
- **概要:** 設定ファイルの検証失敗時は、ログレベル設定に関わらず必ず標準エラー出力（stderr）にエラーメッセージを出力する。

## 4. 非機能要件 (Non-Functional Requirements)

### 4.1. 性能 (Performance)

- 設定ファイル検証によるプログラム起動時間の増加は100ms未満であること
- verification.Managerの重複初期化を避け、リソース効率を保つこと

### 4.2. セキュリティ (Security)

- 未検証の設定ファイル内容によるシステム動作を完全に防止すること
- ハッシュディレクトリの検証を設定ファイル読み込み前に完了すること
- 攻撃者が設定ファイルを通じて検証プロセスを迂回できないこと
- 設定ファイル検証失敗時に機密情報をログ出力しないこと
- 事前検証用環境変数は絶対パス検証、ディレクトリ存在確認等の適切な検証を実施すること
- 事前検証用環境変数の検証が失敗した場合、明確なエラーメッセージを出力して即座に失敗させること
- ハッシュディレクトリの取得・検証において、いずれの段階でも検証に失敗した場合はプログラムを安全に終了させること

### 4.3. 信頼性・可用性 (Reliability/Availability)

- 設定ファイル検証の失敗は明確なエラーメッセージと共に報告されること
- 権限不足による検証失敗時も適切にハンドリングされること
- システムの状態が不整合にならないよう原子的に処理されること
- 検証失敗時のエラーメッセージは標準エラー出力（stderr）への出力が保証されること
- ログレベル設定に依存しない出力を提供すること
- 検証失敗時の終了コードは非ゼロ（エラー状態）であること

### 4.4. 互換性 (Compatibility)

- 既存のコマンドライン引数との互換性を維持すること
- 既存のハッシュファイル形式との互換性を維持すること
- 設定ファイルからのハッシュディレクトリ指定は削除し、コマンドライン引数または環境変数での指定を必須とすること

### 4.5. 保守性 (Maintainability)

- 変更箇所を最小限に抑え、既存コードへの影響を削減すること
- 検証フローが理解しやすい形で実装されること
- エラーハンドリングが一貫した方式で実装されること

## 5. 制約条件 (Constraints)

- 使用言語はGoとし、既存のコードベースとの一貫性を保つこと
- 既存のライブラリ依存関係を変更しないこと
- ハッシュディレクトリはコマンドライン引数または環境変数での指定を必須とすること
- 設定ファイルの内容に依存した初期化処理は検証後に移動すること
- 設定ファイルからのハッシュディレクトリ指定削除以外では後方互換性を維持すること
- 検証失敗時の出力はログレベル設定の影響を受けないこと

## 6. セキュリティ要件詳細 (Detailed Security Requirements)

### 6.1. 攻撃シナリオと対策

**攻撃シナリオ1: 悪意のある作業ディレクトリ指定**
- 現状：設定ファイル内の`workdir`設定により任意のディレクトリが指定可能
- 対策：設定ファイル検証前に`workdir`設定を使用しない

**攻撃シナリオ2: ログレベル操作によるセキュリティイベント隠蔽**
- 現状：設定ファイル内の`log_level`設定により検証ログが隠蔽可能
- 対策1：設定ファイル検証前に`log_level`設定を使用しない
- 対策2：検証失敗時はログレベル設定に関わらず強制的に標準エラー出力（stderr）に出力

**攻撃シナリオ3: 検証対象ファイルの操作**
- 現状：設定ファイル内の`verify_files`設定により検証対象を操作可能
- 対策：設定ファイル検証後に`verify_files`設定を適用する

**攻撃シナリオ4: 悪意のある環境ファイルによる機密情報窃取**
- 現状：未検証の環境ファイル（.env）からSlack WebhookURL等が読み取られ、ロギングシステムに使用される
- 攻撃手法：攻撃者が.envファイルを改ざんして悪意のあるWebhookURLを指定し、検証失敗等のエラー情報を外部に送信させる
- 対策1：環境ファイルのハッシュ検証をその内容使用前に実行する
- 対策2：環境ファイル検証失敗時は外部通知機能を無効化する

### 6.2. 信頼境界 (Trust Boundary)

**信頼済み（検証・バリデーション後）**:
- コマンドライン引数（パス検証済み）
- 事前検証用環境変数（`GO_SAFE_CMD_RUNNER_HASH_DIRECTORY`等、パス検証済み）
- ハッシュファイル（整合性検証済み）
- 検証済み設定ファイル（ハッシュ検証通過済み）
- 検証済み環境ファイル（ハッシュ検証通過済み）

**未信頼（検証前または対象外）**:
- 未検証の設定ファイル
- 未検証の環境ファイル（.env等）
- アプリケーション動作用環境変数（許可リスト機構によるフィルタリング前）
- 外部ファイル（検証対象外）
- ユーザー入力データ

**信頼境界の原則**:
- 事前検証用環境変数は適切なパス検証を経た場合のみ信頼済みとする
- 他の環境変数は許可リスト機構を通過するまで未信頼として扱う
- 検証プロセス自体に影響を与える可能性のあるデータは特に厳格に検証する

## 7. 用語集 (Glossary)

- **設定ファイル検証**: 設定ファイルのハッシュ値を既知の正しい値と比較し、改ざんを検出する処理
- **verification.Manager**: ファイルのハッシュ検証を担当するコンポーネント
- **ハッシュディレクトリ**: ファイルのハッシュ値を格納するディレクトリ
- **未検証データ**: ハッシュ検証を通過していないファイルやデータ
- **信頼境界**: システム内で信頼できるデータと信頼できないデータの境界
- **GO_SAFE_CMD_RUNNER_HASH_DIRECTORY**: ハッシュディレクトリを指定する事前検証用環境変数（プレフィックス`GO_SAFE_CMD_RUNNER_`により他コマンドとの衝突を回避）
- **事前検証用環境変数**: 設定ファイル検証前に使用される環境変数群。適切なパス検証を経て信頼済みとなる
- **アプリケーション動作用環境変数**: 設定ファイル検証後にアプリケーション動作に使用される環境変数群。許可リスト機構によるフィルタリングが必要
- **設定値優先順位**: コマンドライン引数 > 環境変数 > デフォルト値の順で適用される仕組み
- **強制stderr出力**: ログレベル設定に関わらず、必ず標準エラー出力に出力される仕組み
