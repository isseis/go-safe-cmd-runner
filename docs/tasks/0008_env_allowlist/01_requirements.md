# 要件定義書: 環境変数安全化機能の実装

## 1. プロジェクト概要

### 1.1 背景
現在のgo-safe-cmd-runnerでは、環境変数の処理において以下のセキュリティリスクが存在する：

1. システム全体の環境変数を無条件に取り込んでいるため、潜在的なセキュリティリスクが存在する
2. 攻撃者が悪意のある環境変数を設定することで、実行されるコマンドに影響を与える可能性がある
3. 環境変数の解決プロセスが複雑で、参照の解決と値の追加を含む処理となっている
4. コマンド実行前の環境変数フィルタリングが不十分である

### 1.2 目的
- 設定ファイルで明示的に許可された環境変数のみを引き継ぐことで、セキュリティを向上させる
- 環境変数の処理を明確化し、今後のコードベースの維持を容易にする
- 後方互換性は考慮せず、設定の明快さを重視した設計とする

## 2. 機能要件

### 2.1 環境変数フィルタリング機能の実装
- [ ] 設定ファイルの global セクションに env_allowlist 配列を追加し、許可する環境変数を明示的に定義できるようにする
- [ ] 設定ファイルの groups セクションに env_allowlist 配列を追加し、グループ単位で許可する環境変数を明示的に定義できるようにする
- [ ] システム環境変数からの取り込みを、明示的に許可された変数のみに制限する
- [ ] 環境変数の階層的制御を以下のように定義する：
    - **グループレベル優先**: groups で env_allowlist が定義されている場合、その設定のみ有効（global の env_allowlist は無視）
    - **グローバル継承**: groups で env_allowlist が未定義の場合、global の env_allowlist を継承
    - **明示的拒否**: groups で env_allowlist = [] の場合、環境変数を一切使用しない
- [ ] 環境変数の適用優先順位を以下のように定義する：
    1. システム環境変数（許可されたもののみ）
    2. .env ファイルからの変数（許可されたもののみ）
    3. テンプレートの env 設定
    4. コマンド固有の env 設定

### 2.2 設定ファイル拡張
- [ ] GlobalConfig 構造体に EnvAllowlist フィールド（[]string型）を追加
- [ ] CommandGroup 構造体に EnvAllowlist フィールド（[]string型）を追加
- [ ] 設定ファイルの TOML 形式での env_allowlist 配列記述をサポート
- [ ] 設定ファイルの global セクションで env_allowlist が未定義の場合は空リスト扱いとし、環境変数を一切引き継がない
- [ ] 設定ファイルの groups セクションで env_allowlist が未定義の場合は、global の env_allowlist を継承する

### 2.3 環境変数解決処理の変更
- [ ] resolveEnvironmentVars 関数を変更し、許可された環境変数のみを処理するように修正
- [ ] .envファイルからの環境変数読み込み時にenv_allowlistによるフィルタリングを適用
- [ ] 許可されていない環境変数が参照された場合の適切なエラーハンドリングを実装
- [ ] グループレベルでの環境変数フィルタリング機能を実装
- [ ] デバッグ情報として、フィルタリングされた環境変数をログに出力

### 2.4 設定例の実装
以下の形式で設定ファイルに環境変数を明示的に定義：

```toml
[global]
env_allowlist = ["PATH", "HOME", "USER", "LANG", "TERM"]

# ケース1: グループ固有の制限（globalの設定は無視される）
[[groups]]
name = "web_server"
env_allowlist = ["PATH", "HOME", "NODE_ENV", "PORT"]

# ケース2: 明示的に環境変数なし（globalの設定は無視される）
[[groups]]
name = "secure_task"
env_allowlist = []

# ケース3: グローバル設定を継承
[[groups]]
name = "basic_task"
# env_allowlist未定義 → global.env_allowlist ["PATH", "HOME", "USER", "LANG", "TERM"]を継承
```

重要な仕様：
- groupsでenv_allowlistが定義されている場合（空リスト含む）、globalのenv_allowlistは無視される
- env_allowlist が未定義の場合は、環境変数を一切引き継がない（最大セキュリティ）

### 2.5 将来の拡張

#### 2.5.1 環境変数値の高度な検証機能
- **環境変数値のサニタイズ処理**: シェルインジェクション攻撃を防ぐため、境変数値に含まれる特殊文字のエスケープ処理や無害化処理を実装
- **値の内容検証**: 特定の環境変数（PATH、LD_LIBRARY_PATHなど）に対する値の妥当性検証機能
- **値の長さ制限の詳細化**: 環境変数ごとに異なる長さ制限を設定できる機能

#### 2.5.2 重要環境変数の特別処理
- **LD_LIBRARY_PATH等の検証**: 動的ライブラリパスの安全性検証
- **重要環境変数のパターンマッチング検証**: 予期しない値が設定されていないかの検証

#### 2.5.3 セキュリティ監査機能の強化
- **詳細な監査ログ**: 環境変数のフィルタリング履歴、値の変更履歴の記録
- **異常検知機能**: 通常とは異なる環境変数設定パターンの検出
- **定期的なセキュリティスキャン**: 設定ファイルの脆弱性自動検査

#### 2.5.4 バイパス攻撃対策
- **間接参照攻撃の防止**: 環境変数を通じた間接的な権限昇格攻撃の対策
- **エスケープシーケンス処理**: 環境変数値内のエスケープシーケンスの安全な処理
- **Unicode正規化**: 環境変数名・値のUnicode正規化による攻撃防止

#### 2.5.5 運用支援機能
- **テンプレートセット**: 一般的なアプリケーション（Web サーバー、データベース等）向けの環境変数設定テンプレート

#### 2.5.6 セキュリティテスト自動化
- **ペネトレーションテスト統合**: 環境変数関連の脆弱性テストの自動実行
- **設定ファイル脆弱性スキャン**: 設定ミスや潜在的なセキュリティ問題の自動検出
- **継続的セキュリティ監視**: 定期的なセキュリティ状態の評価とレポート生成

### 2.6 テンプレートレベルでのenv_allowlist設定について

#### 2.6.1 検討結果：採用しない

テンプレートレベル（例：`[templates.dev]`、`[templates.prod]`）での`env_allowlist`設定については検討を行ったが、以下の理由により**採用しない**方針とする。

#### 2.6.2 不採用の理由

**セキュリティ上の懸念**
- 環境変数制御の階層が4段階（global → groups → templates → commands）になることで、設定ミスのリスクが増加
- セキュリティ監査が複雑化し、脆弱性の見落としリスクが高まる
- 攻撃者によるテンプレート切り替えを通じた権限昇格の可能性

**実装・保守性の問題**
- 環境変数解決ロジックの複雑化により、バグの発生リスクが増加
- テストケースの組み合わせが指数的に増加し、品質保証が困難
- 設定ファイルの理解・メンテナンスが困難化

**設計原則との整合性**
- 本機能の核心である「デフォルト拒否」「シンプルな設計」という原則と矛盾
- KISS原則（Keep It Simple, Stupid）に反する過度な複雑化

#### 2.6.3 代替ソリューション

環境別での環境変数制御が必要な場合は、以下のアプローチを推奨する：

1. **環境別設定ファイル方式**（推奨）
   - `config-dev.toml`、`config-prod.toml`等に分離
   - 環境間の完全な分離によるセキュリティ境界の明確化

2. **環境別グループ方式**
   - 単一設定ファイル内でグループを環境別に分離
   - 例：`app-dev`、`app-prod`グループ

詳細な代替ソリューションについては、別途作成予定の実装ガイドを参照されたい。

## 3. 非機能要件

### 3.1 セキュリティ
- 許可されていない環境変数は一切引き継がない（デフォルト拒否）
- すべての環境変数ソース（システム環境変数、.envファイル）に対してenv_allowlistフィルタリングを適用
- env_allowlist に指定されていない環境変数が変数参照で使用された場合は、エラーとして処理を停止する
- 環境変数名の検証（英数字とアンダースコアのみ許可）
- 環境変数値の長さ制限（最大値を設定可能）
- セキュリティ監査ログの出力（どの環境変数が許可/拒否されたかを記録）

### 3.2 保守性
- 設定ファイルでの明示的な環境変数定義により、実行環境の依存関係を明確化
- 一貫性のある環境変数処理フローの実装
- 分かりやすいエラーメッセージとログ出力

### 3.3 パフォーマンス
- 環境変数フィルタリング処理のオーバーヘッドは最小限に抑制
- 大量の環境変数が定義されている場合でも効率的な処理を実現

## 4. 制約事項

### 4.1 技術的制約
- 後方互換性は考慮しない（breaking change として扱う）
- 既存の変数参照解決機能（${VAR}）は維持する
- すべての環境変数ソース（システム環境変数、.envファイル）に対してenv_allowlistフィルタリングを適用する
- TOMLライブラリ（pelletier/go-toml/v2）の仕様に準拠
- 既存のファイル権限検証機能は維持する

### 4.2 運用制約
- 設定ファイル更新時は必要に応じて env_allowlist の見直しを行う
- env_allowlist が未定義の場合は環境変数なしで実行される（デフォルト動作）
- 既存の設定ファイルは env_allowlist 追加によりセキュリティが向上する

### 4.3 移行制約
- 既存のデプロイメントでは env_allowlist 未定義により環境変数が使用できなくなる可能性
- 環境変数に依存する既存スクリプトは env_allowlist 追加で対応可能

## 5. 成功基準

### 5.1 完了基準
- Phase 1: 設定構造体拡張
    - [ ] GlobalConfig と CommandGroup への EnvAllowlist フィールド追加
    - [ ] TOML パース機能の拡張
    - [ ] 設定ファイル検証機能の更新
- Phase 2: 環境変数処理変更
    - [ ] resolveEnvironmentVars 関数の書き換え
    - [ ] .envファイル読み込み処理のセキュリティ強化（env_allowlistフィルタリング適用）
    - [ ] フィルタリング機能の実装
    - [ ] エラーハンドリングの改善
- Phase 3: 統合・テスト
    - [ ] 既存テストケースの更新
    - [ ] 新機能のテストケース追加
    - [ ] 統合テストの実装
    - [ ] サンプル設定ファイルの更新

### 5.2 品質基準
- すべてのユニットテストが pass
- 新機能のテストカバレッジが 90% 以上
- セキュリティテストによる脆弱性検証
- パフォーマンステストによる性能確認

## 6. リスク分析

### 6.0 重要なセキュリティリスク
- **環境変数インジェクション攻撃**: 攻撃者が.envファイルに悪意のある環境変数（例：LD_PRELOAD, LD_LIBRARY_PATH）を注入し、env_allowlistを迂回して任意のライブラリをロードさせる攻撃
    - 対策: .envファイルからの変数読み込み時にもenv_allowlistフィルタリングを必須とする
- **設定迂回攻撃**: env_allowlistで制限された環境変数を別のソース（.envファイル等）から取り込むことによる制限回避
    - 対策: すべての環境変数ソースに対して統一的なフィルタリングを適用

### 6.1 高リスク
- **環境変数依存の既存スクリプト**: env_allowlist未定義により環境変数が使用できなくなるリスク
    - 対策: 開発中プロダクトで外部ユーザーが使用していないため、対処しない。
- **環境変数設定漏れ**: 必要な環境変数を env_allowlist に追加し忘れることによる動作不良
    - 対策: 検証ツールの提供、明確なエラーメッセージの実装

### 6.2 中リスク
- **設定ファイルの複雑化**: env_allowlist 設定により設定ファイルが煩雑になる可能性
    - 対策: 明確な設定例とベストプラクティスの文書化
- **デバッグの困難化**: 環境変数フィルタリングによりデバッグが複雑になる可能性
    - 対策: 詳細なログ出力とデバッグモードの実装

### 6.3 低リスク
- **パフォーマンス影響**: 環境変数フィルタリング処理によるわずかな性能低下
    - 対策: 効率的なアルゴリズムの採用、ベンチマークテストによる検証

## 7. 依存関係

### 7.1 技術的依存
- pelletier/go-toml/v2 ライブラリ（TOMLパース）
- 既存の safefileio パッケージ（ファイル操作）
- 既存の runner パッケージ（コマンド実行）
- Go標準ライブラリ（os, strings パッケージ）

### 7.2 設定依存
- すべての設定ファイルに env_allowlist 設定が必要
- .env ファイルとの整合性確保が必要
- テンプレート設定との整合性確保が必要

## 8. 実装計画

### 8.1 Phase 1: 設定構造体拡張（期間: 2-3日）
1. runnertypes/config.go の GlobalConfig 構造体に EnvAllowlist フィールド追加
2. runnertypes/config.go の CommandGroup 構造体に EnvAllowlist フィールド追加
3. 設定ファイルの TOML パース機能拡張
4. 基本的な単体テスト作成

### 8.2 Phase 2: 環境変数処理変更（期間: 3-4日）
1. runner.go の resolveEnvironmentVars 関数を書き換え
2. .envファイル読み込み処理にenv_allowlistフィルタリングを追加
3. 環境変数フィルタリング機能の実装
4. エラーハンドリングとログ出力の改善
5. グループレベルでのフィルタリング実装

### 8.3 Phase 3: 統合・テスト（期間: 2-3日）
1. 既存テストケースの更新
2. 新機能の包括的テストケース追加
3. 統合テストとセキュリティテスト
4. サンプル設定ファイルとドキュメントの更新

## 9. 承認

本要件定義書の実装状況：

1. **環境変数安全化機能**: 未着手
    - Phase 1 (設定構造体拡張): 未着手
    - Phase 2 (環境変数処理変更): 未着手
    - Phase 3 (統合・テスト): 未着手
2. **移行ガイド**: 未着手

承認者: [プロジェクト責任者]
承認日: [承認日]
