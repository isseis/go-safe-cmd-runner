# タスク0034 作業ディレクトリ仕様の再設計 - ドキュメント体系

## 概要

タスク0034では、Go Safe Command Runner の作業ディレクトリ設定を抜本的に再設計します。

**主な改善**:
- 3階層から2階層への簡素化（Global/Group → Group/Command）
- デフォルトで一時ディレクトリを使用（セキュリティ向上）
- `%{__runner_workdir}` 予約変数による柔軟なパスアクセス
- `--keep-temp-dirs` フラグでデバッグを容易に

## ドキュメント構成

```
0034_workdir_redesign/
├── README.md                 ← このファイル（概要）
├── 01_requirements.md        ← 要件定義書
├── 02_architecture.md        ← アーキテクチャ設計書
└── 03_specification.md       ← 詳細仕様書
```

## 各ドキュメントの役割

### 01_requirements.md - 要件定義書

**対象者**: PM、QA、開発全体、ステークホルダー

**内容**:
- プロジェクト概要と背景
- 現在の問題点と課題
- 機能要件（F001～F007）
- 非機能要件（NF001～NF006）
- ユースケース（5つの実例）
- テスト要件（T001～T009）
- ドキュメント更新計画
- リスク管理
- 成功基準

**読む順序**: 最初に読む。ビジネス要件とテスト要件を理解するために必須。

### 02_architecture.md - アーキテクチャ設計書

**対象者**: 設計者、シニア開発者、レビュアー

**内容**:
- 設計目標と原則
- 現状分析（3階層の複雑性）
- 新アーキテクチャ（2階層への簡素化）
- コンポーネント図とシーケンス図
- 一時ディレクトリ管理のライフサイクル
- 変数展開機構の流れ
- ワークディレクトリ優先順位の決定マトリックス
- エラーハンドリング戦略
- セキュリティ考慮事項
- 統合アーキテクチャ（全体フロー図）
- 実装フェーズ（4段階）
- 設計パターン（Fail-Safe、Context、Strategy、Composition）

**読む順序**: 要件定義書の後に読む。設計の全体像と各コンポーネント間の連携を理解するために必須。

### 03_specification.md - 詳細仕様書

**対象者**: 実装者（Go開発者）

**内容**:
- 型定義（削除・追加フィールド）
- API 仕様（TempDirManager、GroupExecutor）
- ワークディレクトリ決定ロジック（アルゴリズム）
- 既存の変数展開機構の活用（config.ExpandString）
- 実装詳細（完全なコード例）
- コマンドラインオプション実装例
- ロギング仕様
- エラーハンドリング詳細
- パス検証
- TOML スキーマ
- テスト仕様（単体テスト、統合テスト）
- 実装チェックリスト

**読む順序**: アーキテクチャ設計書の後に読む。実装の詳細な手順を理解するために必須。

## 読み方ガイド

### 読み始める前に確認すること

```
要件定義書を読んで理解すること:
  ✓ 現在の問題点は何か
  ✓ 何を実装するのか（機能要件）
  ✓ テストは何を検証するのか

    ↓

アーキテクチャ設計書を読んで理解すること:
  ✓ 全体の構成と各コンポーネント
  ✓ コンポーネント間の連携
  ✓ データフロー（優先順位決定、変数展開、クリーンアップ）
  ✓ エラー時の動作

    ↓

詳細仕様書を読んで理解すること:
  ✓ インターフェースの定義
  ✓ 各メソッドの詳細
  ✓ コード実装例
  ✓ テストケース
```

### 質問別読み方

**「何をやるのか？」**
→ 01_requirements.md の「機能要件」セクション

**「なぜそうするのか？」**
→ 01_requirements.md の「背景と課題」、02_architecture.md の「現状分析」

**「全体的な構成は？」**
→ 02_architecture.md の「統合アーキテクチャ」と「実装フェーズ」

**「具体的に何を実装する？」**
→ 03_specification.md の「API 仕様」と「実装詳細」

**「テストは何を検証する？」**
→ 01_requirements.md の「テスト要件」、03_specification.md の「テスト仕様」

**「エラーはどう扱う？」**
→ 02_architecture.md の「エラーハンドリング戦略」、03_specification.md の「エラーハンドリング」

## 主要なコンセプト

### 3階層から2階層へ

**改善前（複雑）**:
```
優先順位:
1. Command.Dir
2. Group.TempDir = true
3. Group.WorkDir
4. Global.WorkDir
5. カレントディレクトリ

問題: ユーザーが優先順位を理解しづらい
```

**改善後（シンプル）**:
```
優先順位:
1. Command.WorkDir
2. Group.WorkDir
3. 自動生成一時ディレクトリ（デフォルト）

利点: 明確で理解しやすい、デフォルトで安全
```

### 自動変数による状態管理

グループ実行時のワークディレクトリは `group.ExpandedVars` に直接設定されます：

```go
// グループ実行開始時:
// ワークディレクトリを決定
workDir := resolveGroupWorkDir(group)  // "/tmp/scr-backup-XXXXXX"

// group.ExpandedVars に直接設定
group.ExpandedVars["__runner_workdir"] = workDir

// 変数展開時:
// config.ExpandString が group.ExpandedVars を使用
// → group.ExpandedVars["__runner_datetime"] = "20251018143025.123"
// → group.ExpandedVars["__runner_pid"] = "12345"
// → group.ExpandedVars["__runner_workdir"] = "/tmp/scr-backup-XXXXXX"
```

**利点**:
- シンプルで直接的な実装（余計な間接化がない）
- 新しい型が不要
- 既存の変数展開機構（`config.ExpandString`）をそのまま活用
- 一貫した変数管理（`__runner_datetime`, `__runner_pid` と同じパターン）

### Fail-Safe パターン

エラー時も確実にリソースのクリーンアップを実施：

```
GroupExecutor.ExecuteGroup():
  ├─ ワークディレクトリを決定（固定 or 一時）
  ├─ 一時ディレクトリの場合:
  │  ├─ TempDirManager.Create() で生成
  │  └─ defer mgr.Cleanup() 登録 ← 重要（Fail-Safe）
  ├─ group.ExpandedVars["__runner_workdir"] に直接設定
  ├─ コマンド実行ループ
  │  └─ エラー可能性
  └─ 終了時 → defer 実行（成功・失敗問わずクリーンアップ）
```

### %{__runner_workdir} 予約変数

グループのワークディレクトリを参照：

```toml
[[groups]]
name = "backup"
workdir = "%{backup_base}/data"           # OK: 他の変数参照
# workdir = "%{__runner_workdir}/sub"     # NG: 未定義変数エラー

[[groups.commands]]
name = "dump"
args = ["%{__runner_workdir}/dump.sql"]
# OK: コマンドレベルで参照可能
# → args = ["/var/backup/data/dump.sql"]
```

**変数展開の動作**:

| レベル | `__runner_workdir` 参照 | その他の変数参照 |
|--------|----------------------|----------------|
| グループ (`group.workdir`) | ❌ 不可（未定義エラー） | ✅ 可能 |
| コマンド (`cmd.*`) | ✅ 可能 | ✅ 可能 |

**dry-runモードでの検証**:
- 変数が定義されているか（変数マップに存在するか）で正当性を判断
- 構文的検証（絶対パス、パストラバーサル）は実行
- 存在チェック（ディレクトリが実在するか）はスキップ

## 実装フェーズ

| フェーズ | 内容 | 依存関係 |
|--------|------|--------|
| Phase 1 | 型定義・バリデーション | なし |
| Phase 2 | 一時ディレクトリ機能 | Phase 1 後 |
| Phase 3 | 変数展開機構 | Phase 1, 2 後 |
| Phase 4 | テスト・ドキュメント | Phase 1-3 後 |

## セキュリティの重点

- **デフォルト安全**: 指定なしなら一時ディレクトリ（情報残留を防止）
- **パーミッション**: 0700（所有者のみアクセス可能）
- **確実な削除**: エラー時も実施、削除失敗時もユーザーに通知
- **パストラバーサル対策**: 絶対パス要件、相対コンポーネント検出

## 関連タスク

- **Task 0033**: 内部変数とプロセス環境変数の分離（`%{}` 変数展開の基盤）
- **Task 0010**: テンプレート機能の削除（`TempDir`、`WorkDir` フィールド初出）

## 質問とサポート

ドキュメント内で不明な点がある場合：

1. 同じドキュメント内で検索（Ctrl+F）
2. 関連ドキュメントを参照（上記の読み方ガイド）
3. コード例を確認（詳細仕様書）

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|----------|--------|
| 2025-10-18 | 1.0 | 初版作成：3つのドキュメント完成 |
| 2025-10-18 | 1.1 | 設計変更：GroupContext を削除し AutoVarProvider で状態管理 |
| 2025-10-18 | 1.2 | 設計簡素化：AutoVarProvider 依存を削除、group.ExpandedVars への直接設定方式に変更 |
| 2025-10-18 | 1.3 | 変数展開の遅延評価：`cmd.ExpandedVars` を削除し、実行時に動的構築する方式に変更。優先順位の問題を根本的に解決し、二重展開を回避 |
| 2025-10-18 | 1.4 | グループレベル `workdir` の変数展開対応：`%{backup_base}` などの変数参照を可能に。ただし `%{__runner_workdir}` は未定義エラー（循環参照防止） |
| 2025-10-18 | 1.5 | dry-runモード対応：`TempDirManager` に `isDryRun` フラグを追加。dry-runでは仮想パスを生成し、実際のファイルシステム操作は行わない |
| 2025-10-18 | 1.6 | アーキテクチャ明確化：`GroupExecutor` は概念モデルで、実装は `Runner.ExecuteGroup()` メソッド。`TempDirManager` は `Runner` 内で直接使用 |

---

**作成日**: 2025-10-18
**ステータス**: 設計フェーズ完了、実装フェーズ待ち
**関連タスク**: Task 0034 - 作業ディレクトリ仕様の再設計
