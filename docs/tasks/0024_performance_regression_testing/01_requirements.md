# パフォーマンス回帰テストシステム 要件定義書

## 1. プロジェクト概要

### 1.1 背景
現在のパフォーマンス回帰テスト `TestSubstitutionHashEscape_PerformanceRegression` は、実行環境に強く依存するため、低スペックCPUや共用環境で負荷が高い場合に不安定な結果となることが問題となっている。

### 1.2 目的
環境依存性を排除し、CI環境でPR前後のコード変更による性能劣化を自動的に検出できる安定したパフォーマンス回帰テストシステムを構築する。

### 1.3 スコープ
- PR前後の相対的性能比較による回帰検出
- CI/CDパイプラインとの統合
- 既存の `internal/filevalidator/encoding` パッケージでの実装
- 将来的な他パッケージへの拡張性考慮

## 2. 機能要件

### 2.1 核心機能

#### F001: ベースライン性能測定
- **概要**: mainブランチ（PR適用前）での性能測定を実施
- **詳細**:
  - 対象関数を複数回実行し実行時間を収集
  - 統計的に安定した値（中央値、95パーセンタイル）を算出
  - メモリ使用量も同時測定
  - 測定結果をJSONファイルに保存

#### F002: 現在の性能測定
- **概要**: PRブランチ（PR適用後）での性能測定を実施
- **詳細**:
  - ベースライン測定と同一の方法で測定
  - 同一の実行環境での測定保証
  - 測定結果をJSONファイルに保存

#### F003: 性能比較・回帰判定
- **概要**: ベースラインと現在の測定結果を比較し回帰を判定
- **詳細**:
  - 実行時間の増加率計算
  - メモリ使用量の増加率計算
  - 設定可能な閾値による判定（デフォルト: 1.5倍）
  - 統計的有意性の考慮

#### F004: 結果レポート生成
- **概要**: 比較結果をMarkdown形式でレポート生成
- **詳細**:
  - ベンチマーク毎の詳細結果
  - 回帰検出の場合の警告表示
  - PRコメントへの自動投稿機能

### 2.2 対象ベンチマーク

#### B001: encode_simple_path
- 単純なパス（`/usr/bin/python3`）のエンコード性能

#### B002: encode_with_fallback_normal
- フォールバック機能を含むエンコード性能

#### B003: encode_special_chars
- 特殊文字を含むパスのエンコード性能

#### B004: decode_normal
- 通常のデコード性能

### 2.3 測定項目

#### M001: 実行時間
- 1回あたりの実行時間（ナノ秒）
- 複数回実行での中央値・95パーセンタイル

#### M002: メモリ使用量
- 1回あたりのメモリ割り当て量（バイト）
- GCの影響を考慮した測定

## 3. 非機能要件

### 3.1 性能要件
- **測定精度**: 測定誤差を5%以内に抑制
- **測定時間**: 全ベンチマーク測定を5分以内で完了
- **CI実行時間**: CI全体の実行時間増加を10分以内に抑制

### 3.2 安定性要件
- **環境依存性**: 同一環境での相対比較により環境差を吸収
- **再現性**: 同一コードでの測定結果の変動を20%以内に抑制
- **統計的信頼性**: 複数回測定により偶発的な異常値を排除

### 3.3 保守性要件
- **拡張性**: 新しいベンチマークの追加が容易
- **設定性**: 閾値やベンチマーク対象の設定変更が容易
- **可読性**: 結果レポートが開発者にとって理解しやすい

### 3.4 運用要件
- **自動化**: CI/CDパイプラインでの完全自動実行
- **通知**: 回帰検出時の適切な通知機能
- **ログ**: トラブルシューティング用の詳細ログ出力

## 4. 制約事項

### 4.1 技術的制約
- Go 1.23.10以上での動作
- GitHub Actions環境での実行
- 既存のMakefileベースのビルドシステムとの統合

### 4.2 運用制約
- mainブランチへのアクセス権限が必要
- PR作成時の自動実行
- ファイル変更がある場合のみ実行（不要な実行を避ける）

### 4.3 リソース制約
- CI実行時間の制限内での完了
- GitHubリポジトリの容量制限

## 5. 成功基準

### 5.1 技術的成功基準
- [ ] CI環境での安定した動作（成功率95%以上）
- [ ] 実際の性能劣化の確実な検出
- [ ] 偽陽性（誤検出）の発生率5%以下

### 5.2 運用的成功基準
- [ ] 開発者による結果の理解・活用
- [ ] PR レビュープロセスへの有効な統合
- [ ] 性能改善活動への貢献

## 6. リスクと対策

### 6.1 技術的リスク
- **リスク**: CI環境での性能のばらつき
- **対策**: 複数回測定による統計的処理、相対比較による環境依存性排除

### 6.2 運用的リスク
- **リスク**: 偽陽性による開発効率低下
- **対策**: 適切な閾値設定、統計的有意性の考慮

### 6.3 保守性リスク
- **リスク**: システムの複雑化による保守困難
- **対策**: シンプルな設計、十分なドキュメント作成
