# 要件定義書: Privileged コマンド実行機能

## 1. プロジェクト概要

### 1.1 背景
システム管理者がgo-safe-cmd-runnerを使用してシステム運用タスクを実行する際、大半のコマンドは安全性のため一般ユーザー権限で実行したいが、一部のコマンド（例：docker mysqlへのroot接続、システムファイルのバックアップ等）については管理者権限での実行が必要になるケースがある。

現在のgo-safe-cmd-runnerでは、`Command.Privileged`フィールドが定義されているものの、実際の権限昇格機能は実装されていない。

### 1.2 目的
- `Command.Privileged = true`が設定されたコマンドのみを管理者権限（root）で実行する機能を実装する
- 通常のコマンドは一般ユーザー権限のまま実行し、最小権限の原則を維持する
- setuid/seteuidを使用した権限切り替えによる安全な権限昇格機能の提供

### 1.3 適用例
- dockerコンテナ内のmysqlデータベースへのroot接続によるバックアップ取得
- システムディレクトリへのファイル書き込み
- 特定のシステムサービスの制御

## 2. 機能要件

### 2.1 権限切り替え機能
- [ ] 権限昇格の範囲を最小化：必要な操作の直前に昇格、操作完了後即座に降格
- [ ] privilegedコマンドに対する権限昇格が必要な処理：
  - コマンド実行パスのハッシュ値計算（filevalidator）
  - 実際のコマンド実行
- [ ] 各操作での権限切り替えパターン：
  - ハッシュ値計算前：seteuid(0) → ハッシュ計算 → seteuid(getuid())
  - コマンド実行前：seteuid(0) → コマンド実行 → seteuid(getuid())
- [ ] 権限降格の確実な実行をdefer文で保証
- [ ] 権限切り替えに失敗した場合、そのコマンドおよびグループの実行を中止
- [ ] 権限切り替えに失敗した場合、次のグループの実行は継続

### 2.2 セキュリティ機能
- [ ] privilegedコマンドに対しても既存のfilevalidatorによるハッシュチェックを実行
- [ ] ハッシュ値計算時の一時的な権限昇格も含めて、全ての権限昇格をログに記録（slog使用）
- [ ] 権限切り替えエラー時の詳細なエラー情報提供
- [ ] 権限昇格中の例外発生時にも確実に権限降格を実行
- [ ] 権限昇格の開始・終了をペアで記録し、昇格時間を最小化

### 2.3 設定機能
- [ ] `Command.Privileged`フィールドはコマンド単位でのみ設定可能
- [ ] グループレベルでのprivileged設定は提供しない
- [ ] 既存の設定ファイル形式と完全互換

### 2.4 プラットフォーム対応
- [ ] Linux/Unix系プラットフォームのみ対応
- [ ] Windowsプラットフォームでは機能無効化（エラーメッセージ表示）

## 3. 非機能要件

### 3.1 セキュリティ
- runnerバイナリはsetuid rootビットが設定される前提
- 最小権限の原則：privilegedフラグが設定されたコマンドの必要な操作のみroot権限実行
- 権限昇格時間の最小化：各操作（ハッシュ計算、コマンド実行）毎に昇格・降格を実行
- 既存のfilevalidator機能によるコマンドパスの整合性検証を維持
- defer文による権限降格の確実な実行保証
- panic発生時でも権限降格が実行される仕組みの実装

### 3.2 可用性
- 権限切り替えに失敗した場合、該当グループは停止するが、他のグループの実行には影響しない
- 権限昇格機能が利用できない環境でも、privileged=falseのコマンドは正常動作

### 3.3 保守性
- 既存のexecutorインターフェースとの互換性維持
- 明確なエラーメッセージによる問題の特定容易性

### 3.4 パフォーマンス
- 権限切り替えのオーバーヘッドは最小限
- privileged=falseのコマンドには性能影響なし

## 4. 制約事項

### 4.1 技術的制約
- Linux/Unix系プラットフォームのみサポート
- runnerバイナリにsetuid rootビットが設定されている必要がある
- 権限切り替えにはsyscallパッケージを使用

### 4.2 運用制約
- setuidビットの設定はMakefileやインストールスクリプトで対応（本機能外）
- root権限での実行には十分な検証とテストが必要

### 4.3 セキュリティ制約
- privilegedコマンドの実行パスは既存のfilevalidatorでの検証必須
- 権限昇格可能なコマンドについて適切な運用ガイドラインが必要

## 5. インターフェース要件

### 5.1 設定ファイル形式
```toml
[[groups.commands]]
name = "mysql_backup"
cmd = "/usr/bin/mysqldump"
args = ["-u", "root", "-p${MYSQL_ROOT_PASSWORD}", "database"]
privileged = true  # このコマンドのみroot権限で実行
```

### 5.2 ログ出力形式
```
[INFO] Executing command with elevated privileges: mysql_backup
[ERROR] Failed to elevate privileges for command: mysql_backup, error: operation not permitted
```

## 6. 成功基準

### 6.1 機能基準
- [ ] `Command.Privileged = true`のコマンドがroot権限で実行される
- [ ] `Command.Privileged = false/未設定`のコマンドが一般ユーザー権限で実行される
- [ ] 権限切り替えエラー時に適切なエラーハンドリングが行われる
- [ ] 全ての既存テストケースが引き続き通過する

### 6.2 セキュリティ基準
- [ ] privilegedコマンドに対してfilevalidatorの検証が正常動作する
- [ ] 権限昇格の試行と結果が適切にログ記録される
- [ ] 権限切り替えに失敗した場合、システムが安全な状態を維持する

### 6.3 品質基準
- [ ] 単体テストカバレッジ90%以上
- [ ] インテグレーションテストの追加
- [ ] セキュリティテストの実装

## 7. リスク分析

### 7.1 高リスク
- **setuid実行時のセキュリティ脆弱性**: filevalidatorによる検証とコードレビューで対応
- **権限昇格機能の悪用**: 適切な運用ガイドラインと監査ログで対応

### 7.2 中リスク
- **プラットフォーム依存の実装問題**: Linux/Unix環境での十分なテストで対応
- **権限切り替えの失敗**: 適切なエラーハンドリングで対応

### 7.3 低リスク
- **既存機能への影響**: privileged=falseのコマンドの動作は変更なし
- **パフォーマンス影響**: syscall使用による影響は最小限

## 8. 将来の拡張事項

### 8.1 監査ログシステム
- privileged実行に関する詳細な監査ログ機能
- ログの外部システムへの転送機能
- 統一的なログフォーマットの導入

### 8.2 権限制御の拡張
- 特定ユーザーIDでの実行機能（su機能）
- グループ権限の制御
- capability-basedの権限制御

### 8.3 セキュリティ強化
- privilegedコマンドの実行パスホワイトリスト機能
- 実行時間制限の強化
- ネットワークアクセス制御との連携

## 9. 依存関係

### 9.1 技術的依存
- `internal/runner/executor`パッケージ
- `internal/runner/runnertypes`パッケージ
- `syscall`パッケージ（権限切り替え用）
- 既存のfilevalidator機能

### 9.2 外部依存
- Linux/Unixシステムコール
- setuidビット設定済みのバイナリ

## 10. 承認

本要件定義書に基づいて、privilegedコマンド実行機能の設計・実装を進める。

承認者: [プロジェクト責任者]
承認日: [承認日]
