# ログシステム再設計の要件書

## 1. 概要

本文書は`runner`コマンドのログシステム再設計の要件をまとめます。目的はログ機能の信頼性、使いやすさ、拡張性を向上させることです。

## 2. 背景

現在の`runner`コマンドのログ実装には以下の課題があります：
- 標準の`log`パッケージと`log/slog`パッケージが混在使用されており、`--log-level`フラグで指定されたログレベルが一貫して守られない
- 複数形式での同時ログ出力機能（分析用の機械読み取り可能な形式と、簡潔なサマリー用の人間読み取り可能な形式など）が欠如している

## 3. 機能要件

### FR1: 厳格なログレベルフィルタリング
システムはユーザーが指定したログレベルに基づき、ログメッセージを厳格にフィルタリングしなければならない。指定レベルより低い重要度のメッセージは出力してはならない。

### FR2: デュアルログ出力
システムは異なる形式とログレベルで、2つの異なる出力先へのログ出力を同時にサポートしなければならない。
- **機械読み取り可能ログ**: 監査とデバッグを目的とした詳細な構造化ログ（JSON形式など）
- **人間読み取り可能サマリー**: 迅速なユーザーフィードバック用の簡潔な実行結果サマリー（Slackへの投稿、コンソール出力など）

### FR3: 一元化ログインターフェース
アプリケーション内のすべてのログは、単一の統一されたログインターフェースを通じて実行されなければならない。これは`log/slog`とする。

### FR4: ログファイルの生成と配置
- 機械読み取り可能ログファイルは実行毎（per-run）にユニークに生成され、ファイル名にはホスト名とタイムスタンプを含めなければならない（人間が名前から実行時刻を推測できるようにするため）
- ファイル名形式：`<hostname>_<timestamp>_<runid>.json`
- デフォルトの出力ディレクトリは設定されていない場合、`--log-dir`フラグで指定可能。ディレクトリのみ設定可能で、ファイル名は自動生成される
- ログファイルは0600権限で作成されなければならない
- 将来的にper-runログファイルのgzip圧縮機能の追加を検討

### FR5: 標準出力への既定動作
人間読み取り可能サマリーについて特定の設定が提供されない場合、既定で標準出力に出力する。

### FR6: ログレベル分類
サポートするレベル：`debug`、`info`、`warn`、`error`、加えて`critical`と`audit`
- `critical`はプロセスを終了させる、または即座の対応が必要な障害を示す
- `audit`はセキュリティ/コンプライアンス関連イベント（権限変更、検証失敗など）を示す。監査イベントは常に`info`以上で記録され、ユーザーレベル設定で抑制してはならない

### FR7: 構造化JSONスキーマ
すべての機械読み取り可能ログ（JSON）は最低限以下のフィールドを持つスキーマに従わなければならない：
`timestamp, level, msg, run_id, attempt, component, subsystem, command, args_hash, exit_code, duration_ms, verification_verified, verification_skipped, verification_failed, env_allowed_count, env_removed_count, privilege_initial_uid, privilege_effective_uid, warnings_count, errors_count, schema_version, hostname, pid`
- `schema_version`の初期値は`1`
- `run_id`はUUID v4でなければならない
- 将来的に`git_commit`、`build_version`フィールドの追加を検討

### FR8: 機密情報の墨消し
センシティブ情報はログ記録前に墨消しされなければならない：
- 環境変数：許可リストのキーのみ平文で記録可能、それ以外は墨消しされる
- 引数と出力：`(?i)(password|token|secret|key)`等のパターンや主要クラウド認証情報（AWS access/secret/session tokens、GCP service account private keysなど）は`"***"`で完全置換される（部分マスクでない）

### FR9: Slackサマリー通知
- 各コマンドグループ実行終了時に成功・失敗に関係なくサマリーを投稿しなければならない
- サマリーには以下を含める：タイトル行（`OK <group>`または`Fail <group>`）、人間読み取り可能サマリー行、選択された環境変数（FR8に従い墨消し）、実行されたコマンド、（切り詰められた）コマンド出力
- 形式はMarkdownでなければならない
- 配信は指数バックオフ（2s開始）で3回リトライ、1回あたり5秒HTTPタイムアウトを実装しなければならない
- Webhook URLは環境変数で提供され（`.env`ファイルから読み込み可能）、Slack失敗はコマンド終了コードに影響せず、警告としてログに記録する

### FR13: 実行前エラーの通知
- コマンドグループ実行前に発生したエラー（設定解析失敗、権限エラー、ファイルアクセス失敗、必須引数不足など）もログ記録とSlack通知の対象としなければならない
- 実行前エラー時のSlack通知には以下を含める：エラータイトル行（`Error: <error_type>`）、エラーメッセージ、発生箇所（コンポーネント名）、環境情報（FR8に従い墨消し）
- ユーザー中断（`[Request interrupted by user]`など）も実行前エラーとして同様に処理する
- 実行前エラー時もrun_idを生成し、ログファイルに記録する（ただしコマンド実行は行われないため、該当フィールドは空またはN/A）
- エラー型には`config_parsing_failed`、`log_file_open_failed`、`privilege_drop_failed`、`file_access_failed`、`user_interrupted`、`required_argument_missing`、`system_error`を含む

### FR10: 安全なファイルハンドリングと権限順序
- ログファイルは権限降格前に安全に開かれなければならない。オープンはシンボリックリンク攻撃を防御しなければならない（安全なファイルAPIによるO_NOFOLLOWセマンティクスなど）

### FR11: 同期ログ
- ログ書き込みは同期で実行する。バウンドバッファが存在する場合（通知キューなど）、満杯時のポリシーは`drop_oldest`とする。ドロップ数はメトリクスとして公開してもよい

### FR12: サマリー行
- 完了時、システムは以下の形式で単一行サマリーを出力しなければならない：
	`RUN_SUMMARY run_id=<id> exit_code=<n> status=<success|error|pre_execution_error> duration_ms=<n> verified=<n> skipped=<n> failed=<n> warnings=<n> errors=<n>`
	これはFR9のタイトル行に続く
- 実行前エラーの場合、`status=pre_execution_error`とし、コマンド実行関連フィールド（verified、skipped、failed）は0またはN/Aとする

## 4. 非機能要件

### NFR1: パフォーマンス
ログシステムはメインアプリケーションロジックへのパフォーマンス影響を最小限に抑える。

### NFR2: 拡張性
設計は将来的に他の出力形式や出力先をサポートするよう拡張可能である（リモートサーバーへのログ送信、異なる通知システムなど）。

### NFR3: 使いやすさ
開発者にとってログシステムの使用は直感的である。複数出力の処理の複雑さはアプリケーションコードから抽象化される。

### NFR4: パフォーマンス目標
- 目標スループット：並列度P=8でCPUオーバーヘッド<5%、追加GCプレッシャー<10%で10k行/秒

### NFR5: データロス方針
- サマリーと監査イベントは損失許容不可（ディスク/標準出力に到達必須）。重要でないdebug/infoイベントは同期制約内でベストエフォート

### NFR6: 設定優先順位
- 設定優先順位：CLIフラグ > 環境変数 > TOML設定 > 組み込み既定値
- TOMLキー：`[logging] level=..., dir=...`（ファイル名はper-run自動生成、ローテーション設定は対象外）

### NFR7: 対象外（現在）
- 動的ログレベル再読み込み（SIGHUPなど）は本イテレーションでは実装せず、将来拡張として文書化する
- Trace/Span ID統合（OpenTelemetry）は将来作業として文書化する
- ログローテーションは本システム外で処理、per-runユニーク圧縮ファイルを代わりに使用する
