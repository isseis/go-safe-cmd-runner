# ログシステム再設計のアーキテクチャ

## 1. 概要

本文書は再設計されたログシステムの提案アーキテクチャを説明します。`01_requirements.md`で概説された要件に基づいています。このアーキテクチャの核心は`log/slog`パッケージとその`slog.Handler`インターフェースを最大限活用し、柔軟で強力なログパイプラインを構築することです。設計では実行毎の一意な名前を持つ圧縮JSONログ、権限降格前の安全なファイルハンドリング、SlackへのMarkdownサマリー通知を重視しています。

## 2. アーキテクチャの原則

- **単一責任**: ログシステムの各コンポーネントは単一の明確に定義された責任を持つべきです
- **疎結合**: ログを生成するアプリケーションコードは、ログの形式やログの送信先の詳細から疎結合であるべきです
- **拡張性**: アーキテクチャはコアアプリケーションロジックを変更することなく、新しいログハンドラーで容易に拡張できるべきです

## 3. 提案アーキテクチャ

提案アーキテクチャは以下のコンポーネントで構成されます：
1.  **統一ログ**: アプリケーション全体で使用される単一の`slog.Logger`インスタンス（`slog.SetDefault`経由のデフォルトログ）
2.  **MultiHandler（ファンアウト）**: ログレコードを複数の基盤ハンドラーにディスパッチするカスタム`slog.Handler`。すべてのハンドラーを試行し、高速失敗でなくエラーを集約します
3.  **専用ハンドラー**: 各出力先（機械読み取り可能ファイル、人間読み取り可能サマリー、オプションでSlack）用の個別`slog.Handler`実装
4.  **墨消しレイヤー（デコレーター）**: センシティブな属性（env、args、認証情報パターン）を任意のハンドラーに到達する前に墨消しする前処理レイヤー

### システム図

```
+---------------------+      +-------------------+      +------------------------+
| アプリケーションコード  |----->|   slog.Logger     |----->|      MultiHandler      |
| （例：runner）       |      | （デフォルトログ）   |      | （カスタムslog.Handler）|
+---------------------+      +-------------------+      +------------------------+
                                                            |
                                                            |
                                     +----------------------+----------------------+
                                     |                                             |
                                     v                                             v
                         +-------------------------+                   +-------------------------+
                         |   JSON Handler          |                   |   Text Handler          |
                         | (slog.NewJSONHandler)   |                   | (slog.NewTextHandler)   |
                         +-------------------------+                   +-------------------------+
                                     |                                             |
                                     v                                             v
                         +-------------------------+                   +-------------------------+
                         | 機械読み取り可能ログ      |                   | 人間読み取り可能サマリー   |
                         | (per-run .json.gz)      |                   | (stdout / Slack MD)     |
                         +-------------------------+                   +-------------------------+
```

### コンポーネント説明

#### 3.1. アプリケーションコード
- `runner`アプリケーションのすべての部分は標準の`slog`関数（例：`slog.Debug`、`slog.Info`、`slog.Error`）を使用します
- コードは標準の`log`パッケージをもはや使用しません。これによりすべてのログメッセージが`slog`パイプラインを通ることを保証します
- メッセージは構造化属性を含むべきです；自由形式の連結は避けます。監査イベントは`audit=true`でマークされます

#### 3.2. `slog.Logger`
- 単一のグローバルログインスタンスがアプリケーションのエントリーポイント（`main`関数）で設定されます
- このログは`MultiHandler`で初期化されます

#### 3.3. `MultiHandler`
- `slog.Handler`インターフェースのカスタム実装
- 複数ハンドラーへのファンアウト；各ハンドラーの`Enabled`がレコード毎に尊重されます
- エラーポリシー：すべてのハンドラーへの配信を試行；複数エラーを集約（マルチエラー）し最後に返却
- 不変設定（ハンドラースライスは作成後変更されない）で同時性安全を保証

#### 3.4. JSON Handler
- ログをJSONとして形式化する`slog.NewJSONHandler`
- 出力：ホスト名とタイムスタンプを含む実行毎一意名ファイル、`0600`権限で作成
- ファイル名形式：`<hostname>_<timestamp>_<runid>.json`
- レベル：`--log-level`から設定
- `WithAttrs`による共通属性注入：`hostname`、`pid`、`schema_version=1`、`run_id`等

#### 3.5. Text Handler
- 標準出力への人間読み取り可能出力用の`slog.NewTextHandler`
- レベル：`info`以上に固定
- 完了時に簡潔なタイトル行（`OK <group>`または`Fail <group>`）に続いて`RUN_SUMMARY ...`行を出力

#### 3.6. Slack通知（オプションハンドラー）
- 各コマンドグループ実行終了時にMarkdownサマリーを投稿
- 実行前エラー（設定解析失敗、権限エラー、ユーザー中断など）時もエラー通知を投稿
- Webhook URL用環境変数経由設定（`.env`から読み込み可能）
- 指数バックオフ（2s基底）で3回リトライ、5sタイムアウト、失敗は警告としてログ記録され終了コードには影響しない

#### 3.7. 墨消し（デコレーター）
- レコードを他のハンドラーに渡す前にargs、outputsの許可リスト基底環境フィルタリングとパターン基底認証情報墨消しを適用
- 認証情報パターンには汎用トークンと主要クラウド認証情報（AWS、GCPなど）を含む

## 4. 初期化フロー

1.  **run_id生成**: 早期にUUID v4形式のrun_idを生成（実行前エラー時も必要）
2.  **設定解析**: CLIフラグ、環境変数、TOML（`[logging] level, dir`）を優先度で解析：フラグ > 環境変数 > TOML > デフォルト
3.  **実行毎ファイル名生成**: `<dir>/<hostname>_<timestamp>_<runid>.json`を構成
4.  **権限降格前安全オープン**: 権限降格前にログファイルを安全に（シンボリックリンクなし）オープン
5.  **ハンドラー作成**:
    - ファイルライターと解析されたログレベルで`JSONHandler`をインスタンス化；共通属性を付加
    - `os.Stdout`と固定`slog.LevelInfo`で`TextHandler`をインスタンス化
    - オプションでSlack通知を配線（コマンドグループ終了時サマリーのみ）
6.  **MultiHandler作成**: 墨消しデコレーターと専用ハンドラーでカスタム`MultiHandler`をインスタンス化
7.  **ログ作成**: `MultiHandler`で新しい`slog.Logger`を作成
8.  **デフォルトログ設定**: `slog.SetDefault`を呼び出しこのログをアプリケーションのグローバルデフォルトに設定
9.  **実行前エラー処理**: 設定解析やファイルアクセス失敗時はrun_idを使用してログ記録；Slack通知を送信；適切なエラーメッセージでプロセス終了

## 5. 拡張性
新しいログ出力（例：Slack）を追加するには、初期化時に`MultiHandler`に新しいハンドラーを追加できます。墨消しデコレーターは出力先に関係なくセンシティブ情報が除去されることを保証します。

## 6. 対象外／将来作業
- 動的ログレベル再読み込み（SIGHUP） — 本イテレーションでは実装せず、文書化予定
- Trace/Span IDs（OpenTelemetry） — スキーマプレースホルダーを予約可能；統合は延期
- ローテーション/保持 — 外部で処理；ここではper-runファイルを使用
