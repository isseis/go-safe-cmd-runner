# Migration Guide: v2.0.0 Timeout Changes

## Overview

Version 2.0.0 introduces significant changes to timeout behavior to provide better control over command execution. This guide helps you migrate existing configurations to the new timeout specification.

## Breaking Changes Summary

### 1. `timeout = 0` Behavior Change

**Before v2.0.0:**
- `timeout = 0` was treated as invalid
- Defaulted to system default timeout (typically 60 seconds)

**From v2.0.0:**
- `timeout = 0` means **unlimited execution** (no timeout)
- Allows commands to run indefinitely until completion

### 2. Enhanced Timeout Hierarchy

**Before v2.0.0:**
- Simple override: command timeout > global timeout > system default

**From v2.0.0:**
- Clear distinction between "unset" and "explicit zero"
- Better handling of nullable timeout values
- Improved timeout resolution logic

## Migration Steps

### Step 1: Identify Configurations Using `timeout = 0`

Search your configuration files for any `timeout = 0` settings:

```bash
grep -r "timeout = 0" /path/to/your/config/files/
```

### Step 2: Update `timeout = 0` Settings

#### If you intended unlimited execution:
✅ **No change needed** - `timeout = 0` now provides unlimited execution as intended.

```toml
# v2.0.0: This now works as expected
[[groups.commands]]
name = "long_running_task"
cmd = "/usr/bin/process-large-dataset"
timeout = 0  # ✅ Unlimited execution
```

#### If you intended default timeout:
❌ **Action required** - Remove the `timeout = 0` line.

```toml
# Before v2.0.0 (unintended behavior)
[[groups.commands]]
name = "quick_task"
cmd = "/usr/bin/quick-check"
timeout = 0  # This was ignored, used system default

# After v2.0.0 (correct migration)
[[groups.commands]]
name = "quick_task"
cmd = "/usr/bin/quick-check"
# timeout removed → uses global or system default (60s)
```

### Step 3: Review Long-Running Commands

Identify commands that might benefit from unlimited execution:

```toml
# Commands that may need unlimited execution
[[groups.commands]]
name = "interactive_setup"
cmd = "/usr/bin/interactive-config"
timeout = 0  # ✅ Good candidate for unlimited execution

[[groups.commands]]
name = "large_backup"
cmd = "/usr/bin/backup"
args = ["--full", "--compress"]
timeout = 0  # ✅ Backup duration varies significantly

[[groups.commands]]
name = "user_input_required"
cmd = "/usr/bin/wizard"
timeout = 0  # ✅ Waits for user interaction
```

## Migration Examples

### Example 1: Database Operations

```toml
# Before v2.0.0
[global]
timeout = 300  # 5 minutes default

[[groups.commands]]
name = "small_export"
cmd = "pg_dump"
args = ["small_db"]
timeout = 0  # ❌ Unintended: was using 300s default

[[groups.commands]]
name = "full_export"
cmd = "pg_dump"
args = ["--all-databases"]
timeout = 0  # ❌ Unintended: was using 300s default
```

```toml
# After v2.0.0 (migrated)
[global]
timeout = 300  # 5 minutes default

[[groups.commands]]
name = "small_export"
cmd = "pg_dump"
args = ["small_db"]
# timeout removed → uses global 300s

[[groups.commands]]
name = "full_export"
cmd = "pg_dump"
args = ["--all-databases"]
timeout = 0  # ✅ Intentional: unlimited for large exports
```

### Example 2: Mixed Workloads

```toml
# Before v2.0.0
[[groups.commands]]
name = "api_check"
cmd = "curl"
args = ["-f", "http://api.example.com/health"]
timeout = 0  # ❌ Unintended: should have short timeout

[[groups.commands]]
name = "data_migration"
cmd = "/usr/bin/migrate-data"
timeout = 0  # ❌ Unintended: but actually needs unlimited
```

```toml
# After v2.0.0 (migrated)
[[groups.commands]]
name = "api_check"
cmd = "curl"
args = ["-f", "http://api.example.com/health"]
timeout = 30  # ✅ Appropriate timeout for API check

[[groups.commands]]
name = "data_migration"
cmd = "/usr/bin/migrate-data"
timeout = 0   # ✅ Unlimited for migration
```

## Validation and Testing

### 1. Configuration Validation

Use the built-in validation to check your migrated configuration:

```bash
# Validate your configuration file
go-safe-cmd-runner verify /path/to/your/config.toml
```

### 2. Dry Run Testing

Test your migrated configuration with dry run mode:

```bash
# Test without actually executing commands
go-safe-cmd-runner runner --dry-run /path/to/your/config.toml
```

### 3. Monitor Unlimited Execution

For commands with `timeout = 0`, monitor their behavior:

```bash
# Check system logs for long-running processes
journalctl -u your-service -f

# Monitor resource usage
htop
```

## Security Considerations

### 1. Review Unlimited Timeouts

Carefully review all `timeout = 0` settings:

```toml
# ✅ Good: Interactive commands
timeout = 0  # User input required

# ✅ Good: Variable duration tasks
timeout = 0  # Data processing with unknown size

# ⚠️ Review: Network operations
timeout = 0  # May hang on network issues

# ❌ Risky: Simple commands
timeout = 0  # curl, ping, etc. should have timeouts
```

### 2. Resource Management

Monitor system resources for unlimited execution commands:

- Set up monitoring alerts for long-running processes
- Implement manual intervention mechanisms
- Consider resource limits at the system level

## Rollback Plan

If you encounter issues, you can temporarily rollback:

### 1. Quick Rollback

Replace all `timeout = 0` with appropriate positive values:

```toml
# Quick rollback: replace unlimited with reasonable timeout
[[groups.commands]]
name = "problematic_command"
cmd = "/usr/bin/command"
timeout = 3600  # 1 hour instead of unlimited
```

### 2. Version Downgrade

If necessary, you can downgrade to v1.x:

```bash
# Install previous version
go install github.com/your-org/go-safe-cmd-runner@v1.9.x
```

## Troubleshooting

### Common Issues

#### Issue 1: Commands Never Complete

**Symptom**: Commands with `timeout = 0` run indefinitely

**Solution**:
```toml
# Add reasonable timeout
timeout = 3600  # 1 hour instead of unlimited
```

#### Issue 2: Commands Timeout Too Quickly

**Symptom**: Previously working commands now timeout

**Solution**:
```toml
# Check if timeout = 0 was removed incorrectly
timeout = 0  # Restore unlimited if needed
```

#### Issue 3: Configuration Validation Errors

**Symptom**: Configuration file rejected by validator

**Solution**:
```bash
# Check syntax and fix validation errors
go-safe-cmd-runner verify --verbose config.toml
```

## Support and Resources

### Documentation
- [Global Level Configuration](../user/toml_config/04_global_level.md)
- [Command Level Configuration](../user/toml_config/06_command_level.md)
- [Timeout Examples](../../sample/timeout_examples.toml)

### Community Support
- GitHub Issues: Report migration problems
- Documentation: Submit improvement suggestions
- Examples: Share migration experiences

---

**Need Help?**
If you encounter issues during migration, please:
1. Check this guide thoroughly
2. Review the example configurations
3. Test with dry-run mode
4. Contact support with specific error messages
