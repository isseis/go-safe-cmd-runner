# 要件定義書：安全なバッチ処理実行ラッパー

## 1. 概要 (Overview)

**目的:** このドキュメントは、安全なバッチ処理実行ラッパーに関する要件を定義する。

**背景:**
サーバーマシンの運用・管理を行っていると、バックアップなど定期的に一連の処理を実行する必要がある。
これらのコマンドは、安全でないコマンド実行によるセキュリティリスクを低減するため安全なコマンド実行ラッパーを提供し、
また一連のコマンドを実行する際の定型処理を簡略化する機能を提供する。

## 2. 目的とスコープ (Goals and Scope)

### 2.1. 目的 (Goals)
(このイテレーションで達成したいことを具体的に記述します。)

-   サーバーマシンの運用管理を行うユーザーが利用することを想定。
-   実行すべき一連のコマンドが記述されたファイルを読み込み、コマンドを安全に実行する機能を提供する。
-   人的ミスや環境の違いによる不具合を軽減するため、ファイルのハッシュ値を検証する機能を提供する。
-   特権ユーザーとして実行される範囲を制限することにより、セキュリティリスクを低減する。
-   実行結果を人間が読みやすい形で標準出力に出力する機能を提供する。

### 2.2. スコープ (In Scope)
(開発の対象範囲を明確にします。)

-   TOML 形式で指定されたファイルを読み込み、実行するべき一連のコマンドを取得する機能。
-   多重実行を防止する機能。
-   指定されたファイルのハッシュ値と、コマンド実行直前のファイルのハッシュ値を比較し、ファイルが改ざんされていないか検証する機能。
    -   ファイル改ざんの検証にはinternal/filevalidator にあるパッケージを使用する。
-   コマンドをグループ化し、それぞれのグループ内のコマンドを逐次実行する機能。
    -   すべてのグループ内のコマンドが成功するまで、次のグループのコマンドを実行しない。
    -   実行に失敗した場合にはそのグループ内のコマンドの実行は中止し、クリーンアップ処理を行う。
    -   実行に失敗した場合でも、次のグループのコマンドは実行する。
-   グループ単位で定型的な処理を容易に行えるようにする機能。定型的な処理の例：
    -   コマンド実行前に作業用のテンポラリディレクトリを作成し、そのディレクトリ内でグループ内のコマンドを実行する。
    -   コマンド実行後に作業用のテンポラリディレクトリを削除する。
-   コマンド単位で一般ユーザー権限で実行するか、root 権限で実行するかを選択できるようにする機能。
    -   バッチ処理実行ラッパー自体は一般ユーザー権限で実行する。上記の要件を満たすため実行ファイルに setuid ビットを設定し、必要最小限の範囲で実効UIDをrootに設定する。
-   ログの出力レベルを指定可能にする。
    -   実行するコマンドや実行結果などを逐次表示するデバッグモード。
    -   すべてのコマンドの実行結果を出力する通常モード。
    -   実行結果を簡略にまとめた要約モード。
-   ログは標準出力に人間が読みやすい形で書き出す。
    -   将来、コマンドの実行結果をファイルやwebhook などに出力する機能を実装する予定があるので、そのためのインターフェースを提供する。
    -   将来、機械可読な形式でログを出力する機能を実装する予定があるので、そのためのインターフェースを提供する。

### 2.3. スコープ外 (Out of Scope)
(開発の対象外の範囲を明確にします。これにより、作業範囲の認識齟齬を防ぎます。)

-   実行結果をファイルに出力したり、webhook を使ってポストする機能。
-   コマンドを定期的に実行する機能。
-   エラー時の自動リトライ機能。

## 3. 機能要件 (Functional Requirements)

(システムが提供すべき具体的な機能を定義します。「誰が」「何を」「どうする」が分かるように記述するのが理想です。)

### 3.1. 機能一覧

#### FR-01: コマンド定義ファイルの読み込みと検証
- **機能ID:** `F-001`
- **機能名:** コマンド定義ファイル処理
- **概要:** TOML形式の定義ファイルを読み込み、構文チェックとバリデーションを実行する。
- **詳細:**
  - ファイルの存在確認と読み取り権限の検証
  - TOML形式としての構文チェック
  - 必須フィールドの存在確認（コマンド名、実行コマンド、権限レベルなど）
  - ファイルのハッシュ値を検証し、改ざんがないことを確認

#### FR-02: コマンドの安全な実行
- **機能ID:** `F-002`
- **機能名:** コマンド実行管理
- **概要:** 定義されたコマンドを安全に実行し、実行結果を記録する。
- **詳細:**
  - コマンドのグループ化と依存関係の管理
  - コマンドごとの権限制御（一般ユーザー/root）
  - コマンドの実行環境の分離（作業ディレクトリの管理）
  - 実行結果（終了コード、標準出力、標準エラー）の記録

#### FR-03: 実行結果の表示とロギング
- **機能ID:** `F-003`
- **機能名:** 実行結果管理
- **概要:** コマンドの実行結果を指定された形式で表示・記録する。
- **詳細:**
  - ログレベルの指定（デバッグ/通常/要約）
  - 人間が読みやすい形式での標準出力への表示
  - エラー発生時の詳細な情報出力
  - 実行結果のサマリー表示

## 4. 非機能要件 (Non-Functional Requirements)

(機能以外の品質や特性に関する要件を定義します。)

### 4.1. 性能 (Performance)
- コマンド実行のオーバーヘッドは100ms未満
- メモリ使用量は最大1GBを超えない
- 同時実行数は最大10プロセスまで

### 4.2. セキュリティ (Security)
- コマンドインジェクション攻撃の防止
- 最小権限の原則に基づいた権限制御
- 実行可能なコマンドのホワイトリスト制御
- 認証情報の安全な管理
- ファイルの改ざん検証機能

### 4.3. 信頼性・可用性 (Reliability/Availability)
- タイムアウト機能（デフォルト30分）
- リソース制限（CPU/メモリ）の設定
- プロセスのクリーンアップ機能
- エラー発生時のリカバリ手順
- 多重実行の防止

### 4.4. 互換性 (Compatibility)
- Linux カーネル 4.4 以上
- Go 1.18 以上でビルド可能
- POSIX互換環境での動作保証

### 4.5. 保守性 (Maintainability)
- Goの標準的なコーディング規約に準拠
- ユニットテストのカバレッジ80%以上
- ドキュメンテーションの整備
- ログの構造化とログレベルの適切な使用

## 5. 制約条件 (Constraints)

(開発を進める上での制約や、すでに決定している事項を記述します。)

-   使用言語はGoとする。
-   外部ライブラリの利用は最小限に留める。
-   (その他、技術的、運用的な制約があれば記述)

## 6. 用語集 (Glossary)

(このドキュメントやプロジェクトで使われる専門用語、略語などを定義します。)

-   **安全なコマンド:** ...
-   ...
