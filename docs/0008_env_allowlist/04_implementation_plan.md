# 実装計画書: 環境変数安全化機能

## 1. 概要

この実装計画書は、詳細仕様書に基づいて環境変数安全化機能を実装するための計画を示します。この機能は、設定ファイルで明示的に許可された環境変数のみを使用することで、潜在的なセキュリティリスクを排除します。

## 2. 前提条件

- Go 1.18以上
- 既存のgo-safe-cmd-runnerコードベース

## 3. 実装フェーズ

### フェーズ1: データ構造の拡張（推定工数: 2日）

#### タスク1.1: 設定構造体の拡張
- `internal/runner/runnertypes/config.go`に`EnvAllowlist`フィールドを追加
  - `GlobalConfig`構造体に追加
  - `CommandGroup`構造体に追加
- 単体テストの更新

#### タスク1.2: 環境変数管理構造体の実装
- 新規パッケージ`internal/runner/environment`の作成
- `Filter`構造体の実装
  - システム環境変数フィルタリング機能
  - .envファイル変数フィルタリング機能（新規追加）
  - バリデーション機能
- 単体テストの実装

### フェーズ2: 環境変数フィルタリング機能（推定工数: 3日）

#### タスク2.1: システム環境変数フィルタリングの実装
- `Runner.LoadEnvironment`メソッドの更新
- `filterSystemEnvironment`関数の実装
- `filterEnvFileVariables`関数の実装（新規追加）
- `buildAllowedVariableMaps`関数の実装
- 単体テスト

#### タスク2.2: グループレベル環境変数解決の実装
- `resolveGroupEnvironmentVars`関数の実装
- `resolveEnvironmentVars`関数の更新
- `resolveVariableReferences`関数の強化
- 単体テストおよび統合テスト

### フェーズ3: 検証機能の実装（推定工数: 2日）

#### タスク3.1: 環境変数名検証の実装
- `validateVariableName`関数の実装
- `validateVariableValue`関数の実装
- `validateEnvironmentVariable`関数の実装
- 単体テスト

#### タスク3.2: アクセス制御検証の実装
- `isVariableAccessAllowed`関数の実装
- `validateEnvironmentSecurity`関数の実装
- `containsSensitiveData`関数の実装
- セキュリティテスト

### フェーズ4: ログとエラー処理（推定工数: 1日）

#### タスク4.1: ログ機能の実装
- `logEnvironmentFiltering`関数の実装
- `logVariableAccess`関数の実装
- `getVariableNames`関数の実装

#### タスク4.2: エラー処理の実装
- エラータイプの定義
- エラーメッセージテンプレートの作成
- `formatUserError`関数の実装

### フェーズ5: 設定検証と統合（推定工数: 2日）

#### タスク5.1: 設定検証ルールの実装
- `ValidateEnvAllowlistConfiguration`関数の実装
- `validateCommandEnvironmentReferences`関数の実装
- `extractVariableReferences`関数の実装
- 単体テスト

#### タスク5.2: コマンド実行フローとの統合
- `Runner.Run`メソッドの更新
- `Runner.ExecuteCommand`メソッドの更新
- 統合テスト

## 4. テスト計画

### 4.1 単体テスト

- 環境変数フィルタリングのテスト
  - システム環境変数の許可リストに基づくフィルタリングの検証
  - .envファイル変数の許可リストに基づくフィルタリングの検証（新規追加）
  - 空の許可リストのケース
  - グループレベルの継承ケース

- 変数参照解決のテスト
  - 単純な変数参照ケース
  - 許可されていない変数参照ケース
  - 循環参照ケース

- 検証機能のテスト
  - 変数名のバリデーション
  - 変数値のバリデーション
  - アクセス制御のバリデーション

### 4.2 統合テスト

- 設定ファイルの読み込みからコマンド実行までのフルフロー検証
- グループ別環境変数設定の動作検証
- テンプレート展開との連携検証

### 4.3 セキュリティテスト

- 攻撃シナリオテスト
  - PATHインジェクション攻撃
  - LD_PRELOADインジェクション攻撃
  - .envファイル経由の環境変数インジェクション攻撃（新規追加）
  - シェルインジェクション攻撃
  - 変数参照エスケープ攻撃

### 4.4 パフォーマンステスト

- 環境変数フィルタリングのパフォーマンス測定（大量の環境変数ケース）
- 変数参照解決のパフォーマンス測定（複雑な参照解決ケース）
- 全体的なオーバーヘッド測定

## 5. パッケージ依存関係

```
internal/runner/
  ├── runnertypes/
  │   └── config.go        # 設定構造体の拡張
  ├── environment/         # 新規パッケージ
  │   ├── filter.go        # 環境変数フィルタリング
  │   └── filter_test.go   # テストコード
  ├── security/
  │   └── security.go      # セキュリティ検証（既存の拡張）
  ├── runner.go            # Runner本体の拡張
  └── runner_test.go       # テストコードの拡張
```

## 6. リスクと対策

### 6.1 後方互換性リスク

**リスク**: 既存の設定ファイルが動作しなくなる可能性がある

**対策**:
- `env_allowlist`を指定しない場合のデフォルト動作を明確に定義
- マイグレーションガイドを提供
- バージョンアップ前の動作を再現するためのオプション検討

### 6.2 パフォーマンスリスク

**リスク**: 環境変数フィルタリングによるオーバーヘッド

**対策**:
- パフォーマンスベンチマークの実施
- キャッシュの活用
- 最適化されたデータ構造の選択

### 6.3 セキュリティリスク

**リスク**: フィルタリング回避の手段が存在する可能性

**対策**:
- 広範囲なセキュリティテスト
- エッジケースの徹底的な検証
- セキュリティ専門家のレビュー依頼

### 6.4 .envファイル経由のセキュリティリスク

**リスク**: .envファイルを通じた環境変数インジェクション攻撃

**対策**:
- .envファイル読み込み時のenv_allowlistフィルタリング実装
- .envファイル経由の攻撃シナリオテストの実施
- セキュリティ監査ログの強化

## 7. タイムライン

| フェーズ | 期間 | 開始日 | 終了日 |
|---------|------|--------|--------|
| フェーズ1: データ構造の拡張 | 2日 | 2025-07-18 | 2025-07-19 |
| フェーズ2: 環境変数フィルタリング機能 | 3日 | 2025-07-22 | 2025-07-24 |
| フェーズ3: 検証機能の実装 | 2日 | 2025-07-25 | 2025-07-26 |
| フェーズ4: ログとエラー処理 | 1日 | 2025-07-29 | 2025-07-29 |
| フェーズ5: 設定検証と統合 | 2日 | 2025-07-30 | 2025-07-31 |
| テスト期間 | 3日 | 2025-08-01 | 2025-08-05 |
| バグ修正・調整期間 | 2日 | 2025-08-06 | 2025-08-07 |
| ドキュメント更新・最終レビュー | 1日 | 2025-08-08 | 2025-08-08 |

**合計期間**: 約3週間（2025-07-18 〜 2025-08-08）

## 8. 成功基準

1. セキュリティ要件の達成
   - 許可されていない環境変数が使用できないこと
   - システム環境変数と.envファイル変数の両方でフィルタリングが機能すること
   - 循環参照や不正な変数名が拒否されること
   - セキュリティテストシナリオをすべて通過すること

2. パフォーマンス要件の達成
   - 環境変数フィルタリング処理が10ms以下であること
   - 変数参照解決が5ms以下であること
   - 追加メモリオーバーヘッドが1MB以下であること

3. テスト網羅率
   - 単体テスト網羅率が90%以上
   - 全機能に対する統合テストが存在すること
   - エッジケースのテストが網羅されていること

4. ドキュメント完備
   - 設計ドキュメントの更新
   - 実装ドキュメントの作成
   - ユーザー向け設定ガイドの作成

## 10. 重要な実装変更点

### 10.1 .envファイルセキュリティ強化

従来の実装では.envファイルからの環境変数は無制限で取り込まれていましたが、セキュリティリスクを排除するため、以下の変更を実装します：

#### 10.1.1 実装する機能
- `filterEnvFileVariables`関数の新規実装
- .envファイル読み込み後のenv_allowlistフィルタリング
- セキュリティ監査ログの出力強化

#### 10.1.2 期待される効果
- LD_PRELOAD等の危険な環境変数の注入防止
- .envファイル経由の権限昇格攻撃の防止
- 統一されたセキュリティポリシーの適用

#### 10.1.3 実装上の注意点
- 既存の.envファイル機能との互換性確保
- パフォーマンスへの影響を最小限に抑制
- ユーザーに分かりやすいエラーメッセージの提供

## 11. 参考資料

- 詳細仕様書: 環境変数安全化機能の実装
- Go言語セキュアコーディングガイド
- OWASP環境変数セキュリティガイドライン
