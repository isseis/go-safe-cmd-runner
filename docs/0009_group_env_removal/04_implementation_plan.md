# 実装計画書: グループレベル環境変数設定削除

## 1. 概要

### 1.1 目的
本文書は、go-safe-cmd-runnerプロジェクトにおけるグループレベル環境変数設定（`CommandGroup.Env`）の完全削除について、具体的な実装手順とスケジュールを定義する。

### 1.2 実装範囲
- データ構造の変更（`CommandGroup`構造体）
- 環境変数処理ロジックの簡素化
- 関連テストケースの更新
- サンプル設定ファイルの更新
- ドキュメントの更新

### 1.3 実装方針
- **段階的実装**: リスクを最小化するため3つのフェーズに分けて実装
- **既存機能保護**: `EnvAllowlist`、変数参照解決等の機能は維持
- **後方互換性**: 開発中機能のため breaking change として扱う

## 2. 実装前の現状確認

### 2.1 現在の実装状況（2025年7月19日時点）
```
実装状況: 未完了
├── データ構造変更: 未着手
│   ├── CommandGroup.Envフィールド (残存)
│   └── TOMLパース機能 (残存)
├── 処理ロジック変更: 未着手
│   ├── ResolveGroupEnvironmentVars (group.Env処理が残存)
│   └── resolveEnvironmentVars (更新要)
└── テスト・検証: 未着手
    ├── グループ環境変数テスト (残存)
    └── 統合テスト (未対応)
```

### 2.2 前提条件の確認
- [x] 関連する簡素化作業が完了済み（環境変数フィルタリング等）
- [x] 開発環境が整備済み
- [ ] 実装対象ファイルの現状把握完了
- [ ] テストケース影響範囲の特定完了

## 3. フェーズ別実装計画

### 3.1 Phase 1: データ構造変更（期間: 1-2日）

#### 3.1.1 実装タスク

**Task 1.1: CommandGroup構造体の変更**
```
ファイル: internal/runner/runnertypes/config.go
作業内容:
├── CommandGroup.Envフィールドの削除 (Line 38)
├── TOMLタグの削除確認
└── 関連コメントの更新

期待時間: 30分
担当者: [実装者]
```

**Task 1.2: コンパイルエラーの修正**
```
作業内容:
├── go build による全体ビルドテスト
├── エラー箇所の特定と修正
└── 依存関係の整合性確認

期待時間: 1-2時間
担当者: [実装者]
```

**Task 1.3: 静的解析とレビュー**
```
作業内容:
├── go vet による静的解析
├── golint による品質チェック
└── コードレビューの実施

期待時間: 1時間
担当者: [実装者・レビュアー]
```

#### 3.1.2 Phase 1 完了基準
- [ ] `CommandGroup`構造体から`Env`フィールドが削除されている
- [ ] プロジェクト全体がエラーなくビルドできる
- [ ] 静的解析でエラーが検出されない
- [ ] コードレビューが完了している

### 3.2 Phase 2: 処理ロジック変更（期間: 2-3日）

#### 3.2.1 実装タスク

**Task 2.1: ResolveGroupEnvironmentVars関数の簡素化**
```
ファイル: internal/runner/environment/filter.go
作業内容:
├── group.Env処理ブロックの削除 (Line 172-199)
├── 関数コメントの更新
├── ログ出力の調整
└── エラーハンドリングの簡素化

期待時間: 2-3時間
担当者: [実装者]
```

**Task 2.2: 関連する処理関数の確認**
```
ファイル: internal/runner/runner.go
作業内容:
├── resolveEnvironmentVars関数の動作確認
├── FilterSystemEnvironment呼び出し箇所の確認
├── 環境変数マージロジックの検証
└── エラーメッセージの統一

期待時間: 1-2時間
担当者: [実装者]
```

**Task 2.3: ログ出力の調整**
```
作業内容:
├── 削除されるログメッセージの特定
├── 残存ログレベルの確認
├── デバッグ情報の適切性検証
└── ログ出力テスト

期待時間: 1時間
担当者: [実装者]
```

#### 3.2.2 Phase 2 完了基準
- [ ] `ResolveGroupEnvironmentVars`関数から`group.Env`処理が削除されている
- [ ] 環境変数処理フローが3段階（システム→.env→コマンド）に簡素化されている
- [ ] 既存機能（`EnvAllowlist`、変数参照解決）が正常動作している
- [ ] ログ出力が適切に調整されている

### 3.3 Phase 3: テスト・検証（期間: 2-3日）

#### 3.3.1 実装タスク

**Task 3.1: 関連テストケースの更新**
```
対象ファイル:
├── internal/runner/environment/filter_test.go
├── internal/runner/runner_test.go
└── 統合テストファイル群

作業内容:
├── グループ環境変数関連テストの削除・更新
├── 新しい処理フローのテスト追加
├── エッジケーステストの確認
└── テストカバレッジの測定

期待時間: 4-6時間
担当者: [実装者]
```

**Task 3.2: 統合テストの実行**
```
作業内容:
├── 全ユニットテストの実行・確認
├── 統合テストの実行・確認
├── パフォーマンステストの実行
└── レグレッションテストの実行

期待時間: 2-3時間
担当者: [実装者・QA担当者]
```

**Task 3.3: サンプル設定ファイルの更新**
```
対象ファイル:
├── sample/config.toml
├── sample/test.toml
└── ドキュメント内のサンプル

作業内容:
├── グループ環境変数使用箇所の特定
├── コマンドレベルへの統合
├── EnvAllowlist設定の確認
└── 動作確認テスト

期待時間: 1-2時間
担当者: [実装者]
```

**Task 3.4: ドキュメントの更新**
```
対象ファイル:
├── README.md
├── 設定ファイル仕様書
└── 移行ガイド

作業内容:
├── 環境変数設定方法の更新
├── 設定例の更新
├── 移行ガイドの作成
└── アーキテクチャ図の更新

期待時間: 2-3時間
担当者: [実装者・技術文書担当者]
```

#### 3.3.2 Phase 3 完了基準
- [ ] 全ユニットテストが pass（カバレッジ90%以上）
- [ ] 統合テストが pass
- [ ] パフォーマンステストで性能劣化がない
- [ ] サンプル設定ファイルが更新されている
- [ ] ドキュメントが更新されている

## 4. リスク管理計画

### 4.1 技術リスク

| リスク項目 | 影響度 | 発生確率 | 対策 |
|-----------|---------|----------|------|
| 既存機能への予期しない影響 | 高 | 低 | 段階的実装・十分なテスト |
| テストケース不備による品質低下 | 中 | 中 | テストカバレッジの徹底確認 |
| パフォーマンスの予期しない劣化 | 低 | 低 | ベンチマークテストの実行 |

### 4.2 スケジュールリスク

| リスク項目 | 影響度 | 発生確率 | 対策 |
|-----------|---------|----------|------|
| Phase 1での予期しないコンパイルエラー | 中 | 中 | 事前の依存関係調査 |
| テストケース更新の工数増加 | 中 | 中 | バッファ時間の確保 |
| レビュー・承認プロセスの遅延 | 低 | 低 | 早期のレビュー依頼 |

### 4.3 運用リスク

| リスク項目 | 影響度 | 発生確率 | 対策 |
|-----------|---------|----------|------|
| 設定ファイル移行時の混乱 | 低 | 低 | 明確な移行ガイド提供 |
| 開発者への学習コスト | 低 | 中 | ドキュメント整備・説明会 |

## 5. 品質保証計画

### 5.1 テスト戦略

**5.1.1 単体テスト**
- カバレッジ目標: 90%以上
- 重点テスト箇所: 環境変数処理ロジック
- テストケース種類: 正常系・異常系・境界値

**5.1.2 統合テスト**
- 実行対象: 全モジュール間の連携
- 重点確認事項: 既存機能の動作維持
- テスト環境: 本番相当環境

**5.1.3 パフォーマンステスト**
- 測定対象: 環境変数解決処理時間
- 比較基準: 変更前の処理時間
- 許容範囲: ±5%以内

### 5.2 コードレビュー基準

**5.2.1 必須チェック項目**
- [ ] 設計書との整合性確認
- [ ] コーディング規約準拠
- [ ] エラーハンドリングの適切性
- [ ] ログ出力の適切性
- [ ] テストケースの十分性

**5.2.2 レビュー体制**
- 実装者: [実装担当者]
- 第一レビュアー: [技術リーダー]
- 第二レビュアー: [アーキテクト]
- 最終承認者: [プロジェクト責任者]

## 6. デプロイ計画

### 6.1 デプロイ戦略

**6.1.1 段階的デプロイ**
```
Phase 1: 開発環境
├── 機能テスト
├── 統合テスト
└── 品質確認

Phase 2: ステージング環境
├── 本番相当テスト
├── パフォーマンステスト
└── 運用テスト

Phase 3: 本番環境
├── カナリアリリース
├── 段階的ロールアウト
└── 全面展開
```

**6.1.2 ロールバック計画**
- 自動ロールバック条件: エラー率5%以上
- 手動ロールバック判断: パフォーマンス劣化10%以上
- ロールバック時間: 5分以内

### 6.2 監視・アラート

**6.2.1 監視項目**
- アプリケーション起動成功率
- 環境変数処理エラー率
- 処理時間パフォーマンス
- メモリ使用量

**6.2.2 アラート条件**
- エラー率: 1%以上で Warning、5%以上で Critical
- 応答時間: 平均比150%以上で Warning、200%以上で Critical
- メモリ使用量: 平均比120%以上で Warning

## 7. 成功基準・KPI

### 7.1 機能面の成功基準
- [ ] `CommandGroup.Env`フィールドが完全に削除されている
- [ ] 環境変数処理が3段階に簡素化されている
- [ ] 全ての既存機能が正常動作している
- [ ] 設定ファイルの構造が簡素化されている

### 7.2 品質面の成功基準
- [ ] テストカバレッジ90%以上を維持
- [ ] 全テストケースがpass
- [ ] 静的解析でエラー・警告なし
- [ ] コードレビューが完了

### 7.3 運用面の成功基準
- [ ] デプロイが成功している
- [ ] 本番環境で正常動作している
- [ ] パフォーマンス劣化なし（±5%以内）
- [ ] 運用監視が正常動作している

### 7.4 定量的KPI
| 項目 | 現在値 | 目標値 | 測定方法 |
|------|---------|---------|----------|
| 環境変数設定箇所 | 4箇所 | 3箇所 | コード解析 |
| 設定複雑性 | 高 | 中 | 設定ファイル行数 |
| 処理性能 | 基準値 | ±5%以内 | ベンチマークテスト |
| テストカバレッジ | 85% | 90%+ | テストツール測定 |

## 8. コミュニケーション計画

### 8.1 ステークホルダー

| 役割 | 担当者 | 責任範囲 |
|------|---------|----------|
| プロジェクト責任者 | [責任者名] | 全体方針・最終承認 |
| 技術リーダー | [リーダー名] | 技術方針・実装指導 |
| 実装担当者 | [実装者名] | 実装・単体テスト |
| QA担当者 | [QA担当者名] | 品質保証・テスト |
| 運用担当者 | [運用担当者名] | デプロイ・監視 |

### 8.2 報告・連絡体制

**8.2.1 定期報告**
- 日次進捗報告: 実装担当者 → 技術リーダー
- 週次ステータス報告: 技術リーダー → プロジェクト責任者
- Phase完了報告: プロジェクト責任者 → 全ステークホルダー

**8.2.2 課題・リスク報告**
- 課題発生時: 即座に技術リーダーに報告
- 重大課題: 2時間以内にプロジェクト責任者に報告
- 週次リスクレビュー: 毎週金曜日に実施

### 8.3 ドキュメント管理

**8.3.1 進捗管理**
- 実装進捗: GitHub Issues/Project Board
- 技術仕様: Git repository内のMarkdownファイル
- 会議録: チームWiki/Confluence

**8.3.2 成果物管理**
- ソースコード: Git repository
- テスト結果: CI/CDパイプライン
- ドキュメント: Git repository (docs/)

## 9. スケジュール

### 9.1 全体スケジュール

```
2025年7月
├── Week 3 (7/19-7/25)
│   ├── Phase 1: データ構造変更 (7/19-7/21)
│   └── Phase 2: 処理ロジック変更開始 (7/22-7/25)
├── Week 4 (7/26-8/1)
│   ├── Phase 2: 処理ロジック変更完了 (7/26-7/28)
│   └── Phase 3: テスト・検証開始 (7/29-8/1)
└── Week 5 (8/2-8/8)
    ├── Phase 3: テスト・検証完了 (8/2-8/5)
    └── リリース準備・デプロイ (8/6-8/8)
```

### 9.2 詳細マイルストーン

| 日付 | マイルストーン | 成果物 | 責任者 |
|------|----------------|---------|---------|
| 7/21 | Phase 1完了 | データ構造変更完了 | [実装者] |
| 7/28 | Phase 2完了 | 処理ロジック変更完了 | [実装者] |
| 8/5 | Phase 3完了 | テスト・検証完了 | [実装者・QA] |
| 8/8 | リリース完了 | 本番デプロイ完了 | [運用担当者] |

### 9.3 クリティカルパス

```
データ構造変更 → 処理ロジック変更 → テスト更新 → 統合テスト → デプロイ
```

**注意**: Phase 1の完了なしにPhase 2は開始できない。テストケース更新の完了なしに統合テストは実行できない。

## 10. 予算・リソース

### 10.1 人的リソース

| 役割 | 工数（人日） | 期間 | コスト |
|------|-------------|------|---------|
| 実装担当者 | 5人日 | 2週間 | [コスト計算] |
| 技術リーダー | 2人日 | 2週間 | [コスト計算] |
| QA担当者 | 1人日 | 1週間 | [コスト計算] |
| **合計** | **8人日** | **2週間** | **[総コスト]** |

### 10.2 技術リソース

| リソース | 用途 | コスト |
|----------|------|---------|
| 開発環境 | 実装・テスト | 既存環境利用 |
| ステージング環境 | 統合テスト | 既存環境利用 |
| CI/CDパイプライン | 自動テスト・デプロイ | 既存環境利用 |
| 監視ツール | 運用監視 | 既存環境利用 |

## 11. 承認

### 11.1 計画承認

| 項目 | 承認者 | 承認日 | ステータス |
|------|---------|---------|-----------|
| 実装計画 | [プロジェクト責任者] | [承認日] | [承認待ち] |
| 技術仕様 | [技術リーダー] | [承認日] | [承認待ち] |
| 品質計画 | [QA責任者] | [承認日] | [承認待ち] |
| リソース計画 | [リソース管理者] | [承認日] | [承認待ち] |

### 11.2 実装開始条件

- [ ] 本実装計画書が承認されている
- [ ] 必要なリソースが確保されている
- [ ] 開発環境が準備されている
- [ ] ステークホルダーへの説明が完了している

### 11.3 最終承認

**計画策定者**: [実装担当者]
**計画承認者**: [プロジェクト責任者]
**策定日**: 2025年7月19日
**承認日**: [承認日]
**バージョン**: 1.0

---

**注意事項**:
- 本計画書は要件定義書、アーキテクチャ設計書、詳細設計書に基づいて作成されている
- 実装開始前に必ず最新のコード状況を確認し、必要に応じて計画を更新する
- リスク発生時は速やかにエスカレーションし、計画の見直しを行う
