# 要件定義書: グループレベル環境変数設定削除

## 1. プロジェクト概要

### 1.1 背景
現在のgo-safe-cmd-runnerでは、環境変数の設定において以下の複雑性とセキュリティリスクが存在する：

1. **設定複雑性**: 4箇所での環境変数設定（システム環境変数、.envファイル、グループ設定、コマンド固有設定）により、設定の優先順位が複雑化している
2. **デバッグ困難性**: どの設定が最終的に適用されるかの追跡が困難で、問題発生時の原因特定に時間を要する
3. **設定ミスリスク**: 複数箇所での重複設定によるヒューマンエラーの発生可能性が高い
4. **学習コスト**: 新規開発者にとって環境変数の処理フローの理解が困難

### 1.2 目的
- グループレベルの環境変数設定（`CommandGroup.Env`）を完全削除し、設定箇所を3箇所に削減する
- 環境変数の優先順位を明確化し、デバッグ性を向上させる
- 設定システムの保守性を向上させ、将来の機能追加を容易にする
- シンプルで理解しやすい設定体系を実現する

## 2. 機能要件

### 2.1 グループレベル環境変数設定の完全削除
- [ ] `CommandGroup`構造体から`Env`フィールド（`[]string`型）を削除
- [ ] グループレベルでの環境変数設定に関するTOMLパース機能を削除
- [ ] グループレベル環境変数の処理ロジックを`resolveEnvironmentVars`関数から削除
- [ ] グループレベル環境変数に関連するテストケースを削除

### 2.2 環境変数優先順位の簡略化
削除後の環境変数適用優先順位を以下のように変更：
1. **コマンド固有の環境変数** (`commands[].env`) - 最高優先度
2. **.envファイルの環境変数** - 中間優先度
3. **システム環境変数** - 最低優先度

### 2.3 環境変数解決処理の単純化
- [ ] `resolveEnvironmentVars`関数からグループ環境変数処理を削除
- [ ] `ResolveGroupEnvironmentVars`関数からグループ`Env`フィールド処理を削除（`EnvAllowlist`処理は維持）
- [ ] 環境変数マージロジックの簡略化
- [ ] エラーハンドリングの簡素化

### 2.4 設定ファイル形式の変更
削除前（削除対象）：
```toml
[[groups]]
name = "build"
env = ["NODE_ENV=production", "BUILD_ID=${CI_BUILD_ID}"]  # 削除対象
env_allowlist = ["NODE_ENV", "BUILD_ID", "CI_BUILD_ID"]

[[groups.commands]]
name = "webpack"
cmd = "npm"
args = ["run", "build"]
env = ["WEBPACK_ENV=production"]
```

削除後：
```toml
[[groups]]
name = "build"
env_allowlist = ["NODE_ENV", "BUILD_ID", "CI_BUILD_ID"]  # 維持

[[groups.commands]]
name = "webpack"
cmd = "npm"
args = ["run", "build"]
env = ["NODE_ENV=production", "BUILD_ID=${CI_BUILD_ID}", "WEBPACK_ENV=production"]  # 統合
```

### 2.5 将来の拡張予定

#### 2.5.1 代替機能の実装（将来予定）
以下の機能は本要件の開発範囲外とし、将来の拡張として予定する：

- **テンプレート変数での環境変数サポート強化**
  ```toml
  [templates.build_vars]
  variables = ["NODE_ENV=production", "BUILD_ID=${CI_BUILD_ID}"]

  [[groups]]
  name = "build"
  template = "build_vars"
  ```

- **グループ専用.envファイルサポート**
  ```toml
  [[groups]]
  name = "build"
  env_file = "configs/build.env"
  ```

- **環境別設定ファイル管理機能**
  - `config-dev.toml`、`config-prod.toml`等の自動切り替え
  - 設定ファイル間の継承機能

#### 2.5.2 設定検証・移行支援機能（将来予定）
- **設定ファイル検証ツール**: グループ環境変数使用の検出と警告
- **自動移行ツール**: 既存設定の自動変換機能
- **設定ベストプラクティスガイド**: 推奨設定パターンの文書化

## 3. 非機能要件

### 3.1 保守性
- 環境変数処理ロジックの単純化により、コードの理解・保守を容易にする
- 設定ファイルの構造を簡素化し、設定ミスのリスクを削減する
- 一貫性のある環境変数処理フローの実現

### 3.2 パフォーマンス
- 環境変数解決処理の簡略化により、わずかなパフォーマンス向上を実現
- メモリ使用量の削減（グループ環境変数保存領域の削除）

### 3.3 可読性
- 設定ファイルの理解しやすさを向上
- 環境変数の適用順序の明確化
- エラーメッセージの簡素化

## 4. 制約事項

### 4.1 技術的制約
- 開発中機能のため後方互換性は考慮しない（breaking change として扱う）
- 既存の変数参照解決機能（`${VAR}`）は維持する
- `EnvAllowlist`機能は維持する（セキュリティ機能として重要）
- TOMLライブラリ（pelletier/go-toml/v2）の仕様に準拠
- 既存のファイル権限検証機能は維持する

### 4.2 運用制約
- 既存のグループ環境変数設定を使用している設定ファイルは、コマンドレベルに移行が必要
- 一般ユーザーへの影響なし（開発中機能のため）

### 4.3 移行制約
- 既存の設定ファイルでグループ環境変数を使用している場合、手動での移行が必要
- 移行支援ツールは本要件の範囲外（将来実装予定）

## 5. 成功基準

### 5.1 完了基準
- Phase 1: コード構造変更
  - [ ] `CommandGroup`構造体から`Env`フィールドを削除
  - [ ] TOMLパース機能からグループ環境変数処理を削除
  - [ ] 関連する型定義・定数の削除
- Phase 2: 処理ロジック変更
  - [ ] `resolveEnvironmentVars`関数からグループ環境変数処理を削除
  - [ ] `ResolveGroupEnvironmentVars`関数の簡略化
  - [ ] 環境変数マージロジックの更新
  - [ ] エラーハンドリングの簡素化
- Phase 3: テスト・検証
  - [ ] グループ環境変数関連テストケースの削除
  - [ ] 新しい処理フローのテストケース追加
  - [ ] 統合テストの実行
  - [ ] サンプル設定ファイルの更新

### 5.2 品質基準
- すべてのユニットテストが pass
- 新しい処理フローのテストカバレッジが 90% 以上
- 既存機能（`EnvAllowlist`、変数参照等）の動作確認
- パフォーマンステストによる性能確認

## 6. リスク分析

### 6.1 高リスク
- **既存設定ファイルの動作不良**: グループ環境変数を使用している設定ファイルが動作しなくなるリスク
  - 対策: 開発中機能のため外部ユーザーへの影響なし、内部設定ファイルは手動で移行

### 6.2 中リスク
- **機能削除による柔軟性の低下**: グループレベルでの環境変数制御ができなくなる
  - 対策: 将来の代替機能実装を計画、コマンドレベル設定での対応を推奨
- **設定の冗長化**: グループ内の複数コマンドで同じ環境変数を重複設定する必要
  - 対策: 将来のテンプレート機能で解決予定

### 6.3 低リスク
- **開発者の混乱**: 既存のグループ環境変数設定に慣れた開発者の混乱
  - 対策: 明確な移行ガイドとサンプル設定ファイルの提供

## 7. 依存関係

### 7.1 技術的依存
- pelletier/go-toml/v2 ライブラリ（TOMLパース）
- 既存の runner パッケージ（コマンド実行）
- 既存の environment パッケージ（環境変数フィルタリング）
- Go標準ライブラリ（os, strings パッケージ）

### 7.2 機能的依存
- `EnvAllowlist`機能の維持（セキュリティ要件）
- 変数参照解決機能の維持（`${VAR}`形式）
- .envファイル読み込み機能の維持

## 8. 実装計画

### 8.1 Phase 1: コード構造変更（期間: 1-2日）
1. `runnertypes/config.go`の`CommandGroup`構造体から`Env`フィールド削除
2. TOMLパース機能からグループ環境変数処理を削除
3. 関連する型定義・定数の整理
4. コンパイルエラーの修正

### 8.2 Phase 2: 処理ロジック変更（期間: 2-3日）
1. `runner.go`の`resolveEnvironmentVars`関数を簡略化
2. `environment/filter.go`の`ResolveGroupEnvironmentVars`関数を更新
3. 環境変数マージロジックの簡素化
4. エラーハンドリングとログ出力の更新

### 8.3 Phase 3: テスト・検証（期間: 1-2日）
1. グループ環境変数関連テストケースの削除・更新
2. 新しい処理フローのテストケース追加
3. 統合テストの実行
4. サンプル設定ファイルとドキュメントの更新

## 9. 承認

本要件定義書の実装状況：

1. **グループレベル環境変数設定削除**: **実装中**
   - Phase 1 (コード構造変更): **未着手**（`CommandGroup.Env`フィールドが残存）
   - Phase 2 (処理ロジック変更): **未着手**（`ResolveGroupEnvironmentVars`で`group.Env`処理が残存）
   - Phase 3 (テスト・検証): **未着手**
2. **関連する簡素化変更**: **完了**（2025年7月19日）
   - 環境変数フィルタリングロジックの簡素化
   - runnerインターフェースの簡素化
   - テンプレートシステムの簡素化
3. **将来拡張機能**: 要件定義のみ（実装対象外）

**実装状況詳細**:
- 現在のコードでは、まだ`internal/runner/runnertypes/config.go`の`CommandGroup`構造体に`Env`フィールドが残存
- `internal/runner/environment/filter.go`の`ResolveGroupEnvironmentVars`関数（172行目）で`group.Env`処理が残存
- 実装完了には上記コード変更が必要

承認者: [プロジェクト責任者]
承認日: [承認日]
