# 要件定義書: ファイル改ざん検出機能の実装

## 1. プロジェクト概要

### 1.1 背景
現在のgo-safe-cmd-runnerでは、ファイルの改ざん検出機能が設定ファイルのみにしか有効ではないため、次の問題がある。

1. go-safe-cmd-runner が呼び出す実行ファイルや、その実行ファイルが参照するファイルの改ざんを検出できない。

### 1.2 目的
- go-safe-cmd-runner が呼び出す実行ファイルや、その実行ファイルが参照するファイルの改ざんを検出する

## 2. 機能要件

### 2.1 実行ファイル改ざん検出機能の実装
- [ ] 設定ファイルの global 以下に、改ざん検出を行う対象ファイルを記述可能にする。
- [ ] 設定ファイルの groups 以下に、改ざん検出を行う対象ファイルを記述可能にする。
    - [ ] 複数の gorups で同じファイルを指定することを許可する。
    - [ ] 同じファイルを指定する際にはテンプレート機能を使い、容易に管理できるようにする。
- [ ] 設定ファイルの改ざん検出機能と異なり、改ざん検出を行う対象ファイルのパーミッションは検証不要。root 以外が書き込み可能でも構わない。
- [ ] global で指定されたファイルの改ざん検出機能を実装する。
    - [ ] この処理は、設定ファイルの改ざん検出処理の後に行う。設定ファイルの改ざんが検出された場合には、その時点で go-safe-cmd-runner を終了する。
    - [ ] ビルド時に指定したディレクトリ（rootユーザーのみ書き込み可能）から global で指定されたファイルのハッシュ値を読み込む
    - [ ] 起動時に global で指定されたファイルのハッシュ値を比較する
    - [ ] 起動時に global で指定されたファイルのハッシュ値が一致しない場合は、go-safe-cmd-runnerを終了する
    - [ ] 起動時に global で指定されたファイルのハッシュ値が一致する場合は、go-safe-cmd-runnerを起動する
- [ ] groups で指定されたファイルの改ざん検出機能を実装する。
    - [ ] この処理は各グループの処理を行う直前に実行する。
    - [ ] ビルド時に指定したディレクトリ（rootユーザーのみ書き込み可能）から groups で指定されたファイルのハッシュ値を読み込む
    - [ ] 起動時に groups で指定されたファイルのハッシュ値を比較する
    - [ ] 起動時に groups で指定されたファイルのハッシュ値が一致しない場合は、そのグループのコマンドは実行せず、次のグループの処理に移る。
    - [ ] 起動時に groups で指定されたファイルのハッシュ値が一致する場合は、そのグループのコマンドを実行する
- [ ] ハッシュファイル自体が改ざんされた場合の検出と対応
- [ ] ハッシュファイルの権限チェック（root以外書き込み不可の確認）
- [ ] 適切なエラーメッセージとログ出力の実装
- [ ] 設定による検証機能の有効/無効制御

### 2.2 将来の拡張
なし

## 3. 非機能要件

### 3.1 セキュリティ
- global で改ざん検出対象として指定されたファイル
    - 指定されたファイルのハッシュ値が存在しない場合には、go-safe-cmd-runnerを終了する
- groups で改ざん検出対象として指定されたファイル
    - 指定されたファイルのハッシュ値が存在しない場合には、そのグループのコマンドは実行せず、次のグループの処理に移る。
    - 実行されるコマンド (groups.cmmand.cmd) は、設定ファイルで検出対象と明示されていなくても検証対象とする。
    - 実行されるコマンド (groups.cmmand.cmd) は、設定ファイル中ではフルパスで記述されていない可能性がある。この場合にも改ざん検出を行えるようにする。
- コマンドパス解決の仕様
    - 相対パスのコマンド（例：`ls`）は PATH 環境変数を使用して絶対パスに解決する
    - パス解決には Go 標準の exec.LookPath() 関数相当の機能を使用
    - セキュリティ上、PATH の各ディレクトリも安全性を検証する（root書き込み可能ディレクトリのみ許可）
    - 解決されたフルパスに対してハッシュ検証を実行する
- ファイルの検証設定を攻撃者が無効化できないよう、検証機能の制御はコマンドライン引数と環境変数のみで行う
- **完全パス検証**: ハッシュディレクトリのルートから対象ディレクトリまでの全中間ディレクトリの権限を検証する
    - 中間ディレクトリが他ユーザーに書き込み可能な場合はエラーとする
    - 中間ディレクトリがグループ書き込み可能な場合、システムディレクトリ以外はエラーとする
- **シンボリックリンク攻撃対策**: `safefileio`パッケージの`openat2`システムコールと`RESOLVE_NO_SYMLINKS`フラグにより自動的に保護される
    - ハッシュファイル読み込み時にシンボリックリンクは解決されない

### 3.2 保守性
- 冗長性の除去によるコードの簡素化
- 一貫性のある設定体系

## 4. 制約事項

### 4.1 技術的制約
- 設定ファイルのハッシュ値を計算・保存するには build/record コマンドを利用する
- 設定ファイルのハッシュ値の検証には filevalidator パッケージを使用する
- ハッシュファイルの保存場所は /usr/local/etc/go-safe-cmd-runner/hashes/ 等の root のみ書き込み可能なディレクトリとする
    - ディレクトリはバイナリのビルド時に Makefile の DEFAULT_HASH_DIRECTORY マクロで指定し、ldflags で埋め込む
- ハッシュファイルの命名規則
    - filevalidator パッケージの命名規則を踏襲する (filevalidator.Record, filevalidator.Verify を使用するため、ハッシュファイル名について runner 側では気にする必要がない)
- 検証機能に関わらるコマンドライン引数、ハッシュディレクトリパス、環境変数、ハッシュアルゴリズム等は、設定ファイルの改竄検出機能の仕様を踏襲する。

### 4.2 運用制約
- 改ざん検出対象ファイル更新時は必ず事前にハッシュ値の再計算が必要
- ハッシュ値計算は root 権限で実行する必要がある
- 設定ファイルとハッシュファイルのバックアップ・復旧手順が必要
- ハッシュ更新フロー
    1. 新バイナリ配置
    2. record コマンド実行（root権限）
    3. 設定ファイル更新（該当する場合）
    4. go-safe-cmd-runner 再起動

## 5. 成功基準

### 5.1 完了基準
- Phase 1: 基盤機能
    - [ ] 設定ファイル拡張（global/groups の hash_files セクション）
    - [ ] ハッシュファイル読み込み機能
- Phase 2: 検証機能
    - [ ] global検証（起動時）
    - [ ] groups検証（グループ実行前）
    - [ ] エラーハンドリング（global失敗→終了、groups失敗→スキップ）
- Phase 3: 統合・テスト
    - [ ] コマンドパス解決機能
    - [ ] PATH環境変数を使用した相対パス→絶対パス変換
    - [ ] エラーハンドリング統合
    - [ ] 包括的テストスイート

### 5.2 将来の拡張完了基準
なし

## 6. リスク分析

### 6.1 高リスク
- **テストケースの失敗**: 事前の十分な調査により対応
- **後方互換性の損失**: 明確なコミュニケーションとエラーメッセージ、ドキュメント作成により対応

### 6.2 中リスク
- **文書化の不備**: 詳細な解説・運用ドキュメント作成により対応

### 6.3 低リスク
- **パフォーマンス影響**: filevalidator パッケージの使用により検証済み
- **第三者依存**: 外部依存の変更なし

## 7. 依存関係

### 7.1 技術的依存
- filevalidator パッケージ (internal/filevalidator)
- security パッケージ (internal/runner/security)
- build/record コマンド
- SHA-256 ハッシュアルゴリズム

### 7.2 ドキュメント依存
- 既存のアーキテクチャドキュメント

## 8. 承認

本要件定義書の実装状況：

1. **指定されたファイル改ざん検出機能**: 未着手
    - Phase 1 (基盤機能): 未着手
    - Phase 2 (検証機能): 未着手
    - Phase 3 (統合・テスト): 未着手
2. **将来の拡張**: 未着手

承認者: [プロジェクト責任者]
承認日: [承認日]
